# GitLab CI/CD конфигурация
# Использует те же проверки, что и pre-commit хуки

stages:
  - validate
  - test
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  RUST_VERSION: "1.89"
  PYTHON_VERSION: "3.14"
  NODE_VERSION: "24"

# Кеширование зависимостей
cache:
  paths:
    - frontend/node_modules/
    - backend/rust-api/target/
    - backend/python-generator/venv/

# === Валидация (идентична pre-commit) ===

lint:frontend:
  stage: validate
  image: node:${NODE_VERSION}
  script:
    - cd frontend
    - npm ci
    - npm run lint
    - npm run format:check
    - npm run type-check
  allow_failure: false

lint:rust:
  stage: validate
  image: rust:${RUST_VERSION}
  script:
    - cd backend/rust-api
    - cargo fmt --check
    - cargo clippy --all-targets --all-features -- -D warnings
  allow_failure: false

lint:python:
  stage: validate
  image: python:${PYTHON_VERSION}
  script:
    - cd backend/python-generator
    - pip install black ruff mypy
    - black --check src/ tests/
    - ruff check src/ tests/
    - mypy src/
  allow_failure: false

# Security audit
audit:frontend:
  stage: validate
  image: node:${NODE_VERSION}
  script:
    - cd frontend
    - npm ci
    - npm audit --audit-level=moderate
  allow_failure: false

audit:rust:
  stage: validate
  image: rust:${RUST_VERSION}
  before_script:
    - cargo install cargo-audit
  script:
    - cd backend/rust-api
    - cargo audit
  allow_failure: false

audit:python:
  stage: validate
  image: python:${PYTHON_VERSION}
  script:
    - cd backend/python-generator
    - pip install pip-audit
    - pip-audit
  allow_failure: false

# === Тестирование ===

test:frontend:
  stage: test
  image: node:${NODE_VERSION}
  script:
    - cd frontend
    - npm ci
    - npm run test:coverage
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: frontend/coverage/cobertura-coverage.xml

test:rust:
  stage: test
  image: rust:${RUST_VERSION}
  services:
    - name: mongo:6
      alias: mongodb
    - name: redis:7-alpine
      alias: redis
  variables:
    # CI test credentials - isolated environment only
    MONGODB_URI: "mongodb://${MONGO_USER:-ci_test_user}:${MONGO_PASSWORD:-ci_test_P@ssw0rd_2025}@mongodb:27017/test"
    REDIS_URL: "redis://:${REDIS_PASSWORD:-ci_redis_T3st_2025}@redis:6379"
  script:
    - cd backend/rust-api
    - cargo test --all-features
  artifacts:
    reports:
      junit: backend/rust-api/target/nextest/default/junit.xml

test:python:
  stage: test
  image: python:${PYTHON_VERSION}
  services:
    - name: mongo:6
      alias: mongodb
    - name: redis:7-alpine
      alias: redis
  variables:
    # CI test credentials - isolated environment only
    MONGODB_URI: "mongodb://${MONGO_USER:-ci_test_user}:${MONGO_PASSWORD:-ci_test_P@ssw0rd_2025}@mongodb:27017/test"
    REDIS_URL: "redis://:${REDIS_PASSWORD:-ci_redis_T3st_2025}@redis:6379"
  script:
    - cd backend/python-generator
    - pip install -e ".[dev]"
    - pytest --cov=src --cov-report=xml --cov-report=term
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: backend/python-generator/coverage.xml

# === Сборка ===

build:frontend:
  stage: build
  image: node:${NODE_VERSION}
  script:
    - cd frontend
    - npm ci
    - npm run build
  artifacts:
    paths:
      - frontend/dist/
    expire_in: 1 week
  only:
    - main
    - develop

build:rust:
  stage: build
  image: rust:${RUST_VERSION}
  script:
    - cd backend/rust-api
    - cargo build --release
  artifacts:
    paths:
      - backend/rust-api/target/release/rust-api
    expire_in: 1 week
  only:
    - main
    - develop

build:python:
  stage: build
  image: python:${PYTHON_VERSION}
  script:
    - cd backend/python-generator
    - pip install build
    - python -m build
  artifacts:
    paths:
      - backend/python-generator/dist/
    expire_in: 1 week
  only:
    - main
    - develop

# === Деплой ===

deploy:staging:
  stage: deploy
  script:
    - echo "Deploying to staging environment..."
    # Добавить скрипты деплоя на staging
  environment:
    name: staging
    url: https://staging.trainingground.ru
  only:
    - develop

deploy:production:
  stage: deploy
  script:
    - echo "Deploying to production environment..."
    # Добавить скрипты деплоя на production
  environment:
    name: production
    url: https://trainingground.ru
  when: manual
  only:
    - main

security:secrets-scan:
  stage: validate
  image: python:3.14
  script:
    - echo "Scanning repository for hardcoded default passwords..."
    - |
      set -e
      python - <<'PY'
  import re,sys,subprocess
  p = subprocess.run(['git','ls-files'], capture_output=True, text=True)
  files = p.stdout.splitlines()
  # Patterns to search for
  pattern = re.compile(r"\b(admin:password|admin:admin|redispass|testpass|testredispass|qdrantkey|your-secret-key-change-in-prod)\b", re.I)
  # Whitelist files or directories where defaults are acceptable (docs, infra scripts, test compose files)
  whitelist = re.compile(r"^(docs/|infra/|docker-compose.test.yml|\.env.example$)")
  failed=[]
  for f in files:
    if whitelist.search(f):
      continue
    if f.endswith(('.png','.jpg','.jpeg','.svg','.lock','.bin')): continue
    try:
      txt=open(f,encoding='utf-8').read()
    except Exception:
      continue
    if pattern.search(txt):
      failed.append(f)
  if failed:
    print('Found files with default credentials:')
    for x in failed: print(' -',x)
    sys.exit(2)
  print('No obvious default credentials found')
  PY
  allow_failure: false
  only:
    - branches
