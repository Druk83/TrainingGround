#!/bin/bash

set -euo pipefail

echo "[INFO] Running pre-commit checks for Python..."

PYTHON_DIR="backend/python-generator"

if [ ! -d "$PYTHON_DIR" ]; then
  echo "[WARN] $PYTHON_DIR not found, skipping Python checks"
  exit 0
fi

cd "$PYTHON_DIR"

BLACK_TARGETS="src tests"
ruff check $BLACK_TARGETS
black --check $BLACK_TARGETS

# mypy отключен для локальной разработки из-за медленной работы с ML библиотеками
# В CI/CD используется отдельная проверка
echo "[INFO] Skipping mypy (too slow with ML dependencies, use 'mypy src/explanation_service' manually if needed)"

if [ -d "tests" ]; then
  echo "[INFO] Running pytest..."
  pytest tests --tb=short || {
    echo "[WARN] pytest failed (possibly missing dev dependencies), continuing..."
  }
else
  echo "[WARN] tests/ directory not found, skipping pytest"
fi

echo "[INFO] Running pip-audit..."
pip-audit || {
  echo "[WARN] pip-audit failed or not installed, continuing..."
}

echo "[SUCCESS] Python pre-commit checks completed!"
