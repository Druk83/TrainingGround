#!/bin/bash
set -e

echo "================================"
echo "Pre-commit validation started"
echo "================================"

# SD-07: Security check - prevent committing MongoDB keyfiles
echo "[INFO] Checking for sensitive files..."
STAGED_KEYFILES=$(git diff --cached --name-only | grep -E "(mongo-keyfile|mongo-keyfile\.secure|mongodb-keyfile)" | grep -v "\.example" || true)
if [ -n "$STAGED_KEYFILES" ]; then
    echo "[ERROR] Attempting to commit MongoDB keyfile! This is a CRITICAL SECURITY ISSUE!"
    echo "The following files must NOT be committed:"
    echo "$STAGED_KEYFILES"
    echo ""
    echo "These files should be in .gitignore. Run:"
    echo "  git reset HEAD $STAGED_KEYFILES"
    exit 1
fi

# Определить измененные компоненты
CHANGED_FILES=$(git diff --cached --name-only)

RUN_FRONTEND=false
RUN_RUST=false
RUN_PYTHON=false

if echo "$CHANGED_FILES" | grep -q "^frontend/"; then
  RUN_FRONTEND=true
fi

if echo "$CHANGED_FILES" | grep -q "^backend/rust-api/"; then
  RUN_RUST=true
fi

if echo "$CHANGED_FILES" | grep -q "^backend/python-generator/"; then
  RUN_PYTHON=true
fi

# Запуск проверок для измененных компонентов
if [ "$RUN_FRONTEND" = true ]; then
  .githooks/pre-commit-frontend || exit 1
fi

if [ "$RUN_RUST" = true ]; then
  .githooks/pre-commit-rust || exit 1
fi

if [ "$RUN_PYTHON" = true ]; then
  .githooks/pre-commit-python || exit 1
fi

# Если изменений нет или они только в документации
if [ "$RUN_FRONTEND" = false ] && [ "$RUN_RUST" = false ] && [ "$RUN_PYTHON" = false ]; then
  echo "[INFO] No code changes detected, skipping checks"
fi

echo "================================"
echo "All pre-commit checks passed!"
echo "================================"
