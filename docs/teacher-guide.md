# Руководство для куратора

Документ описывает, как куратор (teacher) работает в веб‑приложении TrainingGround: отслеживает группы, анализирует прогресс, отправляет уведомления и формирует отчёты. Руководство дополняет файлы `student-guide.md` и `admin-guide.md`.

## Требования к доступу

- Учётная запись с ролью `teacher` (или `admin` для полного доступа).
- Пользователь добавлен хотя бы в одну группу — дашборд показывает только «свои» группы.
- Современный браузер с включённым JavaScript. Для скачивания отчётов нужно разрешить всплывающие окна/загрузки с домена TrainingGround.

## Навигация

После входа система перенаправляет учителя на `/teacher-dashboard`. В шапке доступны ссылки:

- **Дашборд** (`/teacher-dashboard`) — сводные метрики, аналитика, экспорт.
- **Ученики** (`/teacher/students`) — таблица учеников выбранной группы.
- **Уведомления** (`/teacher/notifications`) — шаблоны, массовая рассылка, история.
- **Профиль / Выход** — через выпадающий список аватара.

Если переключиться на другую роль (admin/content_admin), учительские разделы скрываются.

## Дашборд (`/teacher-dashboard`)

1. **Выбор группы** — комбо‑бокс с группами куратора, выбранная группа попадает в URL (`?groupId`).
2. **Сводные карточки** — средняя точность, средний балл, количество попыток и учеников.
3. **Аналитика**:
   - Таблица тем (лучшая/худшая точность).
   - График активности (ежедневные попытки и % правильных).
   - Рекомендации (темы с просадкой).
4. **Лидерборд** — топ учеников по баллам.
5. **Экспорт**:
   - Выбор периода (последний день/неделя/месяц).
   - Формат CSV/PDF/XLSX и необязательный список topic ID.
   - Кнопка «Запросить экспорт» вызывает `/stats/groups/{id}/export`.
   - UI опрашивает `/stats/exports/{id}`, пока отчёт не готов; затем отображается подписанная ссылка (живёт `REPORTING_SIGNED_URL_TTL_HOURS`).

Если worker приостановлен, статус остаётся «processing». Лимит на запросы — 5 в час (значение из `REPORTING_EXPORT_RATE_LIMIT_PER_HOUR`).

## Ученики (`/teacher/students`)

- Выберите группу, используйте поиск по имени/почте, сортируйте столбцы.
- Карточки сверху показывают количество учеников, средние показатели.
- Ссылка «Открыть» ведёт на `/teacher/students/{studentId}` с подробностями:
  - Профиль (email, последний прогресс, суммарные числа).
  - Таблица по уровням: попытки, баллы, дата обновления.

Все эндпоинты проверяют `guard_group_access`, поэтому куратор не увидит чужие группы.

## Уведомления (`/teacher/notifications`)

- **Отправка** — выберите группу + шаблон и нажмите «Отправить». Письмо уходит всем ученикам группы.
- **Шаблоны** — список существующих + форма добавления нового шаблона. Поддерживаемые переменные:
  - `{student_name}` — полное имя ученика.
  - `{group_name}` — название группы.
- **История** — таблица с датой, названием шаблона, темой, числом получателей и статусом (`sent` или `skipped`, если SMTP отключён).

При `EMAIL_SEND_DISABLED=1` интерфейс выводит предупреждение, но запись в истории всё равно создаётся.

## Частые проблемы

| Симптом | Что проверить |
| --- | --- |
| «Access denied» на дашборде | Убедитесь, что пользователь имеет роль `teacher` и группа указана в `users.group_ids`. |
| Экспорт завис в «processing» | Посмотрите логи worker. Просроченные экспорты автоматически помечаются `failed`; можно повторить запрос. |
| Письма не доходят | Проверьте настройки SMTP в системных настройках и то, что `EMAIL_SEND_DISABLED` не выставлен. История уведомлений покажет, отправлялись ли письма. |
| В списке группы пусто | Убедитесь, что в группе есть студенты (`role: student`) и куратор закреплён за этой группой. |

## Связанные документы

- `docs/student-guide.md` — сценарии для учеников.
- `docs/admin-guide.md` — действия администратора.
- `docs/reporting.md` — технические детали аналитики и экспорта.
- `docs/rbac.md` — описание ролей и прав.

Не забудьте отмечать выполненные пункты в `tasks/A6-03.md`, чтобы статус задачи оставался актуальным.
