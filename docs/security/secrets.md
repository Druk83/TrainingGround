# Управление секретами и их ротация

## Где хранить секреты для локальной разработки
- Используйте файл `.env` в корне репозитория для локальных секретов (Mongo, Redis, Qdrant, JWT, пароль администратора Grafana).
- **Никогда не коммитьте** файл `.env` в git (он уже добавлен в `.gitignore`).

## Рекомендуемые переменные
- MONGO_USER / MONGO_PASSWORD
- REDIS_PASSWORD
- QDRANT_API_KEY
- JWT_SECRET
- GRAFANA_PASSWORD
- Любые внешние API-ключи (например, YANDEXGPT)

## Как менять и ротировать секреты
1. Отредактируйте локальный `.env` (или используйте `export` для временных изменений в сессии).
2. Для ротации JWT можно использовать вспомогательный скрипт:
   ```bash
   bash infra/scripts/rotate_jwt_secret.sh <new_secret>
   ```
   Скрипт обновит значение `JWT_SECRET` в `.env` и выполнит перезапуск контейнеров (`docker-compose restart`).
3. После изменения паролей базы данных или Redis необходимо обновить соответствующие переменные окружения в Docker-compose и полностью перезапустить стек:
   ```bash
   docker-compose down
   docker-compose up -d
   ```

Перед запуском сервисов проверьте `.env` на наличие слабых или дефолтных значений:

**Linux/macOS/Git Bash:**
```bash
bash infra/scripts/check_env.sh
```

**Windows CMD:**
```cmd
infra\scripts\check_env.cmd
```

## Production (рекомендации)
- Для продакшна используйте специализированное хранилище секретов (HashiCorp Vault, облачный KMS и т.д.) и инжектируйте секреты в рантайм, а не храните их в `.env`.
- Для критичных секретов применяйте версионирование ключей и rolling restarts для поддержки zero-downtime при ротации.

## CI / pre-commit проверки
- В репозитории есть CI job `security:secrets-scan`, который сканирует код на распространённые дефолтные креды (например, `admin:password`, `redispass`, `qdrantkey`).
- При необходимости добавьте пользовательские паттерны, которые должны блокироваться в CI.

## Примечания
- Не храните долгоживущие секреты в клиентском (browser) коде — для фронтенда допустимы только публичные переменные `VITE_*`.
