# Документация Feature Flags

## Обзор

Система TrainingGround использует feature flags для динамической конфигурации и безопасного развёртывания новых функций. Этот документ описывает все доступные флаги, их назначение, зависимости и использование в системе.

## Оглавление

1. [Иерархия флагов](#иерархия-флагов)
2. [Доступные флаги](#доступные-флаги)
3. [Области действия и целевые аудитории](#области-действия-и-целевые-аудитории)
4. [Зависимости](#зависимости)
5. [Использование API](#использование-api)
6. [Лучшие практики](#лучшие-практики)

## Иерархия флагов

Feature flags поддерживают три уровня области действия:

### Глобальная область действия
- Применяется ко **всем** пользователям и группам
- Наиболее распространённая область для системных функций
- Пример: `anticheat_strict_mode`

### Область действия по группам
- Применяется только к конкретным группам
- Полезна для тестирования новых функций с определённым классом или когортой
- ID целевых объектов содержат идентификаторы групп
- Пример: Тестирование `scoring_bonus_v2` только с продвинутыми студентами

### Область действия по пользователям
- Применяется только к конкретным пользователям
- Полезна для целевого A/B тестирования
- ID целевых объектов содержат идентификаторы пользователей
- Пример: Ранний доступ к `sso_oauth2` для администраторов

**Порядок разрешения** (первое совпадение побеждает):
1. Флаг уровня пользователя (если предоставлен user_id и совпадает)
2. Флаг уровня группы (если предоставлен group_id и совпадает)
3. Глобальный флаг

## Доступные флаги

### 1. `hints_enabled`

**Описание:** Включение/отключение системы подсказок для студентов

**Область действия:** Глобальная (может быть переопределена для группы/пользователя)

**По умолчанию:** `true` (включен)

**Конфигурация:**
```json
{
  "max_hints_per_task": 3,
  "hint_penalty": 5
}
```

**Использование:**
- UI студента показывает/скрывает кнопку подсказки в зависимости от этого флага
- При отключении все эндпоинты, связанные с подсказками, возвращают 403 Forbidden
- Влияет на подсчёт баллов: количество использованных подсказок отслеживается по-другому

**Связанные компоненты:**
- Фронтенд: `src/components/Task/HintButton.tsx`
- Бэкенд: `handlers/sessions.rs` - эндпоинт `request_hint`

---

### 2. `explanation_api_enabled`

**Описание:** Включение/отключение доступа к API объяснений

**Область действия:** Глобальная (может быть переопределена для группы/пользователя)

**По умолчанию:** `true` (включен)

**Конфигурация:**
```json
{
  "max_requests_per_hour": 100
}
```

**Использование:**
- Контролирует доступность сервиса объяснений
- При отключении возвращает 503 Service Unavailable
- Применяется ограничение по количеству запросов на основе конфигурации

**Зависимости:**
- Флаг `hints_enabled` зависит от этого (без объяснений не может быть подсказок)
- Это основной флаг для всех функций, связанных с объяснениями

**Связанные компоненты:**
- Бэкенд: `services/explanation_api.rs`
- API: `POST /api/explanations`

---

### 3. `explanation_yandexgpt_enabled`

**Описание:** Включение/отключение YandexGPT для генерации объяснений

**Область действия:** Глобальная (может быть переопределена для группы/пользователя)

**По умолчанию:** `false` (отключен для контроля затрат)

**Конфигурация:**
```json
{
  "model": "yandexgpt-3",
  "temperature": 0.7,
  "max_tokens": 500
}
```

**Использование:**
- Контролирует интеграцию с API YandexGPT
- При отключении используются объяснения на основе шаблонов
- Требует, чтобы `explanation_api_enabled` был включен
- **Влияние на затраты:** Каждый запрос объяснения потребляет кредиты API

**Зависимости:**
- Требует: `explanation_api_enabled`

**Связанные компоненты:**
- Бэкенд: `services/explanation_builder.rs`
- Конфигурация: Переменные окружения для API ключа YandexGPT

---

### 4. `adaptive_templates_enabled`

**Описание:** Включение/отключение адаптивной генерации шаблонов

**Область действия:** Глобальная (может быть переопределена для группы/пользователя)

**По умолчанию:** `true` (включен)

**Конфигурация:**
```json
{
  "adaptation_level": "medium",
  "min_accuracy_threshold": 60
}
```

**Использование:**
- Контролирует режим адаптивности Python генератора шаблонов
- При включении шаблоны изменяют сложность в зависимости от успешности студента
- При отключении используются фиксированные шаблоны
- Влияет на производительность и релевантность генерации задач

**Связанные компоненты:**
- Python: `backend/python-generator/template_generator.py`
- Бэкенд: `services/template_service.rs`

---

### 5. `sso_oauth2`

**Описание:** Включение/отключение интеграции OAuth2 SSO (Яндекс, ВК, Госуслуги)

**Область действия:** Глобальная

**По умолчанию:** `false` (отключен для проверки безопасности)

**Конфигурация:**
```json
{
  "providers": ["yandex", "vk", "gosuslugi"],
  "fallback_to_email": true
}
```

**Использование:**
- Контролирует появление кнопок OAuth2 на странице входа
- При отключении доступна только аутентификация по email/пароль
- Требует проведения проверки безопасности перед включением в production
- **Примечание безопасности:** Может быть включен выборочно для определённых групп при тестировании

**Связанные компоненты:**
- Фронтенд: `src/components/Auth/LoginPage.tsx`
- Бэкенд: `services/auth_service.rs` - обработчики OAuth
- Конфигурация: Учётные данные OAuth в `.env`

---

### 6. `scoring_bonus_v2`

**Описание:** Включение/отключение нового алгоритма начисления бонусов v2

**Область действия:** Глобальная (может быть переопределена для группы/пользователя)

**По умолчанию:** `false` (отключен в ожидании тестирования)

**Конфигурация:**
```json
{
  "bonus_multiplier": 1.5,
  "min_accuracy": 85,
  "conditions": {
    "no_hints_used": true,
    "speed_bonus": true
  }
}
```

**Использование:**
- Переключает между алгоритмом v1 (текущий) и v2 (новый)
- v2 предоставляет более высокие бонусы за идеальную точность и скорость
- Может быть включен для определённой группы для бета-тестирования
- **Влияние:** Значительно влияет на рейтинг лидеров

**Связанные компоненты:**
- Бэкенд: `services/scoring_service.rs`
- Аналитика: `services/analytics_worker.rs`

---

### 7. `anticheat_strict_mode`

**Описание:** Включение/отключение строгого режима защиты от читинга

**Область действия:** Глобальная

**По умолчанию:** `true` (включен)

**Конфигурация:**
```json
{
  "tab_switch_threshold": 3,
  "rapid_submit_ms": 500,
  "impossible_time_threshold_ms": 1000,
  "pattern_abuse_window": 10
}
```

**Использование:**
- Контролирует чувствительность обнаружения подозрительного поведения
- Строгий режим может выявить больше ложных срабатываний
- При отключении логируются только критические нарушения
- Влияет на отчётность об инцидентах и блокирование пользователей

**Связанные компоненты:**
- Бэкенд: `services/anticheat_service.rs`
- Фронтенд: `src/services/antiCheat.ts`
- Мониторинг: Метрики Prometheus для инцидентов

---

### 8. `qdrant_fallback`

**Описание:** Включение/отключение fallback на Qdrant при сбое основного поиска

**Область действия:** Глобальная

**По умолчанию:** `true` (включен)

**Конфигурация:**
```json
{
  "timeout_ms": 5000,
  "fallback_score_threshold": 0.5,
  "enable_hybrid_search": true
}
```

**Использование:**
- Контролирует поведение fallback при поиске по эмбеддингам
- При отключении система немедленно завершается с ошибкой основного сервиса
- При включении пытается использовать поиск по векторам Qdrant
- Улучшает отказоустойчивость, но добавляет задержку

**Связанные компоненты:**
- Бэкенд: `services/search_service.rs`
- Конфигурация: Параметры подключения Qdrant

---

### 9. `leaderboard_enabled`

**Описание:** Включение/отключение функции рейтинга лидеров

**Область действия:** Глобальная (может быть переопределена для группы/пользователя)

**По умолчанию:** `true` (включен)

**Конфигурация:**
```json
{
  "update_frequency_minutes": 60,
  "top_n": 100,
  "include_private_groups": false
}
```

**Использование:**
- Контролирует видимость рейтинга лидеров и обновления
- При отключении эндпоинты рейтинга возвращают 404
- Обновления происходят с указанной частотой
- Может быть отключен для конкретного пользователя

**Связанные компоненты:**
- Фронтенд: `src/components/Leaderboard/`
- Бэкенд: `services/leaderboard_service.rs`
- Обработчик: `services/analytics_worker.rs`

---

### 10. `offline_sync_enabled`

**Описание:** Включение/отключение синхронизации в режиме оффлайн

**Область действия:** Глобальная

**По умолчанию:** `false` (отключен - ожидание реализации PWA)

**Конфигурация:**
```json
{
  "max_offline_queue_size": 1000,
  "sync_interval_seconds": 30,
  "compression": true
}
```

**Использование:**
- Контролирует возможность работы приложения в режиме оффлайн
- При включении приложение продолжает работать без сетевого соединения
- Синхронизирует изменения при восстановлении соединения
- Требует ServiceWorker и IndexedDB

**Связанные компоненты:**
- Фронтенд: `src/services/offline/SyncManager.ts`
- Фронтенд: `src/services/offline/OfflineStorage.ts`

---

## Области действия и целевые аудитории

### Пример глобальной области

```javascript
{
  "flag_key": "hints_enabled",
  "enabled": true,
  "scope": "global",
  "target_ids": [],
  "config": { "max_hints_per_task": 3 }
}
```

### Пример области действия для групп

```javascript
{
  "flag_key": "scoring_bonus_v2",
  "enabled": true,
  "scope": "group",
  "target_ids": ["group_123", "group_456"],  // ID классов
  "config": { "bonus_multiplier": 1.5 }
}
```

### Пример области действия для пользователей

```javascript
{
  "flag_key": "sso_oauth2",
  "enabled": true,
  "scope": "user",
  "target_ids": ["admin_user_id"],  // ID пользователей
  "config": { "providers": ["yandex"] }
}
```

## Зависимости

### Граф зависимостей

```
explanation_api_enabled (родитель)
  └── hints_enabled (требует explanation_api_enabled)
  └── explanation_yandexgpt_enabled (требует explanation_api_enabled)
```

### Правила валидации

При обновлении флагов система проверяет:

1. **Проверка зависимостей:** При включении `hints_enabled` проверяет, что `explanation_api_enabled` также включен
2. **Консистентность области:** Область действия для группы/пользователя требует непустого списка `target_ids`
3. **Схема конфигурации:** Объект конфигурации соответствует ожидаемой схеме для флага

Пример ошибки:
```json
{
  "error": "Флаг 'hints_enabled' требует, чтобы 'explanation_api_enabled' был включен"
}
```

## Использование API

### Получение активных флагов для пользователя

```bash
curl "http://localhost:3000/api/feature-flags?user_id=user_123&group_id=group_456"
```

Ответ:
```json
{
  "flags": [
    {
      "flag_key": "hints_enabled",
      "enabled": true,
      "config": { "max_hints_per_task": 3 }
    },
    {
      "flag_key": "anticheat_strict_mode",
      "enabled": true,
      "config": { "tab_switch_threshold": 3 }
    }
  ]
}
```

### Администратор: Список всех флагов

Требуется аутентификация администратора:

```bash
curl -H "Authorization: Bearer $JWT_TOKEN" \
  http://localhost:3000/admin/feature-flags
```

### Администратор: Получение конкретного флага

```bash
curl -H "Authorization: Bearer $JWT_TOKEN" \
  http://localhost:3000/admin/feature-flags/hints_enabled
```

### Администратор: Создание флага

```bash
curl -X POST \
  -H "Authorization: Bearer $JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "flag_key": "new_feature",
    "description": "Новая экспериментальная функция",
    "enabled": false,
    "scope": "global",
    "target_ids": [],
    "config": { "param1": "value1" },
    "change_reason": "Развёртывание новой функции"
  }' \
  http://localhost:3000/admin/feature-flags
```

### Администратор: Обновление флага

```bash
curl -X PUT \
  -H "Authorization: Bearer $JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "enabled": true,
    "config": { "param1": "value2" },
    "change_reason": "Включение для всех пользователей"
  }' \
  http://localhost:3000/admin/feature-flags/new_feature
```

### Администратор: Удаление флага

```bash
curl -X DELETE \
  -H "Authorization: Bearer $JWT_TOKEN" \
  http://localhost:3000/admin/feature-flags/new_feature
```

## Кэширование

### Redis кэш

Значения флагов кэшируются в Redis с TTL 60 секунд:

- Формат ключа кэша: `ff:{flag_key}:{scope_key}`
- Примеры:
  - `ff:hints_enabled:global`
  - `ff:scoring_bonus_v2:user:user_123`
  - `ff:scoring_bonus_v2:group:group_456`

### Инвалидация кэша

Кэш автоматически инвалидируется при:
1. Изменении значения флага (обновление/удаление)
2. Изменении области действия или target_ids
3. Ручной очистке кэша через эндпоинт администратора

### Graceful Degradation

Если Redis недоступен:
1. Сервис продолжает читать напрямую из MongoDB
2. Нет кэширования в памяти, небольшое увеличение задержки
3. Система остаётся полностью функциональной

## Лучшие практики

### 1. Соглашение об именовании

Используйте snake_case с описательными названиями:

```
✓ hints_enabled
✓ explanation_yandexgpt_enabled
✓ anticheat_strict_mode

✗ hints
✗ enable_yandexgpt
✗ strict_anticheat
```

### 2. Конфигурация

Держите конфигурацию минимальной и с консистентной схемой:

```json
// ✓ Хорошо
{
  "max_hints_per_task": 3,
  "hint_penalty": 5
}

// ✗ Избегайте сложных вложенных структур
{
  "hints": {
    "constraints": {
      "max": {
        "per_task": 3
      }
    }
  }
}
```

### 3. Документация

Всегда документируйте при добавлении новых флагов:
- Назначение и сценарий использования
- Значение по умолчанию
- Влияние на систему
- Связанные компоненты
- Зависимости

### 4. Стратегия развёртывания

Для новых функций:
1. Создайте флаг с `enabled: false`
2. Разверните код, который проверяет флаг
3. Включите флаг для внутреннего тестирования (область группы)
4. Включите для бета-пользователей (область пользователя)
5. Включите глобально при успешном тестировании

### 5. Мониторинг

Проверяйте метрики использования флагов:
```promql
# Всего проверок флагов
rate(feature_flag_checks_total[5m])

# Процент попаданий в кэш
rate(feature_flag_cache_hits_total[5m]) / rate(feature_flag_checks_total[5m])

# Флаги по областям
feature_flag_count by (scope)
```

## Решение проблем

### Флаг не вступает в силу

1. Проверьте существование флага: `GET /admin/feature-flags/{flag_key}`
2. Проверьте статус enabled: `enabled: true`
3. Проверьте соответствие области действия и target_ids
4. Очистите кэш: перезагрузите Redis или подождите 60 секунд

### Ошибки зависимостей

```
Ошибка: Флаг 'hints_enabled' требует, чтобы 'explanation_api_enabled' был включен
```

Решение: Сначала убедитесь, что включен основной флаг:
```bash
curl -X PUT /admin/feature-flags/explanation_api_enabled -d '{"enabled": true}'
```

### Деградация производительности

Если проверки флагов вызывают задержку:
1. Проверьте подключение к Redis: `GET /health`
2. Мониторьте процент попаданий в кэш в Prometheus
3. Увеличьте TTL кэша если необходимо
4. Проверьте индексы MongoDB на коллекции `feature_flags`

## Аудит и история

Все изменения флагов логируются в коллекцию `audit_log`:

```json
{
  "entity_type": "feature_flag",
  "entity_id": "hints_enabled",
  "action": "update",
  "changes": {
    "enabled": true,
    "scope": "global"
  },
  "reason": "Включение подсказок для всех пользователей",
  "timestamp": "2026-01-02T10:30:00Z",
  "admin_id": "admin_user_123"
}
```

Запрос истории аудита:
```bash
db.audit_log.find({
  entity_type: "feature_flag",
  entity_id: "hints_enabled"
}).sort({ timestamp: -1 }).limit(10)
