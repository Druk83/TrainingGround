# A3 — Python Explanation Builder и Embedding Pipeline

## Контекст
Документы `requirements/глоссарий.md`, `архитектура/описание BL.md` (сценарий 2 и 4) и `TL-3` определяют сервис подсказок: генерация пояснений через YandexGPT с fallback на шаблоны, обновление эмбеддингов в Qdrant, кэширование и SLA ≤1.5/2 секунды. Цель задачи — построить Python-сервис, который реализует эти требования и обеспечивает интеграцию с Rust API и Qdrant.

## Состав работ
1. **Explanation API.**
   - Реализовать сервис (aiohttp/FastAPI) с эндпоинтом `/explanations` (REST/gRPC) и схемами DTO (`topic_id`, `task_type`, `user_errors`, `language_level` → `explanation`, `rule_refs`, `source`).
   - Добавить middleware: аутентификация сервисными токенами, rate limiting, circuit breaker.
   - Реализовать RAG-пайплайн: получение контекста (MongoDB), запрос k=5 в Qdrant (`rules_embeddings`, фильтры payload), формирование промпта для YandexGPT с учётом морфологии русского языка (pymorphy2/natasha для анализа ошибок).
   - Fallback: если YandexGPT >2 сек или 503 — вернуть шаблон из MongoDB и логировать инцидент.
   - Проверка feature flag `explanation_yandexgpt_enabled` перед вызовом YandexGPT API.
2. **Кэширование и очереди.**
   - Реализовать Redis кэш `explanation:cache:{task_id}` (TTL 5 мин) и повторное использование при идентичных запросах.
   - Вести Redis Stream `content:changes`, слушать новые шаблоны и обновлять локальный кэш.
3. **Embedding Pipeline.**
   - Worker, который читает `content:changes`, извлекает документы из MongoDB, строит эмбеддинги (`sentence-transformers`, `fasttext` fallback) и записывает в соответствующие коллекции Qdrant.
   - Поддержка версионности (статусы `draft → ready → published → deprecated`), удаление устаревших эмбеддингов.
   - Планировщик (`apscheduler`) для пересборки эмбеддингов и snapshot’ов Qdrant.
4. **Интеграция с Rust API и админкой.**
   - Предоставить SDK/клиент (`backend/rust-api` и `frontend`) для вызова `/explanations`.
   - Описать вебхуки/CLI для ручного запуска пересборки (`python-generator/scripts/rebuild_embeddings.py`).
5. **Обсервабилити и безопасность.**
   - Метрики (`/metrics`): latency, hits/misses кэша, ошибок YandexGPT, длина очереди `content:changes`.
   - Логи (structured), трассировки, алерты при очереди >100 событий или SLA >2 сек.
   - Секреты (API ключи YandexGPT, доступ к Qdrant) хранятся в Vault/Secrets Manager.
6. **Документация.**
   - Протоколы взаимодействия (Mermaid sequence для подсказки), описание моделей (`docs/explanation-service.md`).
   - Скрипты для локального запуска (docker-compose profile `generator`).

## Ожидаемые артефакты
- Python-пакет/сервис с Dockerfile, зависимостями (pyproject), схемами DTO и клиентом.
- Worker/cron job для эмбеддингов + CLI и документация.
- Мониторинг и алерты для SLA подсказок и очередей.

## Чек-лист готовности
- [ ] Эндпоинт `/explanations` соответствует контракту, имеет кэш и fallback на шаблоны.
- [ ] Qdrant коллекции актуализируются через worker, а устаревшие версии помечаются `deprecated`.
- [ ] Очередь `content:changes` не растёт бесконтрольно, алерты настроены на >100 элементов.
- [ ] Поддерживаются промпты на русском языке с учетом морфологии (pymorphy2/natasha) и контекст ошибок.
- [ ] Метрики и логи интегрированы в общий стек мониторинга, есть дашборд SLA подсказок.
- [ ] Документация описывает RAG, форматы запросов и процессы восстановления.

## Тестирование
- **Unit:** `pytest`/`mypy`/`ruff` для логики извлечения правил, генерации промптов, fallback.
- **Integration:** docker-compose окружение (Mongo, Redis, Qdrant, mock YandexGPT) + тесты `tests/integration/test_explanations.py`.
- **Load:** имитация 20 qps, SLA ≤2 сек; проверка параллельных запросов и длины очереди.
- **Data validation:** тесты на полноту эмбеддингов (нет пустых payload, coverage по темам) и правильность версионности.
- **Chaos/fallback:** принудительные таймауты YandexGPT и отключение Qdrant → проверка возврата шаблонов и записи инцидентов.
