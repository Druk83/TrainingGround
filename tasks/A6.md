# A6 — Админка, контент и управление эмбеддингами

## Контекст
Сценарии AL-4 и BL-4, `requirements/глоссарий.md` и документы по структуре данных описывают жизненный цикл шаблонов (`draft → ready → published → deprecated`), модерацию правил и запуск Embedding Pipeline. Эта задача обеспечивает инструменты для администраторов и методистов.

## Состав работ
1. **Admin API (Rust).**
   - CRUD эндпоинты для тем, уровней, шаблонов, правил, feature flags.
   - Полнотекстовый поиск и фильтры (тема, статус, сложность, версия).
   - Статусы и workflow: `draft` (создание), `ready` (проверен шаблон), `published` (активен), `deprecated`.
   - Возможность возвращать шаблон на доработку (причина, логирование).
2. **Admin Console (PWA).**
   - UI для списка шаблонов/правил, редактор контента (markdown + подсветка ошибок).
   - Проверки с использованием Python Template Generator (preview задания/подсказки).
   - Панель управления feature flags и запуск пересборки эмбеддингов.
   - Адаптивный дизайн (desktop приоритет), навигация по разделам (контент/правила/флаги/пользователи).
   - Live-preview изменений перед публикацией.
3. **Интеграция с Embedding Pipeline.**
   - Публикация отправляет событие в Redis Stream `content:changes`, мониторинг статуса каждой версии.
   - Страница состояния очереди (количество задач, последние ошибки).
4. **Контроль качества и версионность.**
   - Хранение ссылок на подтверждённые правила/источники, журнал изменений (кто и когда редактировал).
   - Проверка уникальности шаблонов в рамках темы/уровня, защита от PII в тексте.
   - Автоматический lint контента: regex для поиска PII (телефоны, email, ФИО), blacklist слов, проверка длины текста.
   - Валидация правил русского языка: проверка ссылок на существующие коллекции `word_forms`, непротиворечивость примеров.
5. **Безопасность и аудит.**
   - RBAC: только администратор контента имеет доступ к CRUD; действия логируются в `audit_log`.
   - Интеграция с SSO/OTP для критических операций (удаление шаблона, депубликование).
6. **Документация.**
   - Руководство по модерации (`docs/content-governance.md`), чек-листы качества, критерии готовности.
   - Диаграмма состояний шаблона и скрипты автоматизации (CLI для массового импорта).

## Ожидаемые артефакты
- Admin API/Console с workflow статусов и интеграцией с Embedding Pipeline.
- CLI/скрипты для импорта, бэкапа и массовых операций.
- Документация и чек-листы методистов.

## Чек-лист готовности
- [ ] Все операции над шаблонами/правилами доступны только авторизованным администраторам и логируются.
- [ ] Workflow статусов и привязка к Embedding Pipeline работают, очередь видна в UI.
- [ ] Проверки качества (lint, уникальность, отсутствие PII) выполняются перед публикацией.
- [ ] Feature flags можно включать/выключать и связывать с группами/пользователями.
- [ ] Админка предоставляет возможность откатить шаблон в `draft` и объясняет причины.
- [ ] Документация описывает процесс модерации и восстановление в случае сбоя Pipeline.

## Тестирование
- **Unit:** тесты Admin API (валидация, workflow, RBAC), проверки редактора (lint контента).
- **Integration:** сценарии публикации → событие в Redis → обновление статуса, проверка последствий в Qdrant/Mongo.
- **E2E:** Playwright/Admin сценарии — создание шаблона, проверка, публикация, rollback, запуск пересборки.
- **Security:** тесты на попытку обхода ролей, CSRF, проверка подписей, audit log completeness.
- **Data QA:** автоматический прогон банок шаблонов на уникальность/PII (regex, blacklist).
