# A4 — Ученический PWA: уроки, таймеры, офлайн

## Контекст
Документы `requirements/сценарии/требования.md` (разделы 4.2 и 4.4), `архитектура/описание BL.md` (Сценарий 1–2) и `структураПО/стек проекта.md` описывают интерфейс ученика: PWA с Web Components, таймером, подсказками, офлайн-режимом и античит-механиками. Задача — реализовать фронтенд, который покрывает эти сценарии и укладывается в UX/доступность (WCAG 2.1 AA).

## Состав работ
1. **Инфраструктура проекта.**
   - Настроить `frontend/` (Vite/esbuild, TypeScript 5, ESLint, Prettier, Vitest, @web/test-runner).
   - Подготовить shared state (JWT, feature flags, offline queue), конфиг слоёв (pages/components/services/sw).
2. **Lesson Player & лайауты.**
   - Реализовать страницы каталога тем, экрана уровня и итогов (Columns: темы, рабочая зона, аналитика).
   - Добавить адаптивные брейкпоинты (XL→XXS, VH) согласно требованиям 4.4.7.
   - Встроить Lesson Player: список заданий, текущий таймер, поле ответа, кнопки подсказок, статус серии.
3. **Таймеры и подсказки.**
   - Подписка на SSE/WebSocket для `timer-tick`, визуализация таймера (45/90/180 сек).
   - Кнопка «Подсказка»: отображение стоимости (−5 баллов), лимита 2 запросов, fallback UI при ошибке.
   - Панель пояснения (ответ Rust API/Python) с источниками правил и ссылками.
4. **Состояние баллов, серии, переходы.**
   - Реализовать live-обновление баллов, серии, процент правильных ответов (зависит от ответов пользователя и подсказок).
   - Показать блокировку уровня при <80 % и баннер «доступно следующее» при успехе.
5. **Офлайн и синхронизация.**
   - Service Worker (+Workbox/custom) с кэшированием shell + данных урока, хранение офлайн-ответов в IndexedDB.
   - Механизм повторной синхронизации при восстановлении сети (см. тест-кейс 8.5 из `requirements/тестирование/стек тестов.md`).
   - Conflict resolution: при конфликтах (сервер уже имеет более новый ответ) показывать пользователю уведомление и предлагать варианты (принять серверную версию/отменить локальную).
   - Отдельный экран для статуса подключения и конфликтов.
6. **UX, доступность, античит.**
   - Поддержка клавиатуры, подсказки по управлению, оповещения (aria-live).
   - Встроить поведенческую аналитику (скорость ввода, подозрительные шаблоны) и отправку на Rust API.
   - Onboarding ≤5 минут, подсказки внутри UI.
7. **Документация.**
   - Storybook/Docs для Web Components, описание навигации и offline flow.
   - Инструкции по сборке (PWA manifest, SRI, подписанный Service Worker).

## Ожидаемые артефакты
- PWA с основными страницами, сервис-воркером, Web Components и state-менеджментом.
- UI-кит/Storybook, документация по responsive-сетке и offline синхронизации.
- Набор тестов (unit/e2e) и Lighthouse/a11y отчёты.

## Чек-лист готовности
- [x] Lesson Player, подсказки, таймеры и статистика реализованы и взаимодействуют с Rust API.
- [x] Профили адаптивности (XL→XXS, VH) и требования доступности выполнены (axe/Lighthouse ≥ 90).
- [x] Офлайн режим сохраняет ответы, синхронизирует их после reconnect и уведомляет пользователя о статусе.
- [x] Сервис-воркер подписан, выполняет безопасное обновление (skipWaiting + уведомление).
- [x] Поведенческая аналитика и античит события отправляются в API и могут быть отключены фич-флагом.
- [x] Документация описывает сценарии использования, hotkeys и edge cases (таймауты, подсказки, блокировки).

## Тестирование
- **Unit/Snapshot:** Vitest + @web/test-runner для компонентов (таймер, подсказки, scoreboard, offline manager).
- **E2E:** Playwright/WebdriverIO сценарии: прохождение урока, работа с подсказками, таймаут, offline/online (см. SYS-01…SYS-07, 8.5).
- **PWA audits:** Lighthouse PWA/a11y/Best Practices, axe CLI.
- **Manual:** проверка на планшете/ноутбуке/мобильном (SM, XS, XXS), удержание фокуса, gestures.
- **Security:** проверка CSP, CSRF token в запросах, корректность работы hCaptcha/anti-bot flow.
