# TD-06-27 — HSTS header configuration и SSL deployment проверка

## Статус
**Технический долг** — конфигурация готова, требует реального deployment для проверки

## Контекст

Задача из TD-06 (Authentication & Authorization): настройка HSTS header с соблюдением законодательства РФ и проверка SSL конфигурации на реальном домене.

**Что уже сделано:**
- HSTS header настроен в [infra/nginx/conf.d/trainingground.conf:67](../infra/nginx/conf.d/trainingground.conf#L67)
- Конфигурация соответствует ФЗ-152: БЕЗ `preload` директивы
- DNS resolver изменен с Google (8.8.8.8) на Yandex DNS (77.88.8.8, 77.88.8.1)
- Подробное правовое обоснование в комментариях
- Документация в [infra/nginx/README.md](../infra/nginx/README.md)
- Production deployment готов через docker-compose.prod.yml
- Let's Encrypt автоматизация через certbot

**Что осталось сделать:**
- Получить домен (staging или production)
- Задеплоить приложение с реальным SSL сертификатом
- Проверить через SSL Labs (https://www.ssllabs.com/ssltest/)
- Проверить через http.itsoft.ru
- Подтвердить grade A или A+

## Правовое решение по HSTS Preload

**Решение:** НЕ использовать директиву `preload` для соблюдения ФЗ-152.

**Обоснование:**
- HSTS Preload List (hstspreload.org) управляется Google (США)
- Для включения в preload list нужно отправить домен на сервер Google
- Образовательная платформа обрабатывает персональные данные (email, имена учеников)
- ФЗ-152 требует локализации данных на территории РФ
- Передача доменного имени на американский сервер может нарушить требования локализации

**Альтернативная защита:**
- HSTS с `max-age=31536000; includeSubDomains` (1 год запоминания)
- 301 редирект с HTTP на HTTPS на уровне Nginx
- TLS 1.3/1.2 с Mozilla Modern cipher suites
- OCSP stapling через Yandex DNS резолверы
- Защита от MITM-атак сохраняется

**Конфигурация:**
```nginx
# infra/nginx/conf.d/trainingground.conf:67
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

# DNS resolver для OCSP stapling (ФЗ-152 compliance)
resolver 77.88.8.8 77.88.8.1 valid=300s;
```

## Опции для домена

### Вариант 1: DuckDNS для staging/testing (рекомендуется для начала)

**Преимущества:**
- Бесплатно
- Let's Encrypt работает из коробки
- Настройка за 5 минут
- Реальный SSL сертификат
- Можно протестировать всю конфигурацию

**Шаги:**
1. Зарегистрироваться на https://www.duckdns.org/
2. Создать домен: `trainingground.duckdns.org`
3. Получить token для обновления IP
4. Настроить автообновление IP:
   ```bash
   # Добавить в cron (каждые 5 минут)
   */5 * * * * curl "https://www.duckdns.org/update?domains=trainingground&token=YOUR_TOKEN&ip="
   ```
5. Обновить конфигурацию:
   ```bash
   # infra/nginx/init-letsencrypt.sh
   DOMAINS=(trainingground.duckdns.org)
   EMAIL="your-email@example.com"

   # infra/nginx/conf.d/trainingground.conf
   server_name trainingground.duckdns.org;
   ```
6. Запустить SSL setup:
   ```bash
   # Staging (тест)
   STAGING=1 bash infra/nginx/init-letsencrypt.sh

   # Production сертификат
   STAGING=0 bash infra/nginx/init-letsencrypt.sh
   ```
7. Запустить production deployment:
   ```bash
   docker-compose -f docker-compose.prod.yml up -d
   ```

**Альтернативы DuckDNS:**
- No-IP (hopto.org, zapto.org)
- FreeDNS (afraid.org)
- Cloudflare Tunnel (не требует публичного IP)

### Вариант 2: Покупка домена trainingground.ru для production

**Где купить (российские регистраторы):**
- REG.RU - примерно 200-500 руб/год для .ru
- Timeweb - примерно 150-400 руб/год
- nic.ru - официальный регистратор .ru/.рф

**Шаги:**
1. Купить домен trainingground.ru
2. Настроить A/AAAA записи на IP сервера
3. Обновить конфигурацию (аналогично DuckDNS)
4. Получить Let's Encrypt сертификат
5. Запустить production deployment

## Чек-лист для завершения задачи

### Подготовка
- [ ] Выбрать вариант домена (DuckDNS staging или покупка домена)
- [ ] Настроить DNS записи (A/AAAA на IP сервера)
- [ ] Убедиться что порты 80 и 443 открыты в firewall
- [ ] Обновить `.env` с production секретами

### Deployment
- [ ] Собрать frontend: `cd frontend && npm run build`
- [ ] Проверить что `frontend/dist/index.html` существует
- [ ] Обновить домен в `infra/nginx/init-letsencrypt.sh` и `trainingground.conf`
- [ ] Запустить init-letsencrypt.sh (сначала staging, потом production)
- [ ] Запустить `docker-compose -f docker-compose.prod.yml up -d`
- [ ] Проверить что Nginx стартовал: `docker-compose -f docker-compose.prod.yml logs nginx`

### Проверка SSL конфигурации
- [ ] Открыть https://YOUR_DOMAIN в браузере
- [ ] Проверить что сертификат валидный (зеленый замок)
- [ ] Проверить что HTTP редиректит на HTTPS
- [ ] Проверить HSTS header через DevTools:
  ```bash
  curl -I https://YOUR_DOMAIN | grep -i strict-transport-security
  # Должен вывести: strict-transport-security: max-age=31536000; includeSubDomains
  ```
- [ ] SSL Labs test: https://www.ssllabs.com/ssltest/analyze.html?d=YOUR_DOMAIN
  - **Ожидаемый grade:** A или A+
  - **Проверить:** TLS 1.3/1.2, strong cipher suites, HSTS, OCSP stapling
- [ ] http.itsoft.ru проверка (если доступен)
- [ ] Проверить CSP header:
  ```bash
  curl -I https://YOUR_DOMAIN | grep -i content-security-policy
  ```

### Автообновление сертификатов
- [ ] Настроить cron job для certbot renewal:
  ```bash
  # /etc/crontab или crontab -e
  0 3 * * * /path/to/MishaGame/infra/nginx/certbot-renew.sh >> /var/log/certbot-renew.log 2>&1
  ```
- [ ] Протестировать renewal вручную:
  ```bash
  docker-compose -f docker-compose.prod.yml run --rm certbot renew --dry-run
  ```

## Документация

**Конфигурационные файлы:**
- [infra/nginx/nginx.conf](../infra/nginx/nginx.conf) - основная конфигурация Nginx
- [infra/nginx/conf.d/trainingground.conf](../infra/nginx/conf.d/trainingground.conf) - virtual host с HTTPS
- [infra/nginx/init-letsencrypt.sh](../infra/nginx/init-letsencrypt.sh) - первичная настройка SSL
- [infra/nginx/certbot-renew.sh](../infra/nginx/certbot-renew.sh) - скрипт обновления сертификатов
- [docker-compose.prod.yml](../docker-compose.prod.yml) - production deployment

**Руководства:**
- [infra/nginx/README.md](../infra/nginx/README.md) - полная документация по deployment
- [docs/deployment-security.md](../docs/deployment-security.md) - security checklist

## Связь с другими задачами

**Блокирует:**
- Production запуск с реальным доменом
- Проверка compliance перед релизом

**Зависит от:**
- TD-06 Task 26 (HTTPS + TLS 1.3 setup) - завершена
- Frontend build (npm run build) - требуется перед deployment

## Критерии приёмки

1. Приложение доступно по HTTPS на реальном домене (staging или production)
2. SSL Labs grade A или A+
3. HSTS header присутствует без директивы `preload`
4. HTTP редирект на HTTPS работает (301)
5. TLS 1.3/1.2 enabled, TLS 1.0/1.1 disabled
6. OCSP stapling работает через Yandex DNS
7. Security headers присутствуют (X-Frame-Options, CSP, etc.)
8. Автообновление сертификатов настроено (cron job)
9. Документация обновлена с финальным доменом

## Оценка

**Для DuckDNS staging:**
- Настройка домена: 15 минут
- SSL setup: 20 минут
- Deployment: 10 минут
- Проверка и тесты: 30 минут
- **ИТОГО:** примерно 1.5 часа

**Для production домена:**
- Покупка домена: 30 минут
- DNS setup: 1-24 часа (время propagation)
- SSL setup: 20 минут
- Deployment: 10 минут
- Проверка и тесты: 30 минут
- **ИТОГО:** примерно 2 часа работы + время DNS propagation

## Приоритет

**P2 (средний приоритет)** - не блокирует разработку, но требуется для production запуска

## Следующие шаги

1. Решить какой вариант домена использовать (DuckDNS для быстрого теста или покупка домена)
2. Если DuckDNS - зарегистрироваться и настроить за 15 минут
3. Запустить deployment по чек-листу выше
4. Проверить через SSL Labs
5. Если все OK - отметить задачу как завершенную в TD-06.md
