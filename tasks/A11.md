# A11 — SSO и расширенная аутентификация

## Контекст
Согласно `requirements/сценарии/требования.md` (4.1.3, 4.2.1, 4.2.5, 4.4.6), система должна поддерживать интеграцию с системами аутентификации школ через OAuth2/SAML для упрощения входа учащихся и кураторов. Это опциональная функциональность, управляемая feature flag, но требует полноценной реализации для промышленного использования.

## Состав работ
1. **OAuth2 Provider интеграция.**
   - Реализовать OAuth2 Authorization Code Flow в Rust API (библиотека `oauth2`).
   - Поддержка провайдеров: Яндекс ID, VK ID, Госуслуги (ЕСИА).
   - Конфигурация: `client_id`, `client_secret`, `redirect_uri`, `scopes` в `config/*.toml`.
   - После успешной авторизации создавать/обновлять профиль пользователя в MongoDB (`users` коллекция).
2. **SAML 2.0 интеграция.**
   - Реализовать SAML Service Provider в Rust API (библиотека `samael`).
   - Поддержка IdP метаданных (XML), проверка подписей, обработка SAML Assertions.
   - Маппинг атрибутов: `email`, `name`, `groups` → MongoDB `users` и `groups`.
3. **JWT с расширенными claims.**
   - После SSO создавать JWT с claims: `sub` (user_id), `email`, `name`, `role`, `group_ids`, `auth_method` (sso_oauth2/sso_saml/local).
   - Поддержка refresh tokens (Redis: `refresh_token:{user_id}`, TTL 30 дней).
   - Эндпоинты: `POST /auth/refresh`, `POST /auth/logout` (инвалидация токенов).
4. **Локальная аутентификация (fallback).**
   - Регистрация/вход по email/password (bcrypt, библиотека `argon2`).
   - Эндпоинты: `POST /auth/register`, `POST /auth/login`, `POST /auth/password-reset`.
   - Email-верификация и восстановление пароля (интеграция с SMTP или Яндекс.Почта API / Mail.ru Cloud Solutions).
5. **Frontend интеграция.**
   - PWA страницы: `/login`, `/login/sso`, `/register`.
   - Обработка OAuth2 redirect callback, отображение ошибок.
   - Хранение JWT в httpOnly cookie + refresh token в localStorage (с шифрованием).
6. **Admin интерфейс для SSO конфигурации.**
   - Страница настройки OAuth2/SAML провайдеров (Admin Console).
   - Возможность включить/выключить SSO через feature flag `sso_enabled`.
   - Тестовые кнопки для проверки интеграции (test login flow).
7. **Безопасность и аудит.**
   - CSRF защита для OAuth2 (state parameter).
   - Rate limiting для `/auth/*` эндпоинтов (5 попыток/мин).
   - Логирование всех попыток входа (успешных и неудачных) в `audit_log`.
   - Поддержка MFA (опционально, через TOTP/WebAuthn).
8. **Документация.**
   - Инструкции по настройке OAuth2/SAML провайдеров (`docs/sso-setup.md`).
   - Диаграммы sequence для OAuth2/SAML flows.
   - Runbook для troubleshooting проблем с SSO.

## Ожидаемые артефакты
- Реализованная SSO в Rust API с поддержкой OAuth2 и SAML.
- Frontend страницы аутентификации с SSO кнопками.
- Admin интерфейс для управления SSO конфигурацией.
- Документация и тесты.

## Чек-лист готовности
- [ ] OAuth2 flow работает для Яндекс ID, VK ID, Госуслуги/ЕСИА (тестовые аккаунты).
- [ ] SAML интеграция протестирована с mockIdP или тестовым стендом ЕСИА.
- [ ] JWT с правильными claims создаются после SSO, refresh tokens работают.
- [ ] Локальная аутентификация (email/password) работает как fallback.
- [ ] Frontend корректно обрабатывает SSO redirect и ошибки.
- [ ] CSRF, rate limiting и аудит логирование реализованы.
- [ ] Документация описывает процесс настройки для школ/организаций.

## Тестирование
- **Unit:** тесты OAuth2/SAML парсинга, JWT generation, refresh token logic.
- **Integration:** docker-compose + mock OAuth2/SAML провайдеры (Keycloak/mockIdP) + тесты полного flow.
- **E2E:** Playwright сценарии — вход через SSO, logout, refresh token, переключение между local/SSO.
- **Security:** тесты на CSRF, replay attacks, rate limiting, попытки подделки JWT.
- **Load:** имитация 100 параллельных SSO входов, проверка латентности и корректности.
