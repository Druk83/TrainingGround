# A10 — Feature Flags и динамическая конфигурация

## Контекст
Согласно `requirements/сценарии/требования.md` (4.2.1, п.11), `глоссарий.md` и документам архитектуры, система должна поддерживать feature flags для гибкого управления функциональностью: включение/выключение подсказок, новых правил начисления баллов, експериментальных метрик, SSO. Это критично для безопасного развёртывания и A/B тестирования.

## Состав работ
1. **Модель данных Feature Flags.**
   - Коллекция MongoDB `feature_flags` с полями: `flag_key`, `enabled`, `scope` (global/group/user), `target_ids`, `config` (JSON параметры), `version`, `updated_at`.
   - Примеры флагов: `hints_enabled`, `sso_oauth2`, `scoring_bonus_v2`, `anticheat_strict_mode`, `qdrant_fallback`.
   - Поддержка версионности и аудита изменений (кто и когда включил/выключил).
2. **Feature Flag Service (Rust).**
   - Модуль в Rust API для проверки флагов с кэшированием в Redis (`feature_flag_cache`, TTL 60 сек).
   - API: `fn is_enabled(flag_key: &str, user_id: Option<&str>, group_id: Option<&str>) -> bool`.
   - Поддержка иерархии: user-level → group-level → global.
   - Graceful degradation: если Redis недоступен, читать напрямую из MongoDB.
3. **Admin API для управления флагами.**
   - CRUD эндпоинты: `GET /feature-flags`, `POST /feature-flags`, `PUT /feature-flags/{key}`, `DELETE /feature-flags/{key}`.
   - Валидация: проверка зависимостей флагов (например, `hints_enabled` требует `explanation_api_enabled`).
   - Аудит: запись в `audit_log` при изменении флагов с указанием администратора и причины.
4. **Frontend интеграция.**
   - PWA запрашивает актуальные флаги при инициализации (`GET /api/feature-flags?user_id=xxx`).
   - Клиентское кэширование флагов в localStorage/IndexedDB с обновлением при reconnect.
   - UI-компоненты реагируют на флаги (скрытие кнопок, изменение логики).
5. **Python сервис интеграция.**
   - Explanation Builder проверяет флаг `explanation_yandexgpt_enabled` перед вызовом YandexGPT.
   - Template Generator проверяет `adaptive_templates_enabled` для персонализации.
6. **Мониторинг и алерты.**
   - Метрики: количество активных флагов, частота проверок, cache hit rate.
   - Алерты: если флаг изменён администратором, уведомление в DevOps канал (Telegram/Slack).
7. **Seed данные и документация.**
   - Создать seed-файл `infra/config/seed/feature_flags.json` с базовыми флагами.
   - Обновить `docs/feature-flags.md` с описанием каждого флага, зависимостей и примеров использования.

## Ожидаемые артефакты
- Feature Flag Service в Rust с Redis кэшированием.
- Admin API/UI для управления флагами.
- Интеграция во всех сервисах (Rust, Python, PWA).
- Seed-данные, документация и мониторинг.

## Чек-лист готовности
- [x] Коллекция `feature_flags` создана с индексами и валидацией.
- [x] Rust/Python/PWA проверяют флаги через единый интерфейс с кэшированием.
- [x] Admin API позволяет управлять флагами с аудитом и валидацией зависимостей.
- [x] Frontend корректно скрывает/показывает функциональность в зависимости от флагов.
- [x] Метрики и алерты для изменений флагов интегрированы в мониторинг.
- [x] Документация описывает все флаги, их назначение и влияние на систему.

## Тестирование
- **Unit:** тесты иерархии флагов (user > group > global), кэширования, graceful degradation.
- **Integration:** docker-compose (Mongo, Redis, Rust, Python, PWA) + сценарии включения/выключения флагов.
- **E2E:** Playwright тесты — отключить `hints_enabled`, проверить, что кнопка подсказок скрыта.
- **Performance:** проверка, что проверка флагов не добавляет >5 мс к latency API.
- **Security:** тесты на попытку обхода флагов через модификацию localStorage, проверка RBAC для Admin API.
