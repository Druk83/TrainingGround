# A5 — Аналитика и кабинеты куратора

## Контекст
В `requirements/сценарии/требования.md` (разделы 4.2, 4.3, 4.4), `архитектура/описание BL.md` (Сценарий 3) и документах о данных описаны отчёты, KPI и экспортные требования: куратор должен видеть прогресс группы, экспортировать CSV/PDF ≤10 секунд и работать только со своими группами. Задача — реализовать backend и frontend для аналитики.

## Состав работ
1. **Reporting API (Rust).**
   - Эндпоинты: `GET /stats/users/{id}`, `GET /stats/groups/{id}`, `GET /stats/topics/{id}`, `POST /stats/groups/{id}/export`.
   - Агрегации по `attempts`, `progress_summary`, `hints_log`, `materialized_stats` (предвычисленные данные).
   - RLS/guard’ы по `role`/`group_ids`: учитель не может увидеть чужие группы.
   - Signed URL для скачивания отчётов (Object Storage, TTL 24 часа).
2. **Analytics Worker.**
   - Batch (Rust/Python) который ежечасно обновляет `materialized_stats`, `leaderboards`, строит KPI (accuracy, hints, time).
   - Cron для агрегатов по периодам (день/неделя/месяц) и фиксации «лучших попыток».
   - Поддержка фич-флагов для включения новых метрик.
3. **Teacher Dashboard (PWA).**
   - Страницы: обзор групп, детализация ученика, сравнительные графики, экспорт.
   - Индикаторы: % выполненных уроков, среднее время, частота подсказок, ТОП ошибок.
   - Фильтры по теме/периоду, переключение между real-time и отложенными данными.
   - Live-обновление метрик через WebSocket/SSE (опционально) или polling каждые 30 сек.
   - Адаптивный дизайн (desktop/tablet), доступность WCAG 2.1 AA.
4. **Экспорт и уведомления.**
   - Генерация CSV/PDF (например, `report_worker`), хранение в Yandex Object Storage, отправка ссылки и уведомления (email/Telegram) при готовности.
   - Логирование запросов экспорта (`report_exports`), ограничение частоты (rate limit).
5. **Интеграция с админкой/SSO.**
   - Возможность назначить учителя на группы (через Admin Console), управление доступами.
   - Подготовка API для импорта данных школы (если подключен SSO).
6. **Документация.**
   - Обновить `docs/reporting.md` с описанием KPI, SLA (5 сек экран, 10 сек экспорт), ERD агрегатов.
   - Добавить примеры CSV/PDF и схемы авторизации.

## Ожидаемые артефакты
- Reporting API с документацией (OpenAPI/JSON Schema).
- Batch/worker с расписанием, материализованными таблицами, мониторингом.
- Teacher Dashboard UI и справочные материалы.

## Чек-лист готовности
- [ ] Reporting API возвращает корректные KPI и защищён от доступа к чужим группам.
- [ ] Материализованные представления обновляются по расписанию, worker устойчив к сбоям.
- [ ] Экспорт (CSV/PDF) укладывается в SLA ≤10 сек и хранится 24 часа.
- [ ] UI поддерживает фильтры, графики и экспорт, отображает статусы построения.
- [ ] Документация описывает KPI, формат отчётов, ограничения и поведение при ошибках.
- [ ] Метрики и логи для Analytics Worker интегрированы в мониторинг, есть алерты при задержке >5 мин.

## Тестирование
- **Unit:** тесты агрегатов (Rust/Python), проверка расчётов accuracy/time/hints, корректности сериализации CSV/PDF.
- **Integration:** docker-compose тесты `tests/reporting` (Mongo + worker + API) с фиктивными данными.
- **E2E:** Playwright сценарии учителя: просмотр группы, фильтры, экспорт, проверка ролей (Forbidden).
- **Performance:** нагрузка 30 учеников/группа, 10 групп → ответ API ≤5 сек, экспорт ≤10 сек.
- **Security:** тесты RLS (учитель не видит чужую группу), проверка JWT claims, подписанных URL, rate limiting экспорта.
