# TD-03 — Observability & Testing Hardening (A3 Follow-up)

## Контекст
Реализация A3 (Python Explanation Builder & Embedding Pipeline) завершена, но ревью показало ряд задач, которые нужно вынести в отдельный трек:
- python-generator пока не мониторится Prometheus'ом → нет видимости по latency/cache-hit ошибки.
- Набор тестов минимальный (2 unit-теста на кэш). Нет интеграционных сценариев (Mongo/Qdrant/YandexGPT), нет нагрузочных проверок SLA ≤2 сек при 20 rps.
- Есть мелкие несоответствия стилю/рутине (uvicorn factory, строки >100 символов).

## Цели
1. Дотянуть observability до уровня остальных сервисов (Prometheus + Grafana + алерты).
2. Расширить тестовое покрытие (unit + integration + load) так, чтобы SLA/регрессии ловились до продакшена.
3. Устранить технические долги, которые всплыли в оценке A3.

## Задачи
### P0 — Monitoring/Alerting
- [ ] Добавить python-generator в infra/prometheus/prometheus.yml (scrape /metrics 8000/tcp).
- [ ] Обновить Grafana дашборды: latency, cache hits/misses, YandexGPT error rate, Redis Stream lag.
- [ ] Настроить алерты (Slack/Email) по ключевым метрикам: p95 latency >2 сек, cache miss ratio >0.6, очередь content:changes >100.

### P1 — Testing
- [ ] Unit-тесты на RAG pipeline: эмуляция Mongo/Qdrant, проверка fallback сценариев и нормализации ошибок (pymorphy2/Natasha).
- [ ] Интеграционный тест 	ests/integration/test_explanations.py: mock YandexGPT/Qdrant, проверка полного пути /v1/explanations.
- [ ] Добавить smoke-кейс для Redis Stream worker (инжект события → Qdrant upsert).
- [ ] Нагрузочный тест (Locust/k6): 20 rps, SLA ≤2 сек, проверить деградацию кэша. Скрипт + README с инструкциями.

### P1 — Engineering Hygiene
- [ ] Перевести запуск uvicorn на factory-режим (uvicorn --factory explanation_service.app:create_app).
- [ ] Исправить длинные строки/ruff замечания (например ag.py:126).
- [ ] Заменить datetime.utcnow() → datetime.now(datetime.UTC) (предупреждение Pydantic).
- [ ] Добавить ruff + mypy в CI шаги для python-generator.

## Артефакты
- PR с обновлёнными infra/prometheus/*.yml + Grafana JSON.
- Новые тесты (	ests/integration/, 	ests/load/) + документация по запуску.
- Обновлённый README/docs/explanation-service.md с разделом “Monitoring & QA”.
- Скриншоты/описание алертов (или ссылка на конфигурацию в репозитории).

## Готовность
- Все таски выше закрыты.
- docker compose up поднимает Prometheus/Grafana с python-generator в scrape списке.
- pytest, uff, mypy, cargo test и make load-test проходят локально.
- Алерты и дашборды описаны в docs/explanation-service.md.
