# TD-06 — Авторизация и аутентификация пользователей

## Статус
**Критический техдолг** — блокирует полноценное тестирование A6 и запуск в production

## Контекст

Текущее состояние:
- JWT middleware для защиты endpoints (Rust API)
- Superuser bootstrap механизм (bcrypt, MongoDB)
- RBAC guards (admin_guard_middleware)
- **НЕТ страницы логина**
- **НЕТ POST /api/v1/auth/login endpoint**
- **НЕТ регистрации пользователей**
- **НЕТ управления сессиями (refresh tokens)**
- **НЕТ SSO интеграции**

**Проблема:** Невозможно протестировать админ-консоль (A6) и другие защищенные функции в "боевом" режиме. Текущий workaround — ручной ввод JWT токена через DevTools консоль.

**Требования из документации:**
- `requirements/сценарии/требования.md` §4.2.1: "Регистрация/аутентификация учащихся и кураторов (email, SSO, гостевой доступ)"
- `requirements/сценарии/требования.md` §4.4.6: RBAC, Email/Password (bcrypt ≥12), SSO (OAuth 2.0/SAML), JWT TTL ≤1h, 2FA для админов

## Роли пользователей (из requirements/архитектура/описание AL.md)

| Роль | Код | Описание | Сценарии |
|------|-----|----------|----------|
| Ученик | `student` | Проходит уровни, получает подсказки | AL-1 |
| Куратор/Учитель | `teacher` | Просмотр статистики групп, отчеты | AL-2 |
| Администратор контента | `admin` | Модерация шаблонов, управление эмбеддингами | AL-3, A6 |
| Системный администратор | `sysadmin` | Мониторинг инцидентов, управление инфраструктурой | AL-4 |

## Состав работ

### 1. Backend API (Rust)

#### 1.1. Authentication Endpoints
- `POST /api/v1/auth/register` — регистрация нового пользователя
  - Параметры: `{ email, password, name, role?, group_ids? }`
  - Валидация email (regex), password (≥8 символов, сложность)
  - Хеширование bcrypt (cost=12)
  - Создание пользователя в MongoDB `users` collection
  - Автоматическое назначение роли `student` если не указано
  - Rate limiting: 5 регистраций/IP/час

- `POST /api/v1/auth/login` — авторизация пользователя
  - Параметры: `{ email, password, remember_me? }`
  - Проверка email + bcrypt.verify(password, password_hash)
  - Генерация JWT access token (TTL=1h, claims: sub, role, group_ids, exp, iat)
  - Генерация refresh token (TTL=30d, HTTP-only cookie, Secure, SameSite=Strict)
  - Логирование попытки (success/failure, IP, timestamp) в `audit_log`
  - Rate limiting: 10 попыток/IP/5мин, затем CAPTCHA или временная блокировка
  - Возврат: `{ access_token, user: { id, email, name, role, group_ids } }`

- `POST /api/v1/auth/refresh` — обновление access token
  - Читает refresh token из HTTP-only cookie
  - Проверяет валидность в MongoDB (коллекция `refresh_tokens`)
  - Генерирует новый access token
  - Опционально: ротация refresh token (single-use)

- `POST /api/v1/auth/logout` — выход из системы
  - Инвалидация refresh token (blacklist в Redis или удаление из MongoDB)
  - Очистка HTTP-only cookie
  - Логирование события

- `GET /api/v1/auth/me` — получение текущего пользователя (protected)
  - Требует JWT в header: `Authorization: Bearer <token>`
  - Возвращает: `{ id, email, name, role, group_ids, created_at }`

- `POST /api/v1/auth/change-password` — смена пароля (protected)
  - Параметры: `{ old_password, new_password }`
  - Проверка старого пароля, валидация нового
  - Инвалидация всех refresh tokens пользователя (forced re-login)

#### 1.2. User Management (только для admin)
- `GET /api/v1/users` — список пользователей (пагинация, фильтры по role/group)
- `GET /api/v1/users/:id` — детали пользователя
- `PATCH /api/v1/users/:id` — обновление (name, role, group_ids, is_blocked)
- `DELETE /api/v1/users/:id` — удаление/блокировка пользователя
- Все операции логируются в `audit_log`

#### 1.3. Security Features
- **Rate Limiting:**
  - Login: 10 попыток/5мин per IP → временная блокировка 15 мин
  - Register: 5 регистраций/час per IP
  - Password change: 3 попытки/час per user

- **Failed Auth Monitoring:**
  - После 5 неудачных попыток за 5 мин → аккаунт переводится в режим ограничения (rate limit 1 req/sec)
  - Уведомление на email о подозрительной активности

- **Session Management:**
  - Refresh tokens хранятся в MongoDB `refresh_tokens` (user_id, token_hash, created_at, expires_at, last_used_at)
  - Автоматическая очистка истекших токенов (TTL index)
  - Возможность просмотра активных сессий (endpoint `/api/v1/auth/sessions`)
  - Массовая инвалидация всех сессий кроме текущей

#### 1.4. Database Models
```rust
// backend/rust-api/src/models/user.rs
pub struct User {
    pub id: ObjectId,
    pub email: String,           // unique, validated
    pub password_hash: String,   // bcrypt cost=12
    pub name: String,
    pub role: UserRole,          // enum: student, teacher, admin, sysadmin
    pub group_ids: Vec<String>,  // для teachers/students
    pub is_blocked: bool,
    pub created_at: DateTime,
    pub updated_at: DateTime,
    pub last_login_at: Option<DateTime>,
}

pub enum UserRole {
    Student,
    Teacher,
    Admin,
    SysAdmin,
}

// backend/rust-api/src/models/refresh_token.rs
pub struct RefreshToken {
    pub id: ObjectId,
    pub user_id: ObjectId,
    pub token_hash: String,      // SHA-256 hash of token
    pub created_at: DateTime,
    pub expires_at: DateTime,
    pub last_used_at: DateTime,
  pub user_agent: Option<String>,
    pub ip: Option<String>,
}
```

### 2. Frontend (PWA)

#### 2.1. Login Page
- Создать `frontend/src/pages/login-page.ts` (Lit component)
- UI:
  - Email input (валидация на клиенте)
  - Password input (type=password, toggle visibility)
  - "Remember me" checkbox (30 дней refresh token)
  - "Login" button
  - Ссылка на регистрацию
  - Ссылка "Forgot password?" (будущая фича)
  - Отображение ошибок (неверный пароль, блокировка)
- Логика:
  - POST /api/v1/auth/login
  - Сохранение access_token в localStorage
  - Редирект на `/` (главная) или `/admin` (для админа)

#### 2.2. Registration Page
- Создать `frontend/src/pages/register-page.ts`
- UI:
  - Email, Password, Confirm Password, Name
  - Валидация на клиенте (password strength indicator)
  - CAPTCHA (опционально, если rate limit превышен)
  - Согласие с политикой конфиденциальности (checkbox)
- Логика:
  - POST /api/v1/auth/register
  - Автоматический логин после регистрации
  - Редирект на `/onboarding` (будущая фича)

#### 2.3. Navigation & Auth State
- Обновить `frontend/src/main.ts`:
  - Проверка наличия auth_token в localStorage
  - Автоматический редирект на `/login` если токен отсутствует (для защищенных страниц)
  - Добавить logout кнопку в header (если залогинен)

- Создать `frontend/src/lib/auth-service.ts`:
  ```typescript
  export class AuthService {
    static isAuthenticated(): boolean
    static getUser(): User | null
    static hasRole(role: string): boolean
    static login(email: string, password: string): Promise<AuthResponse>
    static logout(): Promise<void>
    static refreshToken(): Promise<string>
  }
  ```

#### 2.4. Protected Routes
- Обновить роутинг в `frontend/src/main.ts`:
  ```typescript
  const requireAuth = (redirectTo = '/login') => {
    if (!AuthService.isAuthenticated()) {
      window.location.href = redirectTo;
      return false;
    }
    return true;
  };

  const requireRole = (role: string) => {
    if (!AuthService.hasRole(role)) {
      window.location.href = '/403'; // Forbidden
      return false;
    }
    return true;
  };

  // Использование:
  if (isAdminConsole) {
    if (!requireAuth() || !requireRole('admin')) return;
    import('./pages/admin-console');
  }
  ```

#### 2.5. API Client Integration
- Обновить `frontend/src/lib/api-client.ts`:
  - Автоматическое добавление `Authorization: Bearer <token>` из localStorage
  - Перехват 401 Unauthorized → автоматический refresh token или редирект на /login
  - Перехват 403 Forbidden → показ сообщения "Access denied"

#### 2.6. Responsive Design & Breakpoints
- Реализовать responsive дизайн согласно `requirements/сценарии/требования.md` §4.4.7:
  - **XXS (≤480px)**: Вертикальный поток, крупные кнопки (48x48px min)
  - **XS (481-640px)**: Мобильные в горизонтальном режиме
  - **SM (641-768px)**: Tabs для подсказок, одна колонка
  - **MD (769-1024px)**: Двухколоночный layout (задание + подсказки)
  - **LG (1025-1199px)**: Рабочая область + боковая панель
  - **XL (≥1200px)**: Три колонки (меню тем, рабочая область, аналитика)
  - **VH (≤600px высота)**: Скрывать второстепенные блоки
- CSS Grid/Flexbox, mobile-first подход
- Поддержка touch-жестов для мобильных
- Горизонтальный scroll запрещен (overflow-x: hidden)

#### 2.7. PWA Offline Support
- Настроить Service Worker (`frontend/src/sw.ts`):
  - **Cache Strategy:**
    - Network First для API запросов
    - Cache First для статических ресурсов (CSS, JS, fonts, icons)
    - Stale-While-Revalidate для изображений
  - Offline fallback страница
  - Background Sync для сохранения прогресса при восстановлении сети
  - Версионирование Service Worker (skipWaiting баннер при обновлении)
- Обновить Web Manifest (`public/manifest.json`):
  - Иконки: 192x192, 512x512 (PNG)
  - `start_url: "/"`, `display: "standalone"`
  - `theme_color`, `background_color`
- Subresource Integrity (SRI):
  - Генерация SRI хешей при сборке (esbuild plugin)
  - Проверка целостности всех статических ресурсов в Service Worker
  - Блокировка загрузки при несовпадении хеша
- Cold start ≤2 сек на 4G

#### 2.8. Accessibility (WCAG 2.1 AA)
- Клавиатурная навигация:
  - Tab/Shift+Tab между элементами формы
  - Enter/Space для активации кнопок
  - Esc для закрытия модальных окон
  - Focus visible (outline для активного элемента)
- ARIA атрибуты:
  - `aria-label` для кнопок без текста (иконки)
  - `aria-live="polite"` для уведомлений
  - `role="alert"` для ошибок валидации
  - `aria-describedby` для подсказок к полям ввода
- Масштабируемый текст (до 200% без потери функционала)
- Контрастность текста ≥4.5:1 (проверка через axe-core)
- Озвучивание пояснений (опционально через Web Speech API)
- Alt-текст для всех изображений

#### 2.9. Additional Pages (Critical for MVP)

**`frontend/src/pages/student-home.ts`** - Главная страница для student роли:
- Список доступных тем/курсов (карточки с preview)
- Progress bar для каждой темы (% выполненных заданий)
- Блок "Последние достижения" (badges, баллы)
- Кнопка "Продолжить" для незавершенной сессии
- Фильтры: По сложности (легкий/средний/сложный), По статусу (новые/в процессе/завершенные)
- Endpoint: `GET /api/v1/student/courses`

**`frontend/src/pages/teacher-dashboard.ts`** - Дашборд для teacher роли:
- Список групп (только из `group_ids` JWT claim)
- Статистика по каждой группе:
  - Количество учеников
  - % выполненных заданий
  - Средний балл
  - Проблемные темы (успешность <60%)
- Кнопка экспорта отчета (CSV/PDF)
- Фильтры по периоду (7/30/90 дней)
- Детальная статистика ученика (drill-down)
- Endpoints:
  - `GET /api/v1/teacher/groups` - список групп учителя
  - `GET /api/v1/teacher/groups/{id}/stats?period=30d` - статистика группы
  - `GET /api/v1/teacher/groups/{id}/export?format=csv` - экспорт отчета

**`frontend/src/pages/user-profile.ts`** - Страница профиля:
- Просмотр информации: email, имя, роль, дата регистрации
- Редактирование имени (inline edit)
- Смена email (требует подтверждение на старый email)
- Кнопка "Сменить пароль" (модальное окно с change-password формой)
- Блок "Активные сессии":
  - Список устройств (IP, User-Agent, последний вход)
  - Endpoint: `GET /api/v1/auth/sessions`
  - Кнопка "Завершить сессию" для каждого устройства
  - Кнопка "Выйти из всех устройств кроме текущего"
- 2FA настройки (если включено):
  - QR-код для Google Authenticator
  - Backup коды (скачать)

**`frontend/src/pages/forbidden-403.ts`** - Страница "Доступ запрещен":
- Заголовок: "403 - Доступ запрещен"
- Сообщение: "У вас недостаточно прав для доступа к этой странице"
- Информация о текущей роли: "Ваша роль: {role}"
- Кнопка "Вернуться на главную" (редирект по роли)
- Логирование попытки несанкционированного доступа:
  - Endpoint: `POST /api/v1/audit/access-denied`
  - Payload: `{ url, user_id, role, timestamp }`

### 3. Безопасность и Production Deployment

#### 3.1. Superuser Bootstrap (production-ready)
- Обновить `scripts/generate_superuser_secret.py`:
  - Дополнительная валидация email
  - Автоматическая генерация 2FA secret (TOTP) для админов
  - Вывод QR-кода для настройки Google Authenticator

- Документация деплоя (`docs/deployment-security.md`):
  - Kubernetes Secrets для admin-superuser.json
  - AWS Secrets Manager / HashiCorp Vault integration
  - Автоматическая ротация пароля суперюзера (каждые 90 дней)
  - Checklist pre-production (JWT_SECRET уникальный, HTTPS включен, HSTS настроен)

#### 3.2. Environment Configuration
- Обновить `.env.example`:
  ```bash
  # JWT Configuration
  JWT_SECRET=<CHANGE_ME_openssl_rand_base64_32>
  JWT_ACCESS_TOKEN_TTL_SECONDS=3600          # 1 hour
  JWT_REFRESH_TOKEN_TTL_SECONDS=2592000      # 30 days

  # Session Security
  COOKIE_SECURE=true                          # Only over HTTPS
  COOKIE_SAME_SITE=Strict                     # CSRF protection

  # Rate Limiting
  RATE_LIMIT_LOGIN_ATTEMPTS=10                # per 5 minutes per IP
  RATE_LIMIT_REGISTER_ATTEMPTS=5              # per hour per IP

  # 2FA (optional for MVP)
  ENABLE_2FA_FOR_ADMINS=true
  ```

#### 3.3. Security Hardening
- CSRF Protection:
  - Добавить CSRF token middleware для state-changing operations
  - Проверка Origin/Referer headers

- XSS Protection:
  - CSP header: `default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'`
  - Sanitization user input в формах

- Brute Force Protection:
  - Redis-based rate limiter (существующая реализация `middlewares/rate_limit.rs`)
  - Exponential backoff после неудачных попыток
  - CAPTCHA после 3 неудачных логинов (опционально)

#### 3.4. Data Encryption

**MongoDB Encryption at Rest** (production, требование ФЗ-152):
- Алгоритм: AEAD-ChaCha20-Poly1305 или AES-256-GCM
- Ключи хранятся в HashiCorp Vault / AWS KMS / Azure Key Vault
- Автоматическая ротация ключей каждые 90 дней
- Конфигурация: `infra/config/mongodb-encryption.yaml`
- Документация: `docs/deployment-security.md` раздел "MongoDB Encryption"

**PII Fields Encryption** (Client-Side Field Level Encryption):
- Зашифрованные поля:
  - `users.email` - deterministic encryption (для индексов)
  - `users.name` - randomized encryption
  - `users.group_ids` - deterministic encryption
- MongoDB Client-Side Field Level Encryption (CSFLE)
- Индексы по хешам email для поиска
- Master Key в Vault, Data Encryption Keys (DEK) в MongoDB key vault collection

**Encryption in Transit**:
- TLS 1.3 для всех соединений (MongoDB, Redis, API)
- HSTS header: `max-age=31536000; includeSubDomains; preload`
- Certificate pinning для mobile apps (будущая фича)

#### 3.5. PWA Security Hardening

**Service Worker Integrity**:
- Подпись всех статических ресурсов (Subresource Integrity - SRI)
- Генерация SRI хешей при сборке:
  ```javascript
  // esbuild plugin: generate-sri-hashes.js
  import crypto from 'crypto';
  export function generateSRI(content) {
    const hash = crypto.createHash('sha384').update(content).digest('base64');
    return `sha384-${hash}`;
  }
  ```
- Проверка версии Service Worker при загрузке (skip outdated SW)
- Content Security Policy (CSP) header:
  ```
  default-src 'self';
  script-src 'self';
  style-src 'self' 'unsafe-inline'; /* для Web Components Shadow DOM */
  connect-src 'self' https://api.trainingground.ru;
  img-src 'self' data:;
  font-src 'self';
  frame-ancestors 'none';
  base-uri 'self';
  form-action 'self';
  ```

**Cache Poisoning Protection**:
- Версионирование Cache Storage (`cache-v1.2.3`, `cache-v1.2.4`)
- Автоматическая очистка старых кешей при обновлении SW:
  ```javascript
  self.addEventListener('activate', event => {
    event.waitUntil(
      caches.keys().then(keys => {
        return Promise.all(
          keys.filter(key => key !== CURRENT_CACHE)
            .map(key => caches.delete(key))
        );
      })
    );
  });
  ```
- HTTPS-only для всех запросов (upgrade-insecure-requests CSP directive)
- Integrity check для кеша (сверка ETag при revalidation)

### 4. Testing

#### 4.1. Backend Tests (Rust)
- `backend/rust-api/tests/auth_test.rs`:
  - Unit tests для password hashing (bcrypt)
  - Unit tests для JWT generation/validation
  - Integration tests для login flow (успех/неуспех)
  - Integration tests для refresh token rotation
  - Security tests (SQL injection, брутфорс)

#### 4.2. Frontend Tests
- `frontend/tests/e2e/auth.spec.ts` (Playwright):
  - E2E тест: регистрация → логин → доступ к защищенной странице
  - E2E тест: логин с неверным паролем → отображение ошибки
  - E2E тест: доступ к /admin без логина → редирект на /login
  - E2E тест: логин как админ → проверка доступа к admin console

#### 4.3. Security Tests
- Penetration testing checklist:
  - OWASP Top 10 compliance
  - SQL/NoSQL injection attempts
  - XSS attempts (reflected, stored)
  - CSRF token bypass attempts
  - Session hijacking tests
  - Brute force login tests

#### 4.4. Accessibility Tests
- `frontend/tests/a11y/accessibility.spec.ts` (axe-core):
  - Проверка контрастности цветов (WCAG AA ≥4.5:1)
  - Проверка ARIA атрибутов (`aria-label`, `aria-live`, `role`)
  - Проверка keyboard navigation (Tab, Enter, Esc работают корректно)
  - Проверка screen reader compatibility (NVDA, JAWS)
  - Проверка масштабирования текста (до 200% без overflow)
  - Проверка alt-текстов для изображений
  - Lighthouse Accessibility score ≥90

#### 4.5. Responsive Tests
- `frontend/tests/e2e/responsive.spec.ts` (Playwright):
  - E2E тест на всех breakpoints:
    - XXS (375x667) - iPhone SE
    - SM (768x1024) - iPad Portrait
    - MD (1024x768) - iPad Landscape
    - LG (1280x720) - Desktop
    - XL (1920x1080) - Full HD
  - Проверка touch-событий на мобильных (tap, swipe, pinch-zoom)
  - Проверка отсутствия horizontal scroll (overflow-x: hidden)
  - Проверка ориентации (portrait/landscape переключение)
  - Проверка viewport meta tag (`width=device-width, initial-scale=1`)
  - Screenshot regression tests для каждого breakpoint

#### 4.6. PWA Tests
- `frontend/tests/pwa/service-worker.spec.ts`:
  - Проверка регистрации Service Worker (navigator.serviceWorker.ready)
  - Проверка offline режима:
    - Network throttling: Offline
    - Проверка что страница загружается из cache
    - Проверка offline fallback для API запросов
  - Проверка cache strategies:
    - Network First для API (успешный запрос → обновление cache)
    - Cache First для статики (загрузка из cache, фоновое обновление)
  - Проверка обновления Service Worker:
    - skipWaiting при обновлении версии
    - Автоматическая очистка старых кешей
  - Проверка Web Manifest:
    - manifest.json загружается корректно
    - `display: "standalone"` применяется
  - Lighthouse PWA score ≥90:
    - Installability
    - Fast and reliable (offline работает)
    - PWA optimized
  - Проверка SRI (Subresource Integrity):
    - Все `<script>` и `<link>` теги имеют integrity атрибут
    - Загрузка блокируется при несовпадении хеша

### 5. UI/UX для всех ролей

#### 5.1. Student Role
- После логина → главная страница с доступными темами/уровнями
- Навигация: Мои курсы, Прогресс, Профиль
- Ограничения: не видит других учеников, статистику классов

#### 5.2. Teacher Role
- После логина → дашборд с группами учеников
- Навигация: Мои группы, Статистика, Отчеты, Профиль
- Доступ только к своим группам (проверка через `group_ids` в JWT)

#### 5.3. Admin Role
- После логина → админ-консоль (существующая `/admin`)
- Навигация: Шаблоны, Правила, Feature Flags, Пользователи, Аудит
- Полный доступ ко всем данным

#### 5.4. Unified Header Component
- Создать `frontend/src/components/app-header.ts`:
  - Логотип + название
  - Навигация (зависит от роли)
  - User menu (dropdown): Профиль, Настройки, Выход
  - Отображение текущей роли (badge)

### 6. Guest Access (Post-MVP)

**Источник:** `requirements/сценарии/требования.md` §4.2.1 (гостевой доступ)

#### 6.1. Backend - Guest Registration
- `POST /api/v1/auth/guest` — создание гостевого аккаунта:
  - Генерация уникального `guest_id` (UUID v4)
  - Роль: `guest` (ограниченный доступ)
  - TTL: 7 дней (автоматическое удаление через MongoDB TTL index)
  - Нет email, нет password
  - Генерация JWT с claims: `{ sub: guest_id, role: "guest", exp: 7d }`
  - Ограничения в middleware:
    - Нельзя сохранять прогресс в БД (только в localStorage)
    - Нет доступа к рейтингам
    - Нет групповых заданий
    - Нет экспорта отчетов

#### 6.2. Backend - Guest → Student Conversion
- `POST /api/v1/auth/guest/convert` — конвертация в полноценный аккаунт:
  - Параметры: `{ email, password, name }`
  - Валидация email (unique check)
  - Хеширование password (bcrypt)
  - Перенос временного прогресса:
    - Чтение прогресса из localStorage (фронтенд отправляет JSON)
    - Сохранение в MongoDB `user_progress` collection
  - Смена роли: `guest` → `student`
  - Обновление `user_id` в существующих сессиях
  - Возврат нового JWT с role=student

#### 6.3. Frontend - Guest Flow
- Кнопка "Попробовать без регистрации" на login page:
  - POST /api/v1/auth/guest
  - Сохранение JWT в localStorage
  - Редирект на `/` (student home)
- Persistent баннер для guest пользователей:
  - Текст: "Вы используете гостевой доступ. Прогресс НЕ сохраняется. Зарегистрируйтесь, чтобы сохранить результаты."
  - Кнопка "Зарегистрироваться" (открывает модал конвертации)
- Модал конвертации:
  - Форма: Email, Password, Confirm Password, Name
  - Чекбокс: "Перенести текущий прогресс в новый аккаунт"
  - POST /api/v1/auth/guest/convert с прогрессом из localStorage
- Автоматическое удаление гостевых аккаунтов:
  - Cron job (ежедневно в 03:00): удаление записей старше 7 дней
  - MongoDB TTL index на поле `created_at`

#### 6.4. Database Model
```rust
pub struct GuestUser {
    pub id: ObjectId,           // guest_id
    pub role: UserRole::Guest,
    pub created_at: DateTime,   // TTL index: expires after 7 days
    pub converted: bool,        // true если конвертирован в student
    pub converted_to: Option<ObjectId>, // user_id после конвертации
}
```

## Чек-лист готовности

### Backend
- [ ] POST /api/v1/auth/register endpoint (bcrypt, валидация)
- [ ] POST /api/v1/auth/login endpoint (JWT + refresh token)
- [ ] POST /api/v1/auth/refresh endpoint
- [ ] POST /api/v1/auth/logout endpoint
- [ ] GET /api/v1/auth/me endpoint (protected)
- [ ] GET /api/v1/users endpoint (admin only)
- [ ] PATCH /api/v1/users/:id endpoint (admin only)
- [ ] User model в MongoDB (email, password_hash, role, group_ids)
- [ ] RefreshToken model в MongoDB
- [ ] Rate limiting для login/register
- [ ] Failed auth monitoring (5 попыток → блокировка)
- [ ] Audit logging всех auth операций
- [ ] Integration tests для auth flow

### Frontend
- [ ] Login page компонент
- [ ] Register page компонент
- [ ] Auth state management (AuthService)
- [ ] Protected routes middleware
- [ ] API client auto-refresh token
- [ ] Unified header компонент (навигация по ролям)
- [ ] User menu dropdown (профиль, выход)
- [ ] **Student Home page** (темы/курсы, прогресс, достижения)
- [ ] **Teacher Dashboard page** (статистика групп, экспорт отчетов)
- [ ] **User Profile page** (настройки, смена пароля, активные сессии)
- [ ] **403 Forbidden page** (доступ запрещен)
- [ ] **Responsive design** (6 breakpoints: XXS-XL)
- [ ] **PWA offline support** (Service Worker, Cache Storage, SRI)
- [ ] **Accessibility (WCAG 2.1 AA)** (keyboard nav, ARIA, contrast ≥4.5:1)
- [ ] E2E тесты Playwright для auth flow
- [ ] **Accessibility tests** (axe-core, Lighthouse score ≥90)
- [ ] **Responsive tests** (screenshot regression на всех breakpoints)
- [ ] **PWA tests** (offline режим, Service Worker, Lighthouse PWA ≥90)

### Security
- [ ] JWT_SECRET уникальный для production
- [ ] HTTPS включен (TLS 1.3)
- [ ] HSTS header настроен (`max-age=31536000; includeSubDomains; preload`)
- [ ] CSRF protection middleware
- [ ] CSP headers настроены (включая `frame-ancestors 'none'`)
- [ ] Rate limiting работает
- [ ] Refresh tokens в HTTP-only cookies
- [ ] Bcrypt cost ≥ 12
- [ ] Логирование всех failed auth attempts
- [ ] **MongoDB Encryption at Rest** (AEAD-ChaCha20-Poly1305, ключи в Vault)
- [ ] **PII Fields Encryption** (Client-Side Field Level Encryption для email/name)
- [ ] **Subresource Integrity (SRI)** (хеши для всех статических ресурсов)
- [ ] **Cache Poisoning Protection** (версионирование Service Worker cache)
- [ ] 2FA для админов (опционально для MVP)

### Deployment
- [ ] Superuser bootstrap через Kubernetes Secrets / Vault
- [ ] Документация деплоя обновлена
- [ ] Environment variables настроены (.env.example)
- [ ] Pre-commit hook проверяет что JWT_SECRET не хардкоден
- [ ] Production checklist (docs/deployment-security.md)

### UI для всех ролей
- [ ] Student: главная с курсами/уровнями
- [ ] Teacher: дашборд с группами
- [ ] Admin: консоль управления (существует)
- [ ] Навигация адаптируется под роль
- [ ] 403 Forbidden page (доступ запрещен)

## Приоритеты

### MVP (Critical для запуска)
1. Login/Register endpoints (backend)
2. Login page (frontend)
3. Protected routes middleware
4. JWT auth в API client
5. Rate limiting + audit logging

### Post-MVP (можно отложить)
- 2FA для админов (TOTP)
- SSO интеграция (OAuth 2.0 / SAML)
- Password reset flow (email)
- Account verification (email confirmation)
- "Remember this device" (device fingerprinting)

## Ссылки на документацию

- **Требования:** `requirements/сценарии/требования.md` §4.2.1, §4.4.6
- **Роли:** `requirements/архитектура/описание AL.md` (AL-1, AL-2, AL-3)
- **Безопасность:** `docs/deployment-security.md`
- **Текущая реализация A6:** `tasks/A6.md`
- **Pre-commit hooks:** `.githooks/pre-commit-rust`

## Связанные задачи

- **A6 (Admin Console)** — блокируется TD-06, невозможно протестировать в боевом режиме
- **AL-1 (Student flow)** — требует авторизацию
- **AL-2 (Teacher dashboard)** — требует RBAC проверки group_ids
- **BL-1 (Session Manager)** — требует user_id из JWT

## Оценка

**MVP (Критические компоненты):**
- **Backend API:** 3-4 дня (8 endpoints + models + tests + teacher endpoints)
- **Frontend базовый:** 3 дня (login/register + auth service + routing)
- **Frontend дополнительные страницы:** 3 дня (student-home + teacher-dashboard + profile + 403)
- **Responsive design:** 2 дня (6 breakpoints, mobile-first CSS)
- **PWA offline:** 2 дня (Service Worker, Cache Storage, SRI)
- **Accessibility:** 1 день (WCAG 2.1 AA, ARIA, keyboard nav)
- **Security hardening:** 2 дня (rate limiting, CSRF, MongoDB encryption, SRI)
- **Testing:** 2 дня (unit, E2E, accessibility, responsive, PWA tests)
- **Documentation:** 1 день
- **ИТОГО MVP:** ~19-20 дней разработки

**Post-MVP (опционально):**
- **Guest Access:** 2 дня (backend + frontend + conversion flow)
- **2FA для админов:** 2 дня (TOTP + QR-код)
- **SSO (OAuth/SAML):** 3-5 дней (зависит от провайдера)
- **Password reset flow:** 2 дня (email + токены)
- **Email verification:** 1 день

**ИТОГО с Post-MVP:** ~29-32 дня

## Критерии приёмки

**Базовая авторизация:**
1. Пользователь может зарегистрироваться (email + password)
2. Пользователь может залогиниться и получить JWT токен
3. Токен автоматически добавляется ко всем API запросам
4. При истечении access token автоматически обновляется через refresh token
5. После 5 неудачных попыток логина аккаунт блокируется на 15 мин
6. Все auth операции логируются в audit_log

**Role-Based Access Control:**
7. Админ может зайти на `/admin` без ручного ввода токена
8. Ученик НЕ может зайти на `/admin` (показывается 403 Forbidden page)
9. Учитель видит ТОЛЬКО свои группы (проверка `group_ids` в JWT)
10. После логина редирект зависит от роли (student → `/`, teacher → `/dashboard`, admin → `/admin`)

**UI/UX для всех ролей:**
11. Student home page показывает доступные темы/курсы с прогрессом
12. Teacher dashboard показывает статистику групп и экспорт отчетов работает
13. User Profile page позволяет сменить пароль и просмотреть активные сессии
14. 403 Forbidden page логирует попытки несанкционированного доступа

**Responsive & PWA:**
15. Сайт корректно отображается на всех breakpoints (XXS 375px → XL 1920px)
16. PWA работает в offline режиме (Service Worker кеширует статику)
17. Lighthouse PWA score ≥90, Accessibility score ≥90
18. Cold start ≤2 сек на 4G

**Безопасность:**
19. MongoDB данные зашифрованы (AEAD-ChaCha20-Poly1305 в production)
20. Subresource Integrity (SRI) проверяет целостность всех статических ресурсов
21. CSP headers защищают от XSS атак
22. WCAG 2.1 AA соблюдён (контрастность ≥4.5:1, keyboard nav работает)

**Тестирование:**
23. E2E тесты проходят для всех ролей (student, teacher, admin)
24. Accessibility tests проходят (axe-core)
25. Responsive tests проходят на всех breakpoints (screenshot regression)
26. Security tests проходят (OWASP Top 10, брутфорс защита)

**Production:**
27. Production deployment документирован и протестирован
28. Superuser bootstrap работает через Kubernetes Secrets
29. HTTPS + HSTS настроены корректно

---

**Статус:** Не начат
**Приоритет:** P0 (критический)
**Блокирует:** A6, AL-1, AL-2, production запуск
