NOTE (2025-12-22): рабочий репозиторий включает каталоги frontend/, backend/rust-api/ и backend/python-generator/. Husky/lint-staged обслуживает фронтенд, .githooks запускают Rust и Python проверки, а docker-compose поднимает MongoDB, Redis, Qdrant, Rust API и Python Explanation API. Описание ниже оставлено для истории, актуальное состояние отражено в docs/dev-setup.md.
# A0 — Настройка окружения разработки и pre-commit хуков

## Контекст
Перед началом работы над задачами A1-A12 необходимо подготовить единое окружение разработки с автоматическими проверками качества кода. Эта задача обеспечивает, что каждый коммит проходит валидацию (линтеры, форматтеры, тесты, security audit) **автоматически**, блокируя commit при ошибках. Это критично для поддержания качества кода и предотвращения проблем в CI/CD.

## Состав работ

### 1. **Структура репозитория и конфигурации**
Создать базовую структуру согласно `requirements/структураПО/файловая структура проекта.md`:
```
TrainingGround/
├── .git/
├── .husky/                    # Git hooks через husky (для frontend)
├── .githooks/                 # Кастомные git hooks (для Rust/Python)
├── .editorconfig             # Единый стиль редактора
├── .gitignore                # Игнорируемые файлы
├── Makefile                  # Команды для разработки
├── docker-compose.yml        # Локальное окружение
├── docker-compose.test.yml   # Тестовое окружение
└── scripts/
    ├── setup-dev.sh          # Скрипт первоначальной настройки (Linux/macOS)
    ├── setup-dev.ps1         # Скрипт первоначальной настройки (Windows)
    ├── pre-commit.sh         # Единый pre-commit скрипт
    └── run-tests.sh          # Запуск всех тестов
```

### 2. **Pre-commit хуки (автоматические проверки)**

#### **2.1 Frontend (TypeScript/PWA)**
Использовать **husky** + **lint-staged** для автоматических проверок:

**Установка:**
```json
// frontend/package.json
{
  "devDependencies": {
    "husky": "^9.0.0",
    "lint-staged": "^15.0.0",
    "@typescript-eslint/eslint-plugin": "^7.0.0",
    "prettier": "^3.0.0",
    "vitest": "^1.0.0"
  },
  "scripts": {
    "prepare": "cd .. && husky install .husky",
    "lint": "eslint src --ext .ts,.js",
    "lint:fix": "eslint src --ext .ts,.js --fix",
    "format": "prettier --write \"src/**/*.{ts,js,css,html}\"",
    "format:check": "prettier --check \"src/**/*.{ts,js,css,html}\"",
    "type-check": "tsc --noEmit",
    "test": "vitest run",
    "test:watch": "vitest",
    "test:coverage": "vitest run --coverage"
  },
  "lint-staged": {
    "*.{ts,js}": [
      "eslint --fix",
      "prettier --write",
      "vitest related --run"
    ],
    "*.{css,html,md}": [
      "prettier --write"
    ]
  }
}
```

**Файл `.husky/pre-commit`:**
```bash
#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "[INFO] Running pre-commit checks for Frontend..."

cd frontend

# 1. Lint и форматирование
npm run lint || exit 1
npm run format:check || exit 1

# 2. TypeScript проверка
npm run type-check || exit 1

# 3. Unit тесты измененных файлов
npx lint-staged || exit 1

# 4. Security audit
npm audit --audit-level=moderate || exit 1

echo "[SUCCESS] Frontend checks passed!"
```

#### **2.2 Rust API**
Создать `.githooks/pre-commit-rust`:

```bash
#!/bin/bash
set -e

echo "[INFO] Running pre-commit checks for Rust..."

cd backend/rust-api

# 1. Форматирование
echo "Checking Rust formatting..."
cargo fmt --check || {
  echo "[ERROR] Rust formatting failed. Run: cargo fmt"
  exit 1
}

# 2. Clippy (линтер)
echo "Running Clippy..."
cargo clippy --all-targets --all-features -- -D warnings || {
  echo "[ERROR] Clippy warnings found. Fix them before commit."
  exit 1
}

# 3. Unit тесты
echo "Running Rust tests..."
cargo test --lib || {
  echo "[ERROR] Tests failed!"
  exit 1
}

# 4. Security audit
echo "Running cargo audit..."
cargo audit || {
  echo "[WARNING] Security vulnerabilities found!"
  exit 1
}

echo "[SUCCESS] Rust checks passed!"
```

#### **2.3 Python сервис**
Создать `.githooks/pre-commit-python`:

```bash
#!/bin/bash
set -e

echo "[INFO] Running pre-commit checks for Python..."

cd backend/python-generator

# 1. Форматирование (black)
echo "Checking Python formatting..."
black --check src/ tests/ || {
  echo "[ERROR] Python formatting failed. Run: black src/ tests/"
  exit 1
}

# 2. Линтер (ruff)
echo "Running Ruff..."
ruff check src/ tests/ || {
  echo "[ERROR] Linting errors found!"
  exit 1
}

# 3. Type checking (mypy)
echo "Running mypy..."
mypy src/ || {
  echo "[ERROR] Type checking failed!"
  exit 1
}

# 4. Unit тесты
echo "Running Python tests..."
pytest tests/unit/ --tb=short || {
  echo "[ERROR] Tests failed!"
  exit 1
}

# 5. Security audit
echo "Running pip-audit..."
pip-audit || {
  echo "[WARNING] Security vulnerabilities found!"
  exit 1
}

echo "[SUCCESS] Python checks passed!"
```

### 3. **Единый pre-commit orchestrator**

Создать `scripts/pre-commit.sh` (главный скрипт):

```bash
#!/bin/bash
set -e

echo "================================"
echo "Pre-commit validation started"
echo "================================"

# Определить измененные компоненты
CHANGED_FILES=$(git diff --cached --name-only)

RUN_FRONTEND=false
RUN_RUST=false
RUN_PYTHON=false

if echo "$CHANGED_FILES" | grep -q "^frontend/"; then
  RUN_FRONTEND=true
fi

if echo "$CHANGED_FILES" | grep -q "^backend/rust-api/"; then
  RUN_RUST=true
fi

if echo "$CHANGED_FILES" | grep -q "^backend/python-generator/"; then
  RUN_PYTHON=true
fi

# Запуск проверок для измененных компонентов
if [ "$RUN_FRONTEND" = true ]; then
  .githooks/pre-commit-frontend || exit 1
fi

if [ "$RUN_RUST" = true ]; then
  .githooks/pre-commit-rust || exit 1
fi

if [ "$RUN_PYTHON" = true ]; then
  .githooks/pre-commit-python || exit 1
fi

# Если изменений нет или они только в документации
if [ "$RUN_FRONTEND" = false ] && [ "$RUN_RUST" = false ] && [ "$RUN_PYTHON" = false ]; then
  echo "[INFO] No code changes detected, skipping checks"
fi

echo "================================"
echo "All pre-commit checks passed!"
echo "================================"
```

### 4. **Makefile для удобных команд**

```makefile
# Makefile
.PHONY: setup dev-setup test lint format audit pre-commit

# Первоначальная настройка окружения
setup:
	@echo "Setting up development environment..."
	chmod +x scripts/*.sh
	./scripts/setup-dev.sh

# Установка зависимостей
dev-setup:
	cd frontend && npm install
	cd backend/rust-api && cargo build
	cd backend/python-generator && pip install -e ".[dev]"

# Запуск всех тестов
test:
	@echo "Running all tests..."
	cd frontend && npm test
	cd backend/rust-api && cargo test
	cd backend/python-generator && pytest

# Линтинг всех компонентов
lint:
	@echo "Running linters..."
	cd frontend && npm run lint
	cd backend/rust-api && cargo clippy -- -D warnings
	cd backend/python-generator && ruff check src/ tests/

# Форматирование кода
format:
	@echo "Formatting code..."
	cd frontend && npm run format
	cd backend/rust-api && cargo fmt
	cd backend/python-generator && black src/ tests/

# Security audit
audit:
	@echo "Running security audits..."
	cd frontend && npm audit
	cd backend/rust-api && cargo audit
	cd backend/python-generator && pip-audit

# Ручной запуск pre-commit проверок
pre-commit:
	./scripts/pre-commit.sh

# Запуск локального окружения
up:
	docker-compose up -d

# Остановка локального окружения
down:
	docker-compose down

# Логи сервисов
logs:
	docker-compose logs -f
```

### 5. **Скрипт первоначальной настройки**

**`scripts/setup-dev.sh`:**
```bash
#!/bin/bash
set -e

echo "Setting up development environment..."

# 1. Установка git hooks
echo "Installing git hooks..."
git config core.hooksPath .githooks
chmod +x .githooks/*

# 2. Проверка зависимостей
echo "Checking dependencies..."

# Node.js
if ! command -v node &> /dev/null; then
    echo "[ERROR] Node.js not found. Please install Node.js 20+"
    exit 1
fi

# Rust
if ! command -v cargo &> /dev/null; then
    echo "[ERROR] Rust not found. Install from: https://rustup.rs/"
    exit 1
fi

# Python
if ! command -v python3 &> /dev/null; then
    echo "[ERROR] Python 3.14+ not found"
    exit 1
fi

# Docker
if ! command -v docker &> /dev/null; then
    echo "[ERROR] Docker not found. Install Docker Desktop"
    exit 1
fi

# 3. Установка зависимостей
echo "Installing dependencies..."
make dev-setup

# 4. Установка pre-commit tools
echo "Installing pre-commit tools..."
cd frontend && npm install husky lint-staged --save-dev
cd ../backend/python-generator && pip install black ruff mypy pytest pip-audit
cd ../rust-api && cargo install cargo-audit

# 5. Создание .env файлов
if [ ! -f ".env" ]; then
    echo "Creating .env file..."
    cp .env.example .env
fi

echo "[SUCCESS] Development environment ready!"
echo ""
echo "Next steps:"
echo "  1. Configure .env with your settings"
echo "  2. Run 'make up' to start local services"
echo "  3. Start coding! Pre-commit hooks will run automatically"
```

**`scripts/setup-dev.ps1`** (для Windows):
```powershell
# PowerShell script для Windows
Write-Host "Setting up development environment..." -ForegroundColor Green

# Проверка зависимостей
if (-not (Get-Command node -ErrorAction SilentlyContinue)) {
    Write-Host "[ERROR] Node.js not found" -ForegroundColor Red
    exit 1
}

if (-not (Get-Command cargo -ErrorAction SilentlyContinue)) {
    Write-Host "[ERROR] Rust not found. Install from: https://rustup.rs/" -ForegroundColor Red
    exit 1
}

if (-not (Get-Command python -ErrorAction SilentlyContinue)) {
    Write-Host "[ERROR] Python not found" -ForegroundColor Red
    exit 1
}

if (-not (Get-Command docker -ErrorAction SilentlyContinue)) {
    Write-Host "[ERROR] Docker not found" -ForegroundColor Red
    exit 1
}

# Установка git hooks
Write-Host "Installing git hooks..." -ForegroundColor Yellow
git config core.hooksPath .githooks

# Установка зависимостей
Write-Host "Installing dependencies..." -ForegroundColor Yellow
Set-Location frontend
npm install
Set-Location ..\backend\rust-api
cargo build
Set-Location ..\python-generator
pip install -e ".[dev]"
Set-Location ..\..

# Создание .env
if (-not (Test-Path ".env")) {
    Write-Host "Creating .env file..." -ForegroundColor Yellow
    Copy-Item ".env.example" ".env"
}

Write-Host "[SUCCESS] Development environment ready!" -ForegroundColor Green
Write-Host ""
Write-Host "Next steps:"
Write-Host "  1. Configure .env with your settings"
Write-Host "  2. Run 'docker-compose up -d' to start local services"
Write-Host "  3. Start coding! Pre-commit hooks will run automatically"
```

### 6. **EditorConfig для единого стиля**

**`.editorconfig`:**
```ini
root = true

[*]
charset = utf-8
end_of_line = lf
insert_final_newline = true
trim_trailing_whitespace = true

[*.{ts,js}]
indent_style = space
indent_size = 2

[*.rs]
indent_style = space
indent_size = 4

[*.py]
indent_style = space
indent_size = 4

[*.{md,yml,yaml}]
trim_trailing_whitespace = false

[Makefile]
indent_style = tab
```

### 7. **CI/CD интеграция**

Создать `.gitlab-ci.yml` или `yandex-ci.yml`:

```yaml
# .gitlab-ci.yml
stages:
  - validate
  - test
  - build

# Проверки идентичны pre-commit хукам
validate:lint:
  stage: validate
  script:
    - make lint
  allow_failure: false

validate:audit:
  stage: validate
  script:
    - make audit
  allow_failure: false

test:unit:
  stage: test
  script:
    - make test
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
```

### 8. **Документация для разработчиков**

Обновить `docs/dev-setup.md`:

```markdown
# Настройка окружения разработки

## Первоначальная настройка

1. Клонировать репозиторий:
   ```bash
   git clone <repo-url>
   cd TrainingGround
   ```

2. Запустить скрипт настройки:
   ```bash
   # Linux/macOS
   ./scripts/setup-dev.sh
   
   # Windows
   powershell -ExecutionPolicy Bypass -File scripts/setup-dev.ps1
   ```

3. Настроить `.env`:
   ```bash
   cp .env.example .env
   # Отредактировать параметры
   ```

4. Запустить локальное окружение:
   ```bash
   make up
   ```

## Pre-commit проверки

Pre-commit хуки запускаются **автоматически** при каждом `git commit`:

1. **Линтеры** — проверка стиля кода
2. **Форматтеры** — проверка форматирования
3. **Type checkers** — проверка типов
4. **Unit тесты** — измененные файлы
5. **Security audit** — проверка уязвимостей

### Если commit заблокирован:

```bash
# Исправить проблемы автоматически
make format

# Запустить проверки вручную
make pre-commit

# После исправления - коммитить снова
git commit
```

## Полезные команды

```bash
make test          # Все тесты
make lint          # Все линтеры
make format        # Форматирование
make audit         # Security audit
make up            # Запуск окружения
make logs          # Логи сервисов
```
```

## Ожидаемые артефакты
- Настроенные git hooks (`.husky/`, `.githooks/`)
- Скрипты автоматизации (`scripts/`)
- Makefile с командами разработки
- Документация для новых разработчиков
- CI/CD конфигурация с идентичными проверками

## Чек-лист готовности
- [x] Git hooks установлены (`.husky/`, `.githooks/`)
- [x] Pre-commit скрипты созданы (frontend, rust, python)
- [x] Makefile команды работают на всех ОС (Windows/Linux/macOS)
- [x] EditorConfig настроен для единого стиля
- [x] Скрипты setup-dev созданы (sh и ps1)
- [x] Docker Compose конфигурация создана (dev и test)
- [x] CI/CD конфигурация (.gitlab-ci.yml)
- [x] Документация создана (docs/dev-setup.md)
- [x] Git repository инициализирован
- [x] Git hooks path настроен (`git config core.hooksPath .githooks`)
- [x] Setup script выполнен успешно
- [x] Pre-commit проверки готовы к тестированию (скрипты созданы, будут активны при появлении кода A2-A4)
- [x] CI/CD конфигурация готова (`.gitlab-ci.yml` создан, активируется при подключении GitLab/Yandex Cloud)

## Тестирование
- **Setup:** запуск `setup-dev.sh` на чистой системе (Windows, Linux, macOS)
- **Pre-commit:** создать тестовый commit с ошибками — убедиться, что блокируется
- **Makefile:** проверить все команды (`make test`, `make lint`, etc.)
- **CI/CD:** push в feature branch — проверить, что пайплайн повторяет локальные проверки
- **Documentation:** новый разработчик должен настроить окружение по документации за ≤10 минут

---

## Порядок выполнения

**A0 должна быть выполнена ПЕРВОЙ**, до начала работы над A1-A12!

После выполнения A0 разработчики смогут:
1. Быстро настроить окружение (`make setup`)
2. Автоматически проверять код перед commit
3. Быть уверенными, что код пройдет CI/CD
4. Работать в едином стиле команды
