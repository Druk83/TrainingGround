# A6-04 — UI Администратора контента (доработка)

## Контекст
Согласно `requirements/предметная область.md`, Администратор контента отвечает за управление шаблонами заданий, темами, уровнями и правилами русского языка. Базовый UI уже реализован в `frontend/src/pages/admin-console.ts`, но требуется доработка для полного соответствия требованиям.

**Отличие от Суперпользователя:** Администратор контента управляет КОНТЕНТОМ (шаблонами, темами, правилами), а Суперпользователь управляет СИСТЕМОЙ (пользователями, настройками, безопасностью).

## Состав работ

### 1. Анализ существующей реализации
**Файл:** `frontend/src/pages/admin-console.ts`

**Что уже есть:**
- Таблица шаблонов (templates) с фильтрами
- Публикация/откат шаблонов (publish/revert)
- Мониторинг очереди эмбеддингов (content:changes)
- Feature Flags управление

**Что требуется доработать:**
- Создание и редактирование шаблонов
- Управление темами (topics) и уровнями (levels)
- Управление правилами русского языка (rules)
- Модерация контента (двойное ревью)
- Версионность шаблонов
- Инициирование пересоздания эмбеддингов
- Мониторинг качества контента

### 2. Доработка раздела "Шаблоны заданий"
**Файл:** `frontend/src/components/template-management.ts` (новый)

**Функции:**

**2.1. Создание шаблона:**
- Кнопка "Создать шаблон"
- Модальная форма:
  - Slug (уникальный идентификатор, латиница + дефис)
  - Название (на русском)
  - Тема (выбор из списка topics)
  - Уровень (выбор из списка levels)
  - Сложность (A1, A2, B1, B2)
  - Тип задания (MCQ, Text Input, True/False)
  - Текст задания (с поддержкой параметров {word:noun:genitive})
  - Правильный ответ
  - Варианты ответа (для MCQ)
  - Правило (ref: rules, выбор из списка)
  - Шаблон подсказки (с параметрами)
  - Шаблон объяснения (с параметрами)
  - Источники (source_refs)
  - PII flags (чекбоксы: email, phone, name)

- Валидация:
  - Проверка уникальности slug
  - Проверка корректности параметров в шаблоне
  - Проверка наличия правильного ответа

**2.2. Редактирование шаблона:**
- Клик на шаблон в таблице → открывается та же форма с заполненными данными
- При сохранении создаётся новая версия (version++)
- Статус возвращается в 'draft' (требует повторной модерации)

**2.3. Версионность:**
- Кнопка "История версий" для каждого шаблона
- Модальное окно со списком версий:
  - Версия (номер)
  - Дата изменения
  - Автор (кто создал версию)
  - Изменения (diff с предыдущей версией)
  - Кнопка "Восстановить эту версию" (revert)

**2.4. Модерация (двойное ревью):**
- Workflow:
  1. Автор создаёт шаблон → статус 'draft'
  2. Автор нажимает "Отправить на модерацию" → статус 'pending_review'
  3. Модератор 1 проверяет → статус 'reviewed_once'
  4. Модератор 2 проверяет → статус 'ready'
  5. Администратор публикует → статус 'published'

- UI для модерации:
  - Фильтр "Требуют модерации" (pending_review, reviewed_once)
  - Кнопка "Одобрить" (добавляет reviewer_id)
  - Кнопка "Отклонить" (с указанием причины)
  - Показ истории ревью (кто и когда одобрил)

### 3. Раздел "Темы и уровни"
**Компонент:** `frontend/src/components/topics-management.ts` (новый)

**Функции:**

**3.1. Управление темами (topics):**
- Таблица тем:
  - Колонки: Slug, Название, Описание, Количество уровней, Статус, Дата создания
  - Поиск по slug, названию
  - Фильтр по статусу (active, deprecated)

- Создание темы:
  - Форма:
    - Slug (латиница, уникальный)
    - Название (например, "Орфография")
    - Описание (краткое описание темы)
    - Иконка (URL или загрузка файла)
    - Порядок сортировки (number)

- Редактирование темы:
  - Та же форма с заполненными данными
  - Кнопка "Деактивировать" (статус → deprecated)

**3.2. Управление уровнями (levels):**
- Вложенная таблица уровней (при раскрытии темы):
  - Колонки: Номер, Название, Сложность, Количество шаблонов, Статус

- Создание уровня:
  - Форма:
    - Тема (parent topic)
    - Номер уровня (1, 2, 3...)
    - Название (например, "Уровень 1: Безударные гласные")
    - Сложность (A1, A2, B1, B2)
    - Описание
    - Минимальный процент для прохождения (по умолчанию 80%)

- Редактирование уровня:
  - Изменение названия, описания
  - Изменение минимального процента
  - Переупорядочивание (drag-and-drop или кнопки ↑↓)

### 4. Раздел "Правила русского языка"
**Компонент:** `frontend/src/components/rules-management.ts` (новый)

**Функции:**

**4.1. Таблица правил:**
- Колонки: ID правила, Название, Категория, Связанных шаблонов, Статус

- Фильтры:
  - По категории (орфография, пунктуация, синтаксис, морфология)
  - По наличию связанных шаблонов

**4.2. Создание правила:**
- Форма:
  - Название (краткое)
  - Категория (выбор)
  - Полное описание (Markdown поддержка)
  - Примеры использования (список)
  - Исключения из правила
  - Ссылки на источники (учебники, справочники)

- Предпросмотр (Markdown → HTML)

**4.3. Редактирование правила:**
- Та же форма
- Показ связанных шаблонов (ссылки на шаблоны)

**4.4. Проверка покрытия:**
- Виджет "Покрытие правил":
  - Количество правил с 0 шаблонами (требуют создания заданий)
  - Количество правил с 1-5 шаблонами (требуют расширения)
  - Количество правил с ≥10 шаблонами (достаточно)

### 5. Раздел "Мониторинг качества"
**Компонент:** `frontend/src/components/content-quality.ts` (новый)

**Функции:**

**5.1. Dashboard качества:**
- Метрики:
  - Общее количество шаблонов
  - Опубликованных шаблонов
  - Шаблонов в draft
  - Шаблонов, требующих модерации

- Проблемы качества:
  - Шаблоны с отсутствующими правилами
  - Шаблоны с невалидными параметрами
  - Темы без шаблонов
  - Уровни с <5 шаблонами

**5.2. Валидация шаблонов:**
- Кнопка "Проверить все шаблоны"
- Запуск валидатора:
  - Проверка синтаксиса параметров ({word:noun:genitive})
  - Проверка наличия правил
  - Проверка корректности вариантов ответа (MCQ)
  - Проверка уникальности slug

- Результаты:
  - Таблица проблемных шаблонов
  - Тип ошибки
  - Кнопка "Исправить"

**5.3. Проверка конфликтов:**
- Обнаружение дублирующихся шаблонов:
  - По тексту задания (схожесть >80%)
  - По правилу + уровень

- Таблица потенциальных дубликатов:
  - Шаблон 1 vs Шаблон 2
  - Процент схожести
  - Действия: "Объединить", "Отметить как уникальные"

### 6. Раздел "Эмбеддинги и индексация"
**Компонент:** `frontend/src/components/embeddings-monitor.ts` (новый)

**Функции:**

**6.1. Статус очереди (уже есть, доработать):**
- Отображение длины очереди `content:changes`
- Последнее событие (action, template_id, timestamp)
- Средняя скорость обработки (events/min)

**6.2. Инициирование пересоздания эмбеддингов:**
- Кнопка "Пересоздать все эмбеддинги"
- Модальное окно с подтверждением:
  - Предупреждение: "Это может занять до 15 минут на 1000 шаблонов"
  - Опции:
    - Только новые шаблоны (created_at > last_rebuild)
    - Только изменённые (updated_at > last_rebuild)
    - Все шаблоны (полная перестройка)
  - Кнопка "Запустить"

- Прогресс-бар:
  - Обработано X из Y шаблонов
  - Прогресс в процентах
  - ETA (расчётное время завершения)

**6.3. Мониторинг Qdrant:**
- Статус коллекций:
  - Название коллекции (templates, rules, examples)
  - Количество векторов
  - Размер индекса (MB)
  - Последнее обновление

- Кнопка "Проверить консистентность"
  - Сравнение количества шаблонов в MongoDB vs Qdrant
  - Список несоответствий (шаблоны без векторов)

### 7. Навигация
**Обновить:** `frontend/src/pages/admin-console.ts` (рефакторинг на табы/разделы)

**Структура:**
```
/admin                                - Dashboard (главная)
  - Вкладка "Шаблоны"                 - Таблица шаблонов (текущая)
  - Вкладка "Темы и уровни"           - Управление topics/levels
  - Вкладка "Правила"                 - Управление rules
  - Вкладка "Качество"                - Мониторинг качества
  - Вкладка "Эмбеддинги"              - Мониторинг очереди и Qdrant
  - Вкладка "Feature Flags"           - Управление флагами (текущая)

/admin/templates/:id                  - Редактирование шаблона
/admin/topics/:id                     - Редактирование темы
/admin/rules/:id                      - Редактирование правила
```

## API Endpoints (Rust API)

### Шаблоны (расширение существующих)
```
POST   /admin/templates                - Создать шаблон
PUT    /admin/templates/:id            - Обновить шаблон (создаёт новую версию)
DELETE /admin/templates/:id            - Удалить шаблон (soft delete)
GET    /admin/templates/:id/versions   - История версий
POST   /admin/templates/:id/submit     - Отправить на модерацию
POST   /admin/templates/:id/approve    - Одобрить (модератор)
POST   /admin/templates/:id/reject     - Отклонить (модератор)
POST   /admin/templates/validate       - Валидация всех шаблонов
```

### Темы и уровни
```
GET    /admin/topics                   - Список тем
POST   /admin/topics                   - Создать тему
PUT    /admin/topics/:id               - Обновить тему
DELETE /admin/topics/:id               - Удалить тему (soft delete)

GET    /admin/topics/:id/levels        - Уровни темы
POST   /admin/levels                   - Создать уровень
PUT    /admin/levels/:id               - Обновить уровень
DELETE /admin/levels/:id               - Удалить уровень
POST   /admin/levels/:id/reorder       - Переупорядочить уровни
```

### Правила
```
GET    /admin/rules                    - Список правил
POST   /admin/rules                    - Создать правило
PUT    /admin/rules/:id                - Обновить правило
DELETE /admin/rules/:id                - Удалить правило
GET    /admin/rules/:id/templates      - Связанные шаблоны
GET    /admin/rules/coverage           - Статистика покрытия
```

### Качество
```
GET    /admin/quality/metrics          - Метрики качества
POST   /admin/quality/validate         - Запустить валидацию
GET    /admin/quality/duplicates       - Найти дубликаты
POST   /admin/quality/merge            - Объединить дубликаты
```

### Эмбеддинги
```
POST   /admin/embeddings/rebuild       - Пересоздать эмбеддинги
GET    /admin/embeddings/progress      - Прогресс пересоздания
GET    /admin/embeddings/consistency   - Проверка консистентности MongoDB ↔ Qdrant
```

## Модели данных (MongoDB)

### templates (расширение существующей коллекции)
```javascript
{
  _id: ObjectId,
  slug: String,                 // уникальный
  name: String,
  topic_id: ObjectId,           // ref: topics
  level_id: ObjectId,           // ref: levels
  difficulty: String,           // 'A1', 'A2', 'B1', 'B2'
  type: String,                 // 'mcq', 'text_input', 'true_false'
  question_text: String,        // с параметрами {word:noun:genitive}
  correct_answer: String,
  options: [String],            // для MCQ
  rule_id: ObjectId,            // ref: rules
  hint_template: String,
  explanation_template: String,
  source_refs: [String],
  pii_flags: [String],
  status: String,               // 'draft', 'pending_review', 'reviewed_once', 'ready', 'published', 'deprecated'
  version: Number,
  reviewers: [ObjectId],        // ref: users (кто одобрил)
  created_by: ObjectId,         // ref: users
  created_at: Date,
  updated_at: Date,
  published_at: Date,
}
```

### topics (новая коллекция)
```javascript
{
  _id: ObjectId,
  slug: String,                 // уникальный, например 'orthography'
  name: String,                 // "Орфография"
  description: String,
  icon_url: String,
  sort_order: Number,
  status: String,               // 'active', 'deprecated'
  created_at: Date,
  updated_at: Date,
}
```

### levels (новая коллекция)
```javascript
{
  _id: ObjectId,
  topic_id: ObjectId,           // ref: topics
  number: Number,               // порядковый номер уровня (1, 2, 3...)
  name: String,                 // "Уровень 1: Безударные гласные"
  difficulty: String,           // 'A1', 'A2', 'B1', 'B2'
  description: String,
  min_pass_percent: Number,     // минимальный процент для прохождения (по умолчанию 80)
  sort_order: Number,
  status: String,               // 'active', 'deprecated'
  created_at: Date,
  updated_at: Date,
}
```

### rules (новая коллекция)
```javascript
{
  _id: ObjectId,
  name: String,                 // краткое название
  category: String,             // 'orthography', 'punctuation', 'syntax', 'morphology'
  description: String,          // полное описание (Markdown)
  examples: [String],
  exceptions: [String],
  sources: [String],            // ссылки на учебники
  created_at: Date,
  updated_at: Date,
}
```

### template_versions (новая коллекция)
```javascript
{
  _id: ObjectId,
  template_id: ObjectId,        // ref: templates
  version: Number,
  changes: Object,              // diff с предыдущей версией
  created_by: ObjectId,         // ref: users
  created_at: Date,
}
```

## Ожидаемые артефакты

### Frontend
- `frontend/src/pages/admin-console.ts` - рефакторинг на табы
- `frontend/src/components/template-management.ts` - CRUD шаблонов
- `frontend/src/components/topics-management.ts` - управление темами/уровнями
- `frontend/src/components/rules-management.ts` - управление правилами
- `frontend/src/components/content-quality.ts` - мониторинг качества
- `frontend/src/components/embeddings-monitor.ts` - мониторинг эмбеддингов
- `frontend/src/components/template-form.ts` - форма создания/редактирования шаблона
- `frontend/src/components/template-version-history.ts` - история версий
- `frontend/src/lib/admin-api.ts` - обновление API клиента

### Backend (Rust API)
- `backend/rust-api/src/handlers/admin/templates.rs` - расширение хендлеров
- `backend/rust-api/src/handlers/admin/topics.rs` - хендлеры тем
- `backend/rust-api/src/handlers/admin/levels.rs` - хендлеры уровней
- `backend/rust-api/src/handlers/admin/rules.rs` - хендлеры правил
- `backend/rust-api/src/handlers/admin/quality.rs` - хендлеры качества
- `backend/rust-api/src/handlers/admin/embeddings.rs` - хендлеры эмбеддингов
- `backend/rust-api/src/services/template_validator.rs` - валидатор шаблонов
- `backend/rust-api/src/services/duplicate_detector.rs` - детектор дубликатов
- `backend/rust-api/src/models/topic.rs` - модель темы
- `backend/rust-api/src/models/level.rs` - модель уровня
- `backend/rust-api/src/models/rule.rs` - модель правила

### Тесты
- `frontend/src/__tests__/template-form.test.ts` - тесты формы шаблона
- `backend/rust-api/tests/integration/admin_templates.rs` - тесты CRUD шаблонов
- `backend/rust-api/tests/integration/template_validator.rs` - тесты валидатора

### Документация
- `docs/content-admin-guide.md` - руководство для администратора контента
- `docs/template-syntax.md` - синтаксис параметров в шаблонах
- `docs/moderation-workflow.md` - процесс модерации контента

## Чек-лист готовности

### Backend API
- [x] CRUD endpoints для шаблонов реализованы
- [x] Версионность шаблонов работает (создание новой версии при update)
- [x] Workflow модерации реализован (pending_review → reviewed_once → ready)
- [x] CRUD endpoints для тем и уровней работают
- [x] CRUD endpoints для правил работают
- [x] Валидатор шаблонов проверяет синтаксис параметров
- [x] Детектор дубликатов находит схожие шаблоны
- [x] Endpoint пересоздания эмбеддингов работает
- [x] Endpoint проверки консистентности MongoDB ↔ Qdrant работает
- [x] RBAC проверяет роль 'content_admin'

### Frontend UI
- [x] Форма создания шаблона работает с валидацией
- [x] Форма редактирования шаблона создаёт новую версию
- [x] История версий отображается с diff
- [x] Workflow модерации отображается (кнопки "Одобрить"/"Отклонить")
- [x] Таблица тем отображается с CRUD операциями
- [x] Таблица уровней (вложенная) работает
- [x] Переупорядочивание уровней работает (drag-and-drop или кнопки)
- [x] Таблица правил отображается с CRUD операциями
- [x] Markdown редактор для правил работает с предпросмотром
- [x] Dashboard качества показывает метрики
- [x] Валидация шаблонов запускается и показывает результаты
- [x] Детектор дубликатов находит схожие шаблоны
- [x] Мониторинг эмбеддингов показывает прогресс
- [x] Пересоздание эмбеддингов работает с прогресс-баром

- [x] Slug уникальный (проверка при создании)
- [x] Параметры в шаблонах валидируются ({word:noun:genitive})
- [x] Модерация требует двух одобрений (двойное ревью)
- [x] Версии сохраняются при каждом update
- [x] Diff показывает изменения между версиями
- [x] Темы можно деактивировать (статус deprecated)
- [x] Уровни можно переупорядочить
- [x] Правила связываются с шаблонами
- [x] Покрытие правил рассчитывается корректно
- [x] Дубликаты находятся по схожести текста (>80%)
- [x] Пересоздание эмбеддингов работает для выбранных шаблонов
- [x] Консистентность MongoDB ↔ Qdrant проверяется

### Тестирование
- [x] Unit-тесты frontend компонентов (template-form.test.ts - 18 тестов)
- [x] Unit-тесты management компонента (template-management.test.ts - 22 теста)
- [x] Integration-тесты CRUD шаблонов (admin_templates_tests.rs - 9 тестов)
- [x] Integration-тесты Topics/Levels (admin_topics_levels_tests.rs - 17 тестов)
- [x] Integration-тесты Rules (admin_rules_tests.rs - 14 тестов)
- [x] E2E тесты основных сценариев (admin-console.spec.ts - 14 тестов)
- [x] Общее количество тестов: 94
- [x] Документация по тестирования (A6-04-TESTING.md)

### Документация
- [x] Руководство для администратора контента создано
- [x] Синтаксис параметров задокументирован
- [x] Процесс модерации описан
- [x] Полная документация по тестам создана (A6-04-TESTING.md)
- [x] README с инструкциями по запуску тестов (TESTS-A6-04.md)

## Тестирование

### E2E тесты (Playwright)
**Сценарий 1: Создание и модерация шаблона**
1. Логин как content_admin
2. Переход на /admin (вкладка "Шаблоны")
3. Клик "Создать шаблон"
4. Заполнение формы (slug, название, тема, тип, текст)
5. Сохранение → проверка статуса 'draft'
6. Клик "Отправить на модерацию" → статус 'pending_review'
7. Логин как модератор 1
8. Клик "Одобрить" → статус 'reviewed_once'
9. Логин как модератор 2
10. Клик "Одобрить" → статус 'ready'
11. Логин как content_admin
12. Клик "Опубликовать" → статус 'published'

**Сценарий 2: Редактирование и версионность**
1. Клик на существующий шаблон
2. Изменение текста задания
3. Сохранение → проверка создания версии 2
4. Клик "История версий"
5. Проверка отображения обеих версий
6. Клик "Восстановить версию 1"
7. Проверка возврата к версии 1

**Сценарий 3: Создание темы и уровня**
1. Переход на вкладку "Темы и уровни"
2. Клик "Создать тему"
3. Заполнение (slug: 'morphology', название: "Морфология")
4. Сохранение
5. Раскрытие темы
6. Клик "Добавить уровень"
7. Заполнение (номер: 1, название, сложность: A1)
8. Сохранение
9. Проверка отображения уровня в таблице

**Сценарий 4: Пересоздание эмбеддингов**
1. Переход на вкладку "Эмбеддинги"
2. Клик "Пересоздать все эмбеддинги"
3. Выбор опции "Только изменённые"
4. Клик "Запустить"
5. Проверка отображения прогресс-бара
6. Ожидание завершения
7. Проверка обновления статуса в Qdrant

## Приоритизация

### P0 (Must-have для запуска)
1. CRUD шаблонов с валидацией
2. Базовое управление темами и уровнями
3. Публикация шаблонов
4. Валидация синтаксиса параметров

### P1 (Важно для production)
5. Версионность шаблонов
6. Workflow модерации (двойное ревью)
7. Управление правилами
8. Мониторинг качества (dashboard)
9. Пересоздание эмбеддингов

### P2 (Nice-to-have)
10. Детектор дубликатов
11. Markdown редактор для правил
12. Drag-and-drop переупорядочивание уровней
13. История изменений с diff

## Зависимости

**Требует:**
- A6-01 (UI Суперпользователя) - для создания администраторов контента
- TD-06 (Authentication) - JWT с role 'content_admin'
- MongoDB коллекции (templates, topics, levels, rules)

**Блокирует:**
- A9 (Генератор заданий) - требует темы, уровни и шаблоны

**Опционально:**
- Python Template Generator (A9) - для генерации заданий из шаблонов
- Qdrant - для эмбеддингов

## Оценка времени

**Backend API:** ~50 часов
- CRUD шаблонов (расширение): 8 часов
- Версионность: 6 часов
- Workflow модерации: 6 часов
- CRUD тем/уровней: 10 часов
- CRUD правил: 8 часов
- Валидатор шаблонов: 6 часов
- Детектор дубликатов: 4 часов
- Тесты: 8 часов

**Frontend UI:** ~60 часов
- Форма шаблона: 10 часов
- История версий: 6 часов
- Workflow модерации UI: 6 часов
- Управление темами/уровнями: 12 часов
- Управление правилами: 10 часов
- Dashboard качества: 8 часов
- Мониторинг эмбеддингов: 6 часов
- Рефакторинг на табы: 4 часов

**Документация:** ~8 часов

**Итого:** ~118 часов (≈15 рабочих дней для 1 разработчика, ≈7-8 дней для 2 параллельно)

## Успешное завершение

Задача считается выполненной, когда:
1. Администратор контента может создать шаблон с параметрами
2. Шаблоны проходят модерацию (двойное ревью)
3. Версионность работает (создание версий, откат)
4. Темы и уровни можно создавать и редактировать
5. Правила русского языка можно создавать и связывать с шаблонами
6. Валидатор проверяет синтаксис параметров в шаблонах
7. Dashboard качества показывает метрики и проблемы
8. Пересоздание эмбеддингов работает с прогресс-баром
9. Детектор дубликатов находит схожие шаблоны
10. Все endpoints защищены RBAC (роль content_admin)
11. E2E тесты основных сценариев проходят
12. Документация для администратора контента создана

После выполнения A6-04 вся система управления контентом будет готова для перехода к A9 (Генератор заданий).
