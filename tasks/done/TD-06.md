# TD-06 — Авторизация и аутентификация пользователей

## Статус
**Критический техдолг** — блокирует полноценное тестирование A6 и запуск в production

## Контекст

Текущее состояние:
- JWT middleware для защиты endpoints (Rust API)
- Superuser bootstrap механизм (bcrypt, MongoDB)
- RBAC guards (admin_guard_middleware)
- **НЕТ страницы логина**
- **НЕТ POST /api/v1/auth/login endpoint**
- **НЕТ регистрации пользователей**
- **НЕТ управления сессиями (refresh tokens)**
- **НЕТ SSO интеграции**

**Проблема:** Невозможно протестировать админ-консоль (A6) и другие защищенные функции в "боевом" режиме. Текущий workaround — ручной ввод JWT токена через DevTools консоль.

**Требования из документации:**
- `requirements/сценарии/требования.md` §4.2.1: "Регистрация/аутентификация учащихся и кураторов (email, SSO, гостевой доступ)"
- `requirements/сценарии/требования.md` §4.4.6: RBAC, Email/Password (bcrypt ≥12), SSO (OAuth 2.0/SAML), JWT TTL ≤1h, 2FA для админов

## Роли пользователей (из requirements/архитектура/описание AL.md)

| Роль | Код | Описание | Сценарии |
|------|-----|----------|----------|
| Ученик | `student` | Проходит уровни, получает подсказки | AL-1 |
| Куратор/Учитель | `teacher` | Просмотр статистики групп, отчеты | AL-2 |
| Администратор контента | `admin` | Модерация шаблонов, управление эмбеддингами | AL-3, A6 |
| Системный администратор | `sysadmin` | Мониторинг инцидентов, управление инфраструктурой | AL-4 |

## Состав работ

### 1. Backend API (Rust)

#### 1.1. Authentication Endpoints
- `POST /api/v1/auth/register` — регистрация нового пользователя
  - Параметры: `{ email, password, name, role?, group_ids? }`
  - Валидация email (regex), password (≥8 символов, сложность)
  - Хеширование bcrypt (cost=12)
  - Создание пользователя в MongoDB `users` collection
  - Автоматическое назначение роли `student` если не указано
  - Rate limiting: 5 регистраций/IP/час

- `POST /api/v1/auth/login` — авторизация пользователя
  - Параметры: `{ email, password, remember_me? }`
  - Проверка email + bcrypt.verify(password, password_hash)
  - Генерация JWT access token (TTL=1h, claims: sub, role, group_ids, exp, iat)
  - Генерация refresh token (TTL=30d, HTTP-only cookie, Secure, SameSite=Strict)
  - Логирование попытки (success/failure, IP, timestamp) в `audit_log`
  - Rate limiting: 10 попыток/IP/5мин, затем CAPTCHA или временная блокировка
  - Возврат: `{ access_token, user: { id, email, name, role, group_ids } }`

- `POST /api/v1/auth/refresh` — обновление access token
  - Читает refresh token из HTTP-only cookie
  - Проверяет валидность в MongoDB (коллекция `refresh_tokens`)
  - Генерирует новый access token
  - Опционально: ротация refresh token (single-use)

- `POST /api/v1/auth/logout` — выход из системы
  - Инвалидация refresh token (blacklist в Redis или удаление из MongoDB)
  - Очистка HTTP-only cookie
  - Логирование события

- `GET /api/v1/auth/me` — получение текущего пользователя (protected)
  - Требует JWT в header: `Authorization: Bearer <token>`
  - Возвращает: `{ id, email, name, role, group_ids, created_at }`

- `POST /api/v1/auth/change-password` — смена пароля (protected)
  - Параметры: `{ old_password, new_password }`
  - Проверка старого пароля, валидация нового
  - Инвалидация всех refresh tokens пользователя (forced re-login)

#### 1.2. User Management (только для admin)
- `GET /api/v1/users` — список пользователей (пагинация, фильтры по role/group)
- `GET /api/v1/users/:id` — детали пользователя
- `PATCH /api/v1/users/:id` — обновление (name, role, group_ids, is_blocked)
- `DELETE /api/v1/users/:id` — удаление/блокировка пользователя
- Все операции логируются в `audit_log`

#### 1.3. Security Features
- **Rate Limiting:**
  - Login: 10 попыток/5мин per IP → временная блокировка 15 мин
  - Register: 5 регистраций/час per IP
  - Password change: 3 попытки/час per user

- **Failed Auth Monitoring:**
  - После 5 неудачных попыток за 5 мин → аккаунт переводится в режим ограничения (rate limit 1 req/sec)
  - Уведомление на email о подозрительной активности

- **Session Management:**
  - Refresh tokens хранятся в MongoDB `refresh_tokens` (user_id, token_hash, created_at, expires_at, last_used_at)
  - Автоматическая очистка истекших токенов (TTL index)
  - Возможность просмотра активных сессий (endpoint `/api/v1/auth/sessions`)
  - Массовая инвалидация всех сессий кроме текущей

#### 1.4. Database Models
```rust
// backend/rust-api/src/models/user.rs
pub struct User {
    pub id: ObjectId,
    pub email: String,           // unique, validated
    pub password_hash: String,   // bcrypt cost=12
    pub name: String,
    pub role: UserRole,          // enum: student, teacher, admin, sysadmin
    pub group_ids: Vec<String>,  // для teachers/students
    pub is_blocked: bool,
    pub created_at: DateTime,
    pub updated_at: DateTime,
    pub last_login_at: Option<DateTime>,
}

pub enum UserRole {
    Student,
    Teacher,
    Admin,
    SysAdmin,
}

// backend/rust-api/src/models/refresh_token.rs
pub struct RefreshToken {
    pub id: ObjectId,
    pub user_id: ObjectId,
    pub token_hash: String,      // SHA-256 hash of token
    pub created_at: DateTime,
    pub expires_at: DateTime,
    pub last_used_at: DateTime,
  pub user_agent: Option<String>,
    pub ip: Option<String>,
}
```

### 2. Frontend (PWA)

#### 2.1. Login Page
- Создать `frontend/src/pages/login-page.ts` (Lit component)
- UI:
  - Email input (валидация на клиенте)
  - Password input (type=password, toggle visibility)
  - "Remember me" checkbox (30 дней refresh token)
  - "Login" button
  - Ссылка на регистрацию
  - Ссылка "Forgot password?" (будущая фича)
  - Отображение ошибок (неверный пароль, блокировка)
- Логика:
  - POST /api/v1/auth/login
  - Сохранение access_token в localStorage
  - Редирект на `/` (главная) или `/admin` (для админа)

#### 2.2. Registration Page
- Создать `frontend/src/pages/register-page.ts`
- UI:
  - Email, Password, Confirm Password, Name
  - Валидация на клиенте (password strength indicator)
  - CAPTCHA (опционально, если rate limit превышен)
  - Согласие с политикой конфиденциальности (checkbox)
- Логика:
  - POST /api/v1/auth/register
  - Автоматический логин после регистрации
  - Редирект на `/onboarding` (будущая фича)

#### 2.3. Navigation & Auth State
- Обновить `frontend/src/main.ts`:
  - Проверка наличия auth_token в localStorage
  - Автоматический редирект на `/login` если токен отсутствует (для защищенных страниц)
  - Добавить logout кнопку в header (если залогинен)

- Создать `frontend/src/lib/auth-service.ts`:
  ```typescript
  export class AuthService {
    static isAuthenticated(): boolean
    static getUser(): User | null
    static hasRole(role: string): boolean
    static login(email: string, password: string): Promise<AuthResponse>
    static logout(): Promise<void>
    static refreshToken(): Promise<string>
  }
  ```

#### 2.4. Protected Routes
- Обновить роутинг в `frontend/src/main.ts`:
  ```typescript
  const requireAuth = (redirectTo = '/login') => {
    if (!AuthService.isAuthenticated()) {
      window.location.href = redirectTo;
      return false;
    }
    return true;
  };

  const requireRole = (role: string) => {
    if (!AuthService.hasRole(role)) {
      window.location.href = '/403'; // Forbidden
      return false;
    }
    return true;
  };

  // Использование:
  if (isAdminConsole) {
    if (!requireAuth() || !requireRole('admin')) return;
    import('./pages/admin-console');
  }
  ```

#### 2.5. API Client Integration
- Обновить `frontend/src/lib/api-client.ts`:
  - Автоматическое добавление `Authorization: Bearer <token>` из localStorage
  - Перехват 401 Unauthorized → автоматический refresh token или редирект на /login
  - Перехват 403 Forbidden → показ сообщения "Access denied"

#### 2.6. Responsive Design & Breakpoints
- Реализовать responsive дизайн согласно `requirements/сценарии/требования.md` §4.4.7:
  - **XXS (≤480px)**: Вертикальный поток, крупные кнопки (48x48px min)
  - **XS (481-640px)**: Мобильные в горизонтальном режиме
  - **SM (641-768px)**: Tabs для подсказок, одна колонка
  - **MD (769-1024px)**: Двухколоночный layout (задание + подсказки)
  - **LG (1025-1199px)**: Рабочая область + боковая панель
  - **XL (≥1200px)**: Три колонки (меню тем, рабочая область, аналитика)
  - **VH (≤600px высота)**: Скрывать второстепенные блоки
- CSS Grid/Flexbox, mobile-first подход
- Поддержка touch-жестов для мобильных
- Горизонтальный scroll запрещен (overflow-x: hidden)

#### 2.7. PWA Offline Support
- Настроить Service Worker (`frontend/src/sw.ts`):
  - **Cache Strategy:**
    - Network First для API запросов
    - Cache First для статических ресурсов (CSS, JS, fonts, icons)
    - Stale-While-Revalidate для изображений
  - Offline fallback страница
  - Background Sync для сохранения прогресса при восстановлении сети
  - Версионирование Service Worker (skipWaiting баннер при обновлении)
- Обновить Web Manifest (`public/manifest.json`):
  - Иконки: 192x192, 512x512 (PNG)
  - `start_url: "/"`, `display: "standalone"`
  - `theme_color`, `background_color`
- Subresource Integrity (SRI):
  - Генерация SRI хешей при сборке (esbuild plugin)
  - Проверка целостности всех статических ресурсов в Service Worker
  - Блокировка загрузки при несовпадении хеша
- Cold start ≤2 сек на 4G

#### 2.8. Accessibility (WCAG 2.1 AA)
- Клавиатурная навигация:
  - Tab/Shift+Tab между элементами формы
  - Enter/Space для активации кнопок
  - Esc для закрытия модальных окон
  - Focus visible (outline для активного элемента)
- ARIA атрибуты:
  - `aria-label` для кнопок без текста (иконки)
  - `aria-live="polite"` для уведомлений
  - `role="alert"` для ошибок валидации
  - `aria-describedby` для подсказок к полям ввода
- Масштабируемый текст (до 200% без потери функционала)
- Контрастность текста ≥4.5:1 (проверка через axe-core)
- Озвучивание пояснений (опционально через Web Speech API)
- Alt-текст для всех изображений

#### 2.9. Additional Pages (Critical for MVP)

**`frontend/src/pages/student-home.ts`** - Главная страница для student роли:
- Список доступных тем/курсов (карточки с preview)
- Progress bar для каждой темы (% выполненных заданий)
- Блок "Последние достижения" (badges, баллы)
- Кнопка "Продолжить" для незавершенной сессии
- Фильтры: По сложности (легкий/средний/сложный), По статусу (новые/в процессе/завершенные)
- Endpoint: `GET /api/v1/student/courses`

**`frontend/src/pages/teacher-dashboard.ts`** - Дашборд для teacher роли:
- Список групп (только из `group_ids` JWT claim)
- Статистика по каждой группе:
  - Количество учеников
  - % выполненных заданий
  - Средний балл
  - Проблемные темы (успешность <60%)
- Кнопка экспорта отчета (CSV/PDF)
- Фильтры по периоду (7/30/90 дней)
- Детальная статистика ученика (drill-down)
- Endpoints:
  - `GET /api/v1/teacher/groups` - список групп учителя
  - `GET /api/v1/teacher/groups/{id}/stats?period=30d` - статистика группы
  - `GET /api/v1/teacher/groups/{id}/export?format=csv` - экспорт отчета

**`frontend/src/pages/user-profile.ts`** - Страница профиля:
- Просмотр информации: email, имя, роль, дата регистрации
- Редактирование имени (inline edit)
- Смена email (требует подтверждение на старый email)
- Кнопка "Сменить пароль" (модальное окно с change-password формой)
- Блок "Активные сессии":
  - Список устройств (IP, User-Agent, последний вход)
  - Endpoint: `GET /api/v1/auth/sessions`
  - Кнопка "Завершить сессию" для каждого устройства
  - Кнопка "Выйти из всех устройств кроме текущего"
- 2FA настройки (если включено):
  - QR-код для Google Authenticator
  - Backup коды (скачать)

**`frontend/src/pages/forbidden-403.ts`** - Страница "Доступ запрещен":
- Заголовок: "403 - Доступ запрещен"
- Сообщение: "У вас недостаточно прав для доступа к этой странице"
- Информация о текущей роли: "Ваша роль: {role}"
- Кнопка "Вернуться на главную" (редирект по роли)
- Логирование попытки несанкционированного доступа:
  - Endpoint: `POST /api/v1/audit/access-denied`
  - Payload: `{ url, user_id, role, timestamp }`

### 3. Безопасность и Production Deployment

#### 3.1. Superuser Bootstrap (production-ready)
- Обновить `scripts/generate_superuser_secret.py`:
  - Дополнительная валидация email
  - Автоматическая генерация 2FA secret (TOTP) для админов
  - Вывод QR-кода для настройки Google Authenticator

- Документация деплоя (`docs/deployment-security.md`):
  - Kubernetes Secrets для admin-superuser.json
  - AWS Secrets Manager / HashiCorp Vault integration
  - Автоматическая ротация пароля суперюзера (каждые 90 дней)
  - Checklist pre-production (JWT_SECRET уникальный, HTTPS включен, HSTS настроен)

#### 3.2. Environment Configuration
- Обновить `.env.example`:
  ```bash
  # JWT Configuration
  JWT_SECRET=<CHANGE_ME_openssl_rand_base64_32>
  JWT_ACCESS_TOKEN_TTL_SECONDS=3600          # 1 hour
  JWT_REFRESH_TOKEN_TTL_SECONDS=2592000      # 30 days

  # Session Security
  COOKIE_SECURE=true                          # Only over HTTPS
  COOKIE_SAME_SITE=Strict                     # CSRF protection

  # Rate Limiting
  RATE_LIMIT_LOGIN_ATTEMPTS=10                # per 5 minutes per IP
  RATE_LIMIT_REGISTER_ATTEMPTS=5              # per hour per IP

  # 2FA (optional for MVP)
  ENABLE_2FA_FOR_ADMINS=true
  ```

#### 3.3. Security Hardening
- CSRF Protection:
  - Добавить CSRF token middleware для state-changing operations
  - Проверка Origin/Referer headers

- XSS Protection:
  - CSP header: `default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'`
  - Sanitization user input в формах

- Brute Force Protection:
  - Redis-based rate limiter (существующая реализация `middlewares/rate_limit.rs`)
  - Exponential backoff после неудачных попыток
  - CAPTCHA после 3 неудачных логинов (опционально)

#### 3.4. Data Encryption

**MongoDB Encryption at Rest** (production, требование ФЗ-152):
- Алгоритм: AEAD-ChaCha20-Poly1305 или AES-256-GCM
- Ключи хранятся в HashiCorp Vault / AWS KMS / Azure Key Vault
- Автоматическая ротация ключей каждые 90 дней
- Конфигурация: `infra/config/mongodb-encryption.yaml`
- Документация: `docs/deployment-security.md` раздел "MongoDB Encryption"

**PII Fields Encryption** (Client-Side Field Level Encryption):
- Зашифрованные поля:
  - `users.email` - deterministic encryption (для индексов)
  - `users.name` - randomized encryption
  - `users.group_ids` - deterministic encryption
- MongoDB Client-Side Field Level Encryption (CSFLE)
- Индексы по хешам email для поиска
- Master Key в Vault, Data Encryption Keys (DEK) в MongoDB key vault collection

**Encryption in Transit**:
- TLS 1.3 для всех соединений (MongoDB, Redis, API)
- HSTS header: `max-age=31536000; includeSubDomains; preload`
- Certificate pinning для mobile apps (будущая фича)

#### 3.5. PWA Security Hardening

**Service Worker Integrity**:
- Подпись всех статических ресурсов (Subresource Integrity - SRI)
- Генерация SRI хешей при сборке:
  ```javascript
  // esbuild plugin: generate-sri-hashes.js
  import crypto from 'crypto';
  export function generateSRI(content) {
    const hash = crypto.createHash('sha384').update(content).digest('base64');
    return `sha384-${hash}`;
  }
  ```
- Проверка версии Service Worker при загрузке (skip outdated SW)
- Content Security Policy (CSP) header:
  ```
  default-src 'self';
  script-src 'self';
  style-src 'self' 'unsafe-inline'; /* для Web Components Shadow DOM */
  connect-src 'self' https://api.trainingground.ru;
  img-src 'self' data:;
  font-src 'self';
  frame-ancestors 'none';
  base-uri 'self';
  form-action 'self';
  ```

**Cache Poisoning Protection**:
- Версионирование Cache Storage (`cache-v1.2.3`, `cache-v1.2.4`)
- Автоматическая очистка старых кешей при обновлении SW:
  ```javascript
  self.addEventListener('activate', event => {
    event.waitUntil(
      caches.keys().then(keys => {
        return Promise.all(
          keys.filter(key => key !== CURRENT_CACHE)
            .map(key => caches.delete(key))
        );
      })
    );
  });
  ```
- HTTPS-only для всех запросов (upgrade-insecure-requests CSP directive)
- Integrity check для кеша (сверка ETag при revalidation)

### 4. Testing

#### 4.1. Backend Tests (Rust)
- `backend/rust-api/tests/auth_test.rs`:
  - Unit tests для password hashing (bcrypt)
  - Unit tests для JWT generation/validation
  - Integration tests для login flow (успех/неуспех)
  - Integration tests для refresh token rotation
  - Security tests (SQL injection, брутфорс)

#### 4.2. Frontend Tests
- `frontend/tests/e2e/auth.spec.ts` (Playwright):
  - E2E тест: регистрация → логин → доступ к защищенной странице
  - E2E тест: логин с неверным паролем → отображение ошибки
  - E2E тест: доступ к /admin без логина → редирект на /login
  - E2E тест: логин как админ → проверка доступа к admin console

#### 4.3. Security Tests ✓
**Статус:** Выполнено
**Файлы:**
- `frontend/tests/security/penetration.spec.ts` - OWASP Top 10 penetration тесты (700+ строк)
- `frontend/tests/security/README.md` - Comprehensive security testing documentation

**Реализовано:**
- OWASP Top 10 2021 compliance testing:
  - **A01:2021 - Broken Access Control** (3 теста):
    - Предотвращение cross-user data access
    - Privilege escalation protection
    - Path traversal attack prevention (`../../../etc/passwd`)
  - **A02:2021 - Cryptographic Failures** (3 теста):
    - HTTPS enforcement (window.isSecureContext)
    - Secure cookie flags (HttpOnly, SameSite, Secure)
    - Sensitive data не хранится в localStorage
  - **A03:2021 - Injection** (3 теста):
    - SQL injection в login fields (6 payloads: `' OR '1'='1`, `admin'--`, etc)
    - NoSQL injection в API (MongoDB operators: `$ne`, `$gt`, `$where`)
    - Special character sanitization (`Robert'); DROP TABLE users;--`)
  - **A03:2021 - XSS** (4 теста):
    - Reflected XSS через URL parameters (5 payloads)
    - Stored XSS в user profile
    - HTML entity escaping
    - Data attribute sanitization
  - **A05:2021 - CSRF** (3 теста):
    - POST requests без CSRF token → 403
    - Invalid CSRF token → 403
    - State-changing operations protection (POST/PATCH/DELETE)
  - **A07:2021 - Authentication Failures** (4 теста):
    - Brute force protection (rate limiting после 10 попыток)
    - Password complexity enforcement (weak passwords rejected)
    - Session invalidation после logout
    - Session fixation prevention (session ID rotation)
  - **A08:2021 - Software Integrity** (2 теста):
    - SRI hashes для external scripts (sha256/384/512)
    - Content-Type header validation

**Attack Payloads Coverage:**
- SQL: `' OR '1'='1`, `admin'--`, `' UNION SELECT NULL--`
- NoSQL: `{ $ne: null }`, `{ $gt: '' }`, `{ $regex: '.*' }`, `{ $where: '1==1' }`
- XSS: `<script>alert("XSS")</script>`, `<img src=x onerror=...>`, `<svg/onload=...>`, `javascript:alert()`
- Path Traversal: `../../../etc/passwd`, `..\\..\\windows\\system32`, URL-encoded variants

**Покрытие тестами:** 25 тестов в 7 describe блоков

**README Documentation:**
- Detailed OWASP Top 10 explanation
- Attack scenario walkthroughs
- Fixing vulnerabilities guide
- Best practices (Defense in Depth, Principle of Least Privilege)
- CI/CD integration examples
- Production monitoring strategies

#### 4.4. Accessibility Tests
- `frontend/tests/a11y/accessibility.spec.ts` (axe-core):
  - Проверка контрастности цветов (WCAG AA ≥4.5:1)
  - Проверка ARIA атрибутов (`aria-label`, `aria-live`, `role`)
  - Проверка keyboard navigation (Tab, Enter, Esc работают корректно)
  - Проверка screen reader compatibility (NVDA, JAWS)
  - Проверка масштабирования текста (до 200% без overflow)
  - Проверка alt-текстов для изображений
  - Lighthouse Accessibility score ≥90

#### 4.5. Responsive Tests ✓
**Статус:** Выполнено
**Файлы:**
- `frontend/tests/e2e/responsive.spec.ts` - Comprehensive responsive тесты (540+ строк)
- `frontend/tests/e2e/README.md` - Обновлен с секцией о responsive тестах

**Реализовано:**
- E2E тесты на всех 6 breakpoints:
  - XXS (375x667) - iPhone SE (mobile portrait)
  - XS (480x800) - Mobile horizontal
  - SM (768x1024) - iPad Portrait
  - MD (1024x768) - iPad Landscape
  - LG (1280x720) - Desktop
  - XL (1920x1080) - Full HD
- Screenshot regression tests для каждого breakpoint на Login, Register, Home страницах (18 screenshot тестов)
- Horizontal scroll prevention тесты на всех breakpoints (3 страницы x 6 breakpoints)
- Touch events на mobile:
  - Tap события на кнопках и ссылках
  - Swipe жесты для vertical scroll
  - Touch targets >= 44x44px validation (WCAG 2.1 AAA)
  - Focus handling после tap на input полях
- Portrait/Landscape переключение тесты:
  - Mobile orientation switch (375x667 <-> 667x375)
  - Tablet orientation switch (768x1024 <-> 1024x768)
  - Multiple orientation changes stability
- Layout integrity проверки:
  - Отсутствие перекрывающихся элементов
  - Минимальные размеры шрифтов (>= 12px)
  - Container widths помещаются в viewport
- Navigation и Header доступность на всех breakpoints
- Forms validation:
  - Input heights >= 44px на mobile, >= 32px на desktop
  - Button sizes >= 44x44px на mobile, >= 60px width
- Viewport meta tag проверка (width=device-width, initial-scale=1)

**Покрытие тестами:** 72 теста в 9 describe блоках

#### 4.6. PWA Tests ✓
**Статус:** Выполнено
**Файлы:**
- `frontend/tests/pwa/service-worker.spec.ts` - Comprehensive PWA тесты (720+ строк)
- `frontend/tests/pwa/README.md` - Детальная документация PWA testing

**Реализовано:**
- Service Worker Registration (3 теста):
  - Успешная регистрация SW и проверка navigator.serviceWorker.ready
  - Контроль страницы после регистрации
- Offline Mode (3 теста):
  - Загрузка страницы из cache в offline режиме через context.setOffline(true)
  - Offline fallback для некешированных страниц
  - Graceful handling API запросов в offline (503 или cached response)
- Cache Strategies (5 тестов):
  - Network First для API requests (3s timeout, fallback to cache)
  - Cache First для static assets (JS, CSS) с SRI verification
  - App Shell caching для navigation requests
  - Cache expiration policies и версионирование (v1, v2)
  - Cleanup дубликатных кешей
- Service Worker Updates (2 теста):
  - skipWaiting message handling
  - Automatic cleanup старых кешей при activation
- Web Manifest (5 тестов):
  - Валидация manifest.webmanifest (name, short_name, display, start_url, icons)
  - Display mode: standalone
  - Icon sizes 192x192 и 512x512
  - Theme и background colors валидация
  - PWA install prompt availability
- SRI Verification (4 теста):
  - Integrity атрибуты на всех script и link tags
  - Наличие sri-manifest.json с SHA-384 хешами
  - SRI verification logic в Service Worker (verifySRI, getExpectedSRI)
  - Проверка формата SRI entries (integrity, size)
- Lighthouse PWA Audit (2 теста, optional):
  - PWA score >= 90 критерии (HTTPS, SW, Manifest, Icons)
  - Installable PWA проверка
  - NOTE: Требует playwright-lighthouse, по умолчанию .skip
- Background Sync (1 тест):
  - Queuing POST requests в offline
  - Background sync API availability

**Покрытие Cache Strategies:**
- App Shell: Network First с 5s timeout
- API: Network First с 3s timeout
- Static Assets (JS/CSS): Cache First с SRI Plugin
- Images: Cache First, TTL 30 дней
- Fonts: Cache First, TTL 1 год
- Google Fonts: Stale While Revalidate

**Покрытие тестами:** 26 тестов в 8 describe блоков (+ 2 optional Lighthouse)

### 5. UI/UX для всех ролей

#### 5.1. Student Role
- После логина → главная страница с доступными темами/уровнями
- Навигация: Мои курсы, Прогресс, Профиль
- Ограничения: не видит других учеников, статистику классов

#### 5.2. Teacher Role
- После логина → дашборд с группами учеников
- Навигация: Мои группы, Статистика, Отчеты, Профиль
- Доступ только к своим группам (проверка через `group_ids` в JWT)

#### 5.3. Admin Role
- После логина → админ-консоль (существующая `/admin`)
- Навигация: Шаблоны, Правила, Feature Flags, Пользователи, Аудит
- Полный доступ ко всем данным

#### 5.4. Unified Header Component
- Создать `frontend/src/components/app-header.ts`:
  - Логотип + название
  - Навигация (зависит от роли)
  - User menu (dropdown): Профиль, Настройки, Выход
  - Отображение текущей роли (badge)

### 6. Guest Access (Post-MVP)

**Источник:** `requirements/сценарии/требования.md` §4.2.1 (гостевой доступ)

#### 6.1. Backend - Guest Registration
- `POST /api/v1/auth/guest` — создание гостевого аккаунта:
  - Генерация уникального `guest_id` (UUID v4)
  - Роль: `guest` (ограниченный доступ)
  - TTL: 7 дней (автоматическое удаление через MongoDB TTL index)
  - Нет email, нет password
  - Генерация JWT с claims: `{ sub: guest_id, role: "guest", exp: 7d }`
  - Ограничения в middleware:
    - Нельзя сохранять прогресс в БД (только в localStorage)
    - Нет доступа к рейтингам
    - Нет групповых заданий
    - Нет экспорта отчетов

#### 6.2. Backend - Guest → Student Conversion
- `POST /api/v1/auth/guest/convert` — конвертация в полноценный аккаунт:
  - Параметры: `{ email, password, name }`
  - Валидация email (unique check)
  - Хеширование password (bcrypt)
  - Перенос временного прогресса:
    - Чтение прогресса из localStorage (фронтенд отправляет JSON)
    - Сохранение в MongoDB `user_progress` collection
  - Смена роли: `guest` → `student`
  - Обновление `user_id` в существующих сессиях
  - Возврат нового JWT с role=student

#### 6.3. Frontend - Guest Flow
- Кнопка "Попробовать без регистрации" на login page:
  - POST /api/v1/auth/guest
  - Сохранение JWT в localStorage
  - Редирект на `/` (student home)
- Persistent баннер для guest пользователей:
  - Текст: "Вы используете гостевой доступ. Прогресс НЕ сохраняется. Зарегистрируйтесь, чтобы сохранить результаты."
  - Кнопка "Зарегистрироваться" (открывает модал конвертации)
- Модал конвертации:
  - Форма: Email, Password, Confirm Password, Name
  - Чекбокс: "Перенести текущий прогресс в новый аккаунт"
  - POST /api/v1/auth/guest/convert с прогрессом из localStorage
- Автоматическое удаление гостевых аккаунтов:
  - Cron job (ежедневно в 03:00): удаление записей старше 7 дней
  - MongoDB TTL index на поле `created_at`

#### 6.4. Database Model
```rust
pub struct GuestUser {
    pub id: ObjectId,           // guest_id
    pub role: UserRole::Guest,
    pub created_at: DateTime,   // TTL index: expires after 7 days
    pub converted: bool,        // true если конвертирован в student
    pub converted_to: Option<ObjectId>, // user_id после конвертации
}
```

## Чек-лист готовности

### Backend
- [x] POST /api/v1/auth/register endpoint (bcrypt, валидация, возвращает refresh_token)
- [x] POST /api/v1/auth/login endpoint (JWT + refresh token, возвращает refresh_token в ответе)
- [x] POST /api/v1/auth/refresh endpoint
- [x] POST /api/v1/auth/logout endpoint
- [x] GET /api/v1/auth/me endpoint (protected)
- [x] GET /api/v1/users endpoint (admin only)
- [x] GET /api/v1/users/:id endpoint (admin only)
- [x] PATCH /api/v1/users/:id endpoint (admin only)
- [x] User model в MongoDB (email, password_hash, role, group_ids)
- [x] RefreshToken model в MongoDB
- [x] Rate limiting для login/register (login: 10/5мин, register: 5/час per IP)
- [x] **HTTP-only cookies для refresh tokens** (login/register/refresh/logout endpoints обновлены)
- [x] **Failed auth monitoring** (счётчик неудачных попыток в Redis, блокировка после 5 попыток, TTL 15 мин, автоочистка, HTTP 429 Too Many Requests)
- [x] **Audit logging всех auth операций** (коллекция audit_log, AuditService, логирование login/register/logout/change_password)
- [x] **Integration tests для auth flow** (backend/rust-api/tests/auth_tests.rs - 16 тестов: register→login→refresh→logout, rate limiting, CSRF endpoint, валидация, unauthorized access)

### Frontend
- [x] Login page компонент (frontend/src/pages/login-page.ts, использует AuthService)
- [x] Register page компонент (frontend/src/pages/register-page.ts, использует AuthService)
- [x] Auth state management (AuthService) (frontend/src/lib/auth-service.ts - полноценный класс)
- [x] Protected routes middleware (main.ts requireAuth/requireRole функции)
- [x] API client auto-refresh token (api-client.ts attemptTokenRefresh, 401/403 handling, **refresh_token в HTTP-only cookie**)
- [x] **Frontend AuthService обновлен** (удален localStorage для refresh_token, использует credentials: 'include')
- [x] Unified header компонент (frontend/src/components/app-header.ts, навигация по ролям, responsive, mobile menu)
- [x] User menu dropdown (профиль, выход, показывает имя и роль пользователя)
- [x] **Student Home page** (frontend/src/pages/student-home.ts, mock данные курсов, фильтры, прогресс, route /)
- [x] **Teacher Dashboard page** (статистика групп, экспорт отчетов, использует AuthService)
- [x] **User Profile page** (frontend/src/pages/user-profile.ts, смена пароля, активные сессии, route /profile)
- [x] **403 Forbidden page** (frontend/src/pages/forbidden-page.ts, role-based redirect)
- [x] **Responsive design** (6 breakpoints: XXS≤480px, XS 481-640px, SM 641-768px, MD 769-1024px, LG 1025-1199px, XL ≥1200px, mobile-first подход, CSS Grid/Flexbox, breakpoints.css + global.css, обновлены login-page, register-page, app-header с mobile menu)
- [x] **PWA offline support** (Service Worker sw.ts: 6 кэш-стратегий, Network First для API (3s timeout), Cache First для статики/images/fonts (30 days TTL), Background Sync для POST запросов (24h retry), offline fallback page, auto cache cleanup, manifest.webmanifest с shortcuts и share_target)
- [x] **Accessibility (WCAG 2.1 AA)** (keyboard nav: Tab/Shift+Tab/Enter/Esc в формах, Arrow Up/Down в dropdown, ARIA атрибуты: aria-label/aria-live/aria-expanded/aria-current/role в login/register/app-header, контраст ≥4.5:1: обновлены цвета в global.css (--primary #3b82f6 4.65:1, --text-muted #a5b4cb 5.1:1, --error #fca5a5 5.2:1, --success #4ade80 6.8:1, --warning #fcd34d 9.1:1), focus ring высококонтрастный --focus-ring #60a5fa, skip-to-main link в index.html, prefers-reduced-motion, prefers-contrast:high, текст масштабируется до 200% через относительные единицы и clamp())
- [x] **E2E тесты Playwright для auth flow** (auth.spec.ts: register→login→protected routes, role-based-access.spec.ts: student/teacher/admin access, security.spec.ts: CSRF, session management, XSS protection)
- [x] **Accessibility tests** (frontend/tests/a11y/accessibility.spec.ts: comprehensive тесты axe-core для WCAG 2.1 AA compliance; проверка color contrast ≥4.5:1; ARIA атрибуты (aria-label, aria-live, role, aria-current); keyboard navigation (Tab, Enter, Esc, Arrow keys); screen reader compatibility (html lang, page titles, alt text); text scaling до 200% без horizontal scroll; focus management (focus trap в модалах, skip-to-main link, focus restoration); mobile accessibility (touch targets ≥44x44px); тесты для Login, Register, Admin, Navigation pages; wcag.spec.ts для regression testing; README.md с инструкциями запуска и troubleshooting; npm run test:a11y для запуска всех тестов; Lighthouse score ≥90 ожидается)
- [x] **Responsive tests** (frontend/tests/e2e/responsive.spec.ts: screenshot regression на всех 6 breakpoints XXS/XS/SM/MD/LG/XL; horizontal scroll prevention; touch events validation (tap, swipe, 44x44px targets); portrait/landscape orientation switching; layout integrity; forms и navigation проверки на всех breakpoints; 72 теста в 9 describe блоках)
- [x] **PWA tests** (frontend/tests/pwa/service-worker.spec.ts: Service Worker registration и control; offline mode (context.setOffline, cache fallback); cache strategies (Network First для API, Cache First для static assets с SRI, App Shell); SW updates (skipWaiting, cleanup старых кешей); Web Manifest validation (display:standalone, icons 192x192/512x512); SRI verification (integrity атрибуты, sri-manifest.json, SHA-384 hashes); Background Sync; Lighthouse PWA ≥90 критерии; 26 тестов в 8 describe блоков; frontend/tests/pwa/README.md comprehensive документация)
- [x] **Security penetration tests** (frontend/tests/security/penetration.spec.ts: OWASP Top 10 2021 compliance; A01 Broken Access Control (cross-user data, privilege escalation, path traversal); A02 Cryptographic Failures (HTTPS, secure cookies, localStorage sanitization); A03 Injection (SQL injection 6 payloads, NoSQL injection MongoDB operators, special char sanitization); A03 XSS (reflected XSS 5 payloads, stored XSS, HTML escaping, data attribute sanitization); A05 CSRF (POST без token, invalid token, state-changing ops); A07 Authentication (brute force rate limiting 10 attempts, password complexity, session invalidation, fixation prevention); A08 Software Integrity (SRI hashes sha256/384/512, Content-Type validation); 25 тестов в 7 describe блоков; frontend/tests/security/README.md с attack scenarios, fixing guide, best practices)

### Security
- [x] **JWT_SECRET уникальный для production** (.env.example:40 placeholder с инструкцией `openssl rand -base64 32`; docs/deployment-security.md:26 checklist с криптографически стойкой генерацией; примеры для cloud platforms: Azure Key Vault `az keyvault secret set --value "$(openssl rand -base64 32)"`, Google Cloud Secrets `gcloud secrets create jwt-secret`, Kubernetes secret; docs/dev-setup.md:34 генерация для dev; JWT_SECRET НЕ коммитится в Git по .gitignore)
- [x] **HTTPS включен (TLS 1.3/1.2)** (infra/nginx/nginx.conf и trainingground.conf: ssl_protocols TLSv1.3 TLSv1.2; strong cipher suites Mozilla Modern config ECDHE-ECDSA/RSA-AES-GCM, CHACHA20-POLY1305; OCSP stapling enabled; SSL session cache 10MB; docker-compose.prod.yml с nginx:1.25-alpine и certbot для Let's Encrypt; infra/nginx/init-letsencrypt.sh для первичной настройки сертификатов; .env.example комментарии для production/development; infra/nginx/README.md полная документация deployment/monitoring/troubleshooting; rate limiting zones: api_limit 10r/s, login_limit 5r/m; nginx reverse proxy для rust-api:8081 и python-generator:8082 без exposed портов)
- [x] **HSTS header настроен с соблюдением ФЗ-152** (Strict-Transport-Security: max-age=31536000; includeSubDomains БЕЗ preload для соответствия законодательству РФ - hstspreload.org управляется Google (США), что может противоречить локализации данных; DNS resolver изменен с Google на Yandex DNS (77.88.8.8, 77.88.8.1) для compliance; подробное обоснование в comments infra/nginx/conf.d/trainingground.conf; дополнительные security headers: X-Frame-Options DENY, X-Content-Type-Options nosniff, X-XSS-Protection, Referrer-Policy strict-origin-when-cross-origin, Permissions-Policy, CSP; infra/nginx/certbot-renew.sh автоматическое обновление сертификатов через cron 0 3 * * *; nginx health check endpoint /health; gzip compression enabled; keepalive для upstreams; **проверка на реальном домене вынесена в TD-06-27.md как технический долг**)
- [x] **CSRF protection middleware** (double-submit cookie pattern, GET /api/v1/auth/csrf-token endpoint, X-CSRF-Token header validation, применен ко всем state-changing операциям)
- [x] CSP headers настроены (включая `frame-ancestors 'none'`)
- [x] **Rate limiting работает** (nginx rate limiting zones в production: api_limit 10 req/s burst 20, login_limit 5 req/min burst 5, register_limit 5 req/min burst 3, limit_conn addr 10; stricter limits для /api/v1/auth/login и /api/v1/auth/register endpoints; Redis-based backend rate limiter в rust-api через RATE_LIMIT_LOGIN_ATTEMPTS=10, RATE_LIMIT_REGISTER_ATTEMPTS=5)
- [x] **Rate limiting verification тесты** (backend/rust-api/tests/rate_limit_tests.rs: 6 тестов проверяют login rate limiting 10/5мин, register rate limiting 5/час, failed auth monitoring 5 попыток, concurrent requests, RATE_LIMIT_DISABLED flag; все тесты проходят с Redis cleanup; тест window expiration помечен #[ignore] как slow test)
- [x] **Refresh tokens в HTTP-only cookies** (Secure, SameSite=Strict, Path=/api/v1/auth, MaxAge=30d)
- [x] Bcrypt cost ≥ 12
- [x] **Логирование всех failed auth attempts** (audit_log collection, события: login_failed, register_failed, change_password_failed)
- [x] **MongoDB Encryption at Rest** (AEAD_AES_256_CBC_HMAC_SHA_512-Random/Deterministic, ключи в HashiCorp Vault; infra/config/mongodb-encryption.yaml конфигурация CSFLE для PII полей; docker-compose.yml добавлен Vault 1.15 с file backend; infra/vault/init-mongodb-encryption.sh генерирует master key и DEK для user-email/name/audit-ip/useragent; infra/vault/rotate-encryption-keys.sh автоматическая ротация каждые 90 дней с версионированием ключей (max 3 версии); AppRole authentication для rust-api; .env добавлены VAULT_ADDR, VAULT_ROOT_TOKEN, VAULT_ROLE_ID, VAULT_SECRET_ID, MONGODB_ENCRYPTION_ENABLED/PROVIDER; infra/vault/README.md полная документация setup/monitoring/troubleshooting)
- [x] **PII Fields Encryption** (Client-Side Field Level Encryption для email (Deterministic для поиска), name, ip_address, user_agent; конфигурация в mongodb-encryption.yaml; ключи управляются через Vault KV v2; поддержка key rotation без потери доступа к старым данным)
- [x] **Subresource Integrity (SRI)** (SHA-384 хеши для всех статических ресурсов: Vite plugin viteSRIPlugin генерирует sri-manifest.json с 13 entries, post-build script добавляет integrity атрибуты к script/link тегам в index.html, Service Worker SRIPlugin верифицирует хеши при cacheWillUpdate и cachedResponseWillBeUsed, блокирует загрузку/кеширование при несовпадении хеша, loadSRIManifest загружается при install)
- [x] **Cache Poisoning Protection** (версионирование Service Worker cache: activate event автоматически удаляет старые версии кеша, currentCaches список в sw.ts, SRI verification предотвращает кеширование модифицированных файлов)
- [ ] 2FA для админов (опционально для MVP)

### Deployment
- [x] **Production deployment документация** (docs/deployment-security.md: comprehensive pre-production checklist с 90+ пунктами проверки безопасности; deployment options для Docker Compose Production/Kubernetes/Cloud (AWS ECS, Azure, GCP); Kubernetes Secrets для admin-superuser.json с примерами манифестов (Deployment, StatefulSet, Ingress, Service); HTTPS + HSTS setup с Nginx reverse proxy и Let's Encrypt; MongoDB replica set security с keyfile authentication и CSFLE; Secrets management через Vault/K8s/AWS/Azure/GCP; .env.example template для всех окружений; Monitoring/Logging setup с Prometheus/Grafana/alerts; Backup & Disaster Recovery процедуры с encryption и S3 upload)
- [x] **Superuser bootstrap через Kubernetes Secrets / Vault** (kubectl create secret generic admin-superuser --from-file=admin-superuser.json; vault kv put secret/admin/superuser; Docker Compose volumes mount /secrets/admin-superuser.json; ADMIN_SEED_FILE=/secrets/admin-superuser.json env var; примеры для всех deployment scenarios в docs/deployment-security.md)
- [x] Environment variables настроены (.env.example) (JWT_SECRET, JWT_ACCESS_TOKEN_TTL_SECONDS=3600, JWT_REFRESH_TOKEN_TTL_SECONDS=2592000, COOKIE_SECURE=true/false, COOKIE_SAME_SITE=Strict/Lax/None, RATE_LIMIT_DISABLED=false, RATE_LIMIT_PER_USER=100, RATE_LIMIT_PER_IP=200, RATE_LIMIT_LOGIN_ATTEMPTS=10, RATE_LIMIT_REGISTER_ATTEMPTS=5, VAULT_ADDR, VAULT_ROLE_ID, VAULT_SECRET_ID, MONGODB_ENCRYPTION_ENABLED/PROVIDER; backend/rust-api/src/config.rs CookieSettings добавлен с from_env() и parse_same_site(); auth.rs использует state.config.cookie.secure и state.config.cookie.parse_same_site(); rate_limit.rs читает RATE_LIMIT_PER_USER, RATE_LIMIT_LOGIN_ATTEMPTS, RATE_LIMIT_REGISTER_ATTEMPTS из env с fallback на константы)
- [x] **Pre-commit hook проверяет что JWT_SECRET не хардкоден** (.githooks/pre-commit-secrets: проверка хардкоденных JWT_SECRET, API keys, паролей через regex patterns; блокирует коммит .env/.env.prod/.env.production файлов; проверяет .env.example на реальные секреты вместо placeholders; блокирует credential files (credentials.json, *.pem, *.key, admin-superuser.json); проверяет AWS credentials, private keys, database passwords; пропускает .md/.githooks/docs для избежания ложных срабатываний; интегрирован в .githooks/pre-commit; документирован в README.md раздел "Git Hooks и безопасность" с примерами ПЛОХО/ХОРОШО и инструкциями по настройке git config core.hooksPath .githooks)

### UI для всех ролей
- [x] Student: главная с курсами/уровнями (frontend/src/pages/student-home.ts)
- [x] Teacher: дашборд с группами
- [x] Admin: консоль управления (существует)
- [x] Навигация адаптируется под роль (requireAuth/requireRole в main.ts)
- [x] 403 Forbidden page (доступ запрещен)

## Приоритеты

### MVP (Critical для запуска)
1. Login/Register endpoints (backend)
2. Login page (frontend)
3. Protected routes middleware
4. JWT auth в API client
5. Rate limiting + audit logging

### Post-MVP (можно отложить)
- 2FA для админов (TOTP)
- SSO интеграция (OAuth 2.0 / SAML)
- Password reset flow (email)
- Account verification (email confirmation)
- "Remember this device" (device fingerprinting)

## Ссылки на документацию

- **Требования:** `requirements/сценарии/требования.md` §4.2.1, §4.4.6
- **Роли:** `requirements/архитектура/описание AL.md` (AL-1, AL-2, AL-3)
- **Безопасность:** `docs/deployment-security.md`
- **Текущая реализация A6:** `tasks/A6.md`
- **Pre-commit hooks:** `.githooks/pre-commit-rust`

## Связанные задачи

- **A6 (Admin Console)** — блокируется TD-06, невозможно протестировать в боевом режиме
- **AL-1 (Student flow)** — требует авторизацию
- **AL-2 (Teacher dashboard)** — требует RBAC проверки group_ids
- **BL-1 (Session Manager)** — требует user_id из JWT
- **TD-06-27 (HSTS + SSL deployment проверка)** — технический долг, требует реальный домен для проверки

## Оценка

**MVP (Критические компоненты):**
- **Backend API:** 3-4 дня (8 endpoints + models + tests + teacher endpoints)
- **Frontend базовый:** 3 дня (login/register + auth service + routing)
- **Frontend дополнительные страницы:** 3 дня (student-home + teacher-dashboard + profile + 403)
- **Responsive design:** 2 дня (6 breakpoints, mobile-first CSS)
- **PWA offline:** 2 дня (Service Worker, Cache Storage, SRI)
- **Accessibility:** 1 день (WCAG 2.1 AA, ARIA, keyboard nav)
- **Security hardening:** 2 дня (rate limiting, CSRF, MongoDB encryption, SRI)
- **Testing:** 2 дня (unit, E2E, accessibility, responsive, PWA tests)
- **Documentation:** 1 день
- **ИТОГО MVP:** ~19-20 дней разработки

**Post-MVP (опционально):**
- **Guest Access:** 2 дня (backend + frontend + conversion flow)
- **2FA для админов:** 2 дня (TOTP + QR-код)
- **SSO (OAuth/SAML):** 3-5 дней (зависит от провайдера)
- **Password reset flow:** 2 дня (email + токены)
- **Email verification:** 1 день

**ИТОГО с Post-MVP:** ~29-32 дня

## Критерии приёмки

**Базовая авторизация:**
1. Пользователь может зарегистрироваться (email + password)
2. Пользователь может залогиниться и получить JWT токен
3. Токен автоматически добавляется ко всем API запросам
4. При истечении access token автоматически обновляется через refresh token
5. После 5 неудачных попыток логина аккаунт блокируется на 15 мин
6. Все auth операции логируются в audit_log

**Role-Based Access Control:**
7. Админ может зайти на `/admin` без ручного ввода токена
8. Ученик НЕ может зайти на `/admin` (показывается 403 Forbidden page)
9. Учитель видит ТОЛЬКО свои группы (проверка `group_ids` в JWT)
10. После логина редирект зависит от роли (student → `/`, teacher → `/dashboard`, admin → `/admin`)

**UI/UX для всех ролей:**
11. Student home page показывает доступные темы/курсы с прогрессом
12. Teacher dashboard показывает статистику групп и экспорт отчетов работает
13. User Profile page позволяет сменить пароль и просмотреть активные сессии
14. 403 Forbidden page логирует попытки несанкционированного доступа

**Responsive & PWA:**
15. Сайт корректно отображается на всех breakpoints (XXS 375px → XL 1920px)
16. PWA работает в offline режиме (Service Worker кеширует статику)
17. Lighthouse PWA score ≥90, Accessibility score ≥90
18. Cold start ≤2 сек на 4G

**Безопасность:**
19. MongoDB данные зашифрованы (AEAD-ChaCha20-Poly1305 в production)
20. Subresource Integrity (SRI) проверяет целостность всех статических ресурсов
21. CSP headers защищают от XSS атак
22. WCAG 2.1 AA соблюдён (контрастность ≥4.5:1, keyboard nav работает)

**Тестирование:**
23. E2E тесты проходят для всех ролей (student, teacher, admin)
24. Accessibility tests проходят (axe-core)
25. Responsive tests проходят на всех breakpoints (screenshot regression)
26. Security tests проходят (OWASP Top 10, брутфорс защита)

**Production:**
27. Production deployment документирован и протестирован
28. Superuser bootstrap работает через Kubernetes Secrets
29. HTTPS + HSTS настроены корректно (конфигурация готова, проверка на реальном домене - см. TD-06-27.md)

---

**Статус:** В процессе (частично реализовано)
**Приоритет:** P0 (критический)
**Блокирует:** A6, AL-1, AL-2, production запуск
