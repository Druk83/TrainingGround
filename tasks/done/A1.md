NOTE (2025-12-22): рабочий репозиторий включает каталоги frontend/, backend/rust-api/ и backend/python-generator/. Husky/lint-staged обслуживает фронтенд, .githooks запускают Rust и Python проверки, а docker-compose поднимает MongoDB, Redis, Qdrant, Rust API и Python Explanation API. Описание ниже оставлено для истории, актуальное состояние отражено в docs/dev-setup.md.
# A1 — Фундамент хранилищ и потоков данных

## Контекст
Необходимо подготовить хранилища и потоки данных, описанные в `requirements/струтура Данных/описани БД.md`, `requirements/глоссарий.md` и архитектурных документах. На этом этапе закладываются схемы MongoDB, Qdrant и Redis, механизмы резервного копирования и синхронизации, чтобы последующие сервисы (Rust API, Python-подсказки, PWA) могли опираться на стабильные данные.

## Состав работ
1. **Спецификация MongoDB.**
   - Описать каждую коллекцию (`users`, `groups`, `topics`, `levels`, `templates`, `tasks`, `attempts`, `progress_summary`, `hints_log`, `rules`, `incidents`, `feature_flags`, `materialized_stats`, `leaderboards`) в виде JSON Schema/TypeScript типов.
   - Создать миграции/скрипты (`infra/mongo-init/*.js`) для индексов, TTL (`tasks` 30 дней, `leaderboards` 24 часа) и шифрования PII (см. требования безопасности из `requirements/сценарии/требования.md`).
   - Описать транзакции и Change Streams, которые будут использоваться Session Manager’ом и Embedding Pipeline.
2. **Дизайн Redis keyspace.**
   - Реализовать конфигурацию ключей (`session:{id}`, `session:timer:{id}`, `hints_used:{session_id}`, `anticheat:{user_id}`, `score:series:{user_id}`, `feature_flag_cache`, `content:changes`, `explanation:cache:{task_id}`) и задокументировать TTL.
   - Написать Lua-скрипты (`purchase_hint.lua`, `score_series.lua`) и набор тестов для них.
   - Подготовить конфигурацию Redis Cluster (sharding, persistence RDB/AOF, мониторинг задержек).
3. **Подготовка Qdrant.**
   - Создать коллекции `rules_embeddings`, `examples_embeddings`, `templates_embeddings` с параметрами HNSW (M=16, ef_construction=200) и схемой payload.
   - Настроить ежедневные snapshot’ы в Object Storage и описать процедуру восстановления ≤15 минут.
4. **Потоки данных и интеграции.**
   - Реализовать Redis Stream `content:changes` (Mongo Change Stream → Redis) для Embedding Pipeline.
   - Определить структуру событий (`template_id`, `action`, `version`) и политику повторной доставки.
   - Задокументировать связи MongoDB ↔ Redis, MongoDB ↔ Qdrant, включая идемпотентные ключи (см. раздел 4 `requirements/сценарии/требования.md`).
5. **Резервное копирование и окружения.**
   - Создать скрипты `infra/scripts/backup.sh` и `restore.sh` (mongodump, redis-cli RDB, qdrant snapshot).
   - Определить расписание бэкапов (Mongo WAL каждый час, Redis каждые 15 минут, Qdrant раз в сутки) и хранение в Yandex Object Storage (S3-совместимый).
   - Описать dev/test/staging окружения (docker-compose profile `data`), указать минимальные требования к ресурсам.
6. **Документация.**
   - Обновить `docs/data-model.md` и диаграммы (Mermaid/ERD) с актуальными сущностями.
   - Добавить инструкции по локальному поднятию хранилищ в `docs/dev-setup.md`.

## Ожидаемые артефакты
- Спецификации схем (JSON Schema/TypeScript/Proto) и индексные миграции.
- Скрипты и конфигурации для MongoDB, Redis, Qdrant, а также бэкап-скрипты.
- Диаграммы потоков данных и инструкции по развёртыванию окружений.

## Чек-лист готовности
- [x] Все коллекции MongoDB имеют описанные поля, индексы, TTL и политику шифрования PII.
- [x] Lua-скрипты и конфигурация Redis задокументированы, а ключи автоматически создаются/очищаются.
- [x] Qdrant коллекции и snapshot flow можно поднять заново по инструкции без ручных правок.
- [x] Потоки MongoDB → Redis/Redis Streams описаны на идемпотентность и устойчивость к сбоям.
- [x] Бэкап/restore скрипты созданы с интеграцией Yandex Object Storage.
- [x] Документация и схемы синхронизированы с фактическими конфигурациями.
- [x] Python зависимости установлены (`infra\install-deps.cmd`)
- [x] Docker Compose окружение запущено (`docker-compose up -d`)
- [x] MongoDB коллекции созданы (14 коллекций с индексами и TTL)
- [x] Qdrant коллекции инициализированы (`python infra\qdrant\init_collections.py`)
- [x] Redis Lua скрипты протестированы (`npm test` в `infra/tests` — 8/8 passed)
- [x] **Документировано ограничение dev:** MongoDB replica set отключен (Change Streams недоступны локально, см. `docs/mongodb-replica-set.md`)
- [x] **Change Stream Bridge:** скрипт `infra/scripts/changestream_bridge.py` создан, готов к тестированию в staging/production с replica set
- [x] **Backup/restore:** скрипты созданы (`infra/scripts/backup.sh`, `restore.sh`), готовы к тестированию в реальных условиях

## Тестирование
- **Infrastructure tests:** автоматический прогон `infra/tests/mongo_schema.test.js`, `redis/lua.test.js`, проверка создания коллекций Qdrant (`pytest` или `go test` скрипт).
- **Recovery drills:** раз в спринт выполнить `restore` из последнего бэкапа и убедиться, что данные консистентны.
- **Change Stream tests:** интеграционный тест (Docker) должен моделировать публикацию/удаление шаблона и проверять запись события в `content:changes`.
- **Security checks:** убедиться, что данные с PII шифруются (например, через Mongo Field Level Encryption) и что резервные копии зашифрованы.
