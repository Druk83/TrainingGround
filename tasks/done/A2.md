NOTE (2025-12-22): рабочий репозиторий включает каталоги frontend/, backend/rust-api/ и backend/python-generator/. Husky/lint-staged обслуживает фронтенд, .githooks запускают Rust и Python проверки, а docker-compose поднимает MongoDB, Redis, Qdrant, Rust API и Python Explanation API. Описание ниже оставлено для истории, актуальное состояние отражено в docs/dev-setup.md.
# A2 — Бизнес-ядро на Rust: сессии, ответы, подсказки

## Контекст
Согласно `requirements/сценарии/требования.md` и документам BL/TL, Rust API должен реализовать Lesson Execution Service: управление сессиями, проверку ответов, начисление баллов, лимиты подсказок и античит. Этот блок обеспечивает выполнение правил AL-1/AL-2 и служит опорой для PWA и Python-сервиса.

## Состав работ
1. **Архитектура сервиса.**
   - Настроить проект `backend/rust-api` с `axum`/`hyper`, `tokio`, DI контейнером, конфигами (`config/*.toml`), логированием (`tracing`, `opentelemetry`).
   - Реализовать слои middleware: аутентификация (JWT с claims `role`, `group_ids`), rate limiting (per user/IP), anti-CSRF.
2. **Session Manager & таймеры.**
   - Эндпоинты: `POST /sessions`, `GET /sessions/{id}`, `POST /sessions/{id}/complete`.
   - Управление заданиями: резервирование `Task Instance` из MongoDB, запись состояния в Redis (`session:{id}`, TTL 3600 сек).
   - Реализовать SSE/WebSocket канал `GET /sessions/{id}/stream` с событиями `timer-tick`, `time-expired` (≤200 мс задержка).
3. **Answer Checker + Scoring Engine.**
   - Эндпоинт `POST /sessions/{id}/answers` с идемпотентным ключом (session_id + task_instance_id).
   - Логика начисления баллов (правила S1–S5 из глоссария): +10 базовых, +5 бонус для серии ≥3, 0 за неверный/таймаут, −5 за подсказку.
   - Транзакции MongoDB + Redis (обновление `attempts`, `score:series:{user_id}`, `progress_summary`).
   - Хранение причин (timeout, wrong_answer) в `Attempt Record`.
4. **Подсказки и интеграция с Python.**
   - Эндпоинт `POST /sessions/{id}/hints`: проверка `hints_used:{session_id}` (макс. 2), списание баллов до выдачи подсказки.
   - Запрос к Python Explanation API (`/explanations` REST/gRPC, timeout 2 сек) и fallback на статичное правило из MongoDB, фиксация в `hints_log`.
   - Кэширование подсказок (`explanation:cache:{task_id}`, TTL 5 мин).
5. **Античит и инциденты.**
   - Счётчики `speed_hits`, `repeated_hits` (Redis key `anticheat:{user_id}`), пороги: >5 за час → статус `suspicious`, >10 или повторов >8 → блокировка.
   - Создание документов `incidents` и публикация события в Redis Pub/Sub `incidents`.
   - Интеграция с hCaptcha и DevOps hooks (Alertmanager).
6. **Документация и API контракт.**
   - OpenAPI/AsyncAPI для всех эндпоинтов (`docs/api/game.yaml`), описание SSE.
   - Руководство по идемпотентности, схемы DTO, примеры нагрузочных характеристик.

## Ожидаемые артефакты
- Реализованный Rust сервис с Dockerfile, конфигами и автотестами.
- Обновлённые схемы API/DTO, runbook по подсказкам/античиту.
- Интеграция с Redis/Mongo/Qdrant (через Python сервис) и исходные k6 сценарии.

## Чек-лист готовности
- [x] Session Manager: POST/GET/Complete эндпоинты с Redis интеграцией (4/4 тесты passing)
- [x] Answer Checker: POST /sessions/{id}/answers с правилами S1, S2, S4 (3/3 тесты passing)
  - [x] Rule S1: +10 базовых очков за правильный ответ
  - [x] Rule S2: 0 очков за неправильный ответ, сброс серии
  - [x] Rule S4: +5 бонус комбо после серии ≥3
  - [x] Rule S3: -5 за подсказку (реализовано в Hint Purchaser)
  - [x] Rule S5: проверка порога 80% для повышения уровня (progress_summary)
  - [x] Сохранение попыток в MongoDB (AttemptRecord)
  - [x] Обновление счёта в Redis (user:score:{user_id})
  - [x] Отслеживание серий в Redis (score:series:{user_id})
  - [x] Получение правильного ответа из MongoDB tasks
  - [x] Обработка idempotency_key (кэш в Redis 24ч)
  - [x] Проверка timeout сессии с записью AttemptFailureReason::Timeout
- [x] Hint Purchaser: POST /sessions/{id}/hints с Lua скриптами (3/3 тесты passing)
  - [x] Lua скрипт для атомарной проверки лимита (макс 2 подсказки)
  - [x] Списание -5 баллов ДО выдачи подсказки (Rule S3)
  - [x] Интеграция с Python Explanation API (timeout 2s)
  - [x] Fallback на статичные подсказки из MongoDB
  - [x] Кэширование в Redis (explanation:cache:{task_id}, TTL 5min)
  - [x] Запись в MongoDB hints_log
- [x] Anticheat: интеграция в Answer Checker (3/3 тесты passing)
  - [x] Redis счётчики speed_hits и repeated_hits с Lua скриптами
  - [x] Пороги: >5/час suspicious, >10/час блокировка, >8 повторов блокировка
  - [x] Создание incidents в MongoDB
  - [x] Публикация в Redis Pub/Sub канал "incidents"
  - [x] Автоматическая блокировка при превышении порогов
- [x] JWT/rate limiting middleware
  - [x] JWT authentication с JwtService (генерация/валидация токенов)
  - [x] JWT claims: sub (user_id), role, group_ids, exp, iat
  - [x] Rate limiting per user (100 req/min) и per IP (200 req/min)
  - [x] Lua скрипты для атомарных операций в Redis
  - [x] Интеграция в роутер с layer middleware
- [x] SSE канал для таймеров
  - [x] GET /sessions/{id}/stream эндпоинт
  - [x] События timer-tick (каждую секунду) с remaining/elapsed/total
  - [x] Событие time-expired при истечении таймера
  - [x] Keep-alive соединение
  - [x] Stream на базе futures::stream
- [x] Транзакции Redis+Mongo обеспечивают идемпотентность начисления баллов и запись попыток.
- [x] OpenAPI/JSON Schema и примеры ответов синхронизированы с реализацией (docs/api/game.yaml).
- [x] Нагрузочное тестирование (≥500 rps на ответы) подтверждает SLA 200 мс p95.

## Тестирование
- **Unit:** `cargo test` для бизнес-логики (scoring, hint cost, таймеры, античит), property-based тесты (`proptest`).
- **Integration:** docker-compose (Mongo, Redis, stub Python) + `cargo test -- --ignored` проверки транзакций и SSE.
- **Contract:** автоматический прогон `openapi-tests` против mock-сервера и фронтового клиента.
- **Performance:** `k6`/`vegeta` профиль — 500 rps на `answers`, 50 rps на `hints`, 10 WebSocket потоков (SLA ≤200 мс).
- **Security:** negative tests на JWT/role guards, ограничение подсказок, rate limiting, CSRF/Replay.
