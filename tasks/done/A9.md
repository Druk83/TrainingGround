# A9 — Генератор заданий (Template Generator)

## Контекст
Согласно `requirements/глоссарий.md` и `архитектура/описание BL.md` (Сценарий 1, шаг 2), система должна генерировать конкретные Task Instances из Task Templates. Python-сервис отвечает за параметризацию шаблонов, морфологический анализ (падежи, склонения) и валидацию. Это критический компонент для формирования уникальных заданий в каждой сессии.

## Состав работ
1. **Template Engine.**
   - Реализовать парсер шаблонов (Jinja2/собственный DSL) с поддержкой параметров: `{{word:noun:genitive}}`, `{{example:sentence}}`.
   - Интеграция с pymorphy2/natasha для морфологического анализа русского языка (склонения, падежи, число).
   - Валидация результата: проверка, что сгенерированный текст соответствует правилу (нет грамматических конфликтов).
2. **Task Instance Service.**
   - API эндпоинт `POST /internal/generate_instances` (вызывается из Rust Session Manager).
   - Принимает параметры: `level_id`, `count`, `user_id` (для адаптивности).
   - Возвращает массив Task Instances с полями: `task_id`, `text`, `correct_answer`, `options` (для MCQ), `metadata`.
3. **Банк словоформ и примеров.**
   - Создать коллекции MongoDB `word_forms` (слова с разбором) и `example_sentences` (корпус предложений).
   - Загрузить seed-данные из существующих словарей (OpenCorpora, НКРЯ).
   - Реализовать индексы для быстрого поиска по части речи, падежу, числу.
4. **Кэширование и дедупликация.**
   - Redis кэш `template:instances:{template_id}` (TTL 10 мин) для переиспользования недавно сгенерированных экземпляров.
   - Механизм дедупликации: не выдавать одно задание дважды одному ученику в течение 24 часов (ключ `seen_tasks:{user_id}`).
5. **Интеграция с Session Manager.**
   - Rust API вызывает Template Generator через REST/gRPC при создании сессии.
   - Обработка ошибок: если генератор недоступен, Session Manager использует fallback на предзагруженные Task Instances из MongoDB.
6. **Тестирование и валидация.**
   - Unit-тесты морфологии: проверка всех падежей/чисел для существительных, прилагательных, глаголов.
   - Integration-тесты: генерация 100 экземпляров из шаблона, проверка уникальности и корректности.
   - Performance: генерация 20 экземпляров за пакет ≤ 2 сек.

## Ожидаемые артефакты
- Python-модуль Template Generator с API и тестами.
- Seed-данные словоформ и примеров в MongoDB.
- Документация по синтаксису шаблонов и интеграции с Rust API.

## Чек-лист готовности
- [x] Template Engine корректно обрабатывает все типы параметров (существительные, глаголы, прилагательные).
- [x] Морфологический анализ работает для всех падежей и чисел русского языка.
- [x] API генерации экземпляров интегрирован с Session Manager и имеет fallback.
- [x] Кэширование и дедупликация работают, ученики не видят повторяющихся заданий в течение 24 часов.
- [x] Seed-данные загружены и индексированы в MongoDB.
- [x] Документация описывает синтаксис шаблонов и примеры использования.

## Тестирование
- **Unit:** `pytest` для морфологии (все падежи/числа), парсинга шаблонов, валидации результатов.
- **Integration:** docker-compose (Mongo, Redis, Python) + тесты генерации из реальных шаблонов тем `orthography`, `syntax`.
- **Data validation:** проверка seed-данных на полноту (покрытие всех частей речи), отсутствие ошибок в словоформах.
- **Performance:** генерация 100 экземпляров параллельно, SLA ≤ 3 сек для пакета 20 заданий.
- **Deduplication:** тест на повторную генерацию для одного пользователя — проверка, что задания не повторяются.
