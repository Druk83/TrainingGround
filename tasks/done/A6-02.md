# A6-02 — UI Ученика (проверка и доработка)

## Контекст
Согласно `requirements/предметная область.md` и `requirements/сценарии/требования.md` (4.1.1, 4.1.2), UI ученика является основным пользовательским интерфейсом системы. Базовые компоненты уже созданы в рамках A1-A5, но требуется полная проверка соответствия требованиям документации и доработка выявленных несоответствий.

**Цель задачи:** Создать тестового ученика через UI суперадминистратора (A6-01) и проверить полный пользовательский флоу согласно требованиям, исправить все несоответствия.

## Состав работ

### 1. Создание тестового пользователя-ученика
**Предусловие:** A6-01 выполнено, UI суперадминистратора работает.

**Действия:**
1. Войти в систему как суперпользователь
2. Создать тестового ученика через /admin/users:
   - Email: `student.test@example.com`
   - ФИО: `Иванов Иван Иванович`
   - Роль: `student`
   - Группа: создать тестовую группу `8А класс тестовый`
   - Пароль: автогенерация или `Test123456`
3. Выйти из системы
4. Войти как созданный ученик

### 2. Проверка страницы авторизации
**Файл:** `frontend/src/pages/login-page.ts`

**Требования из документации:**
- Форма входа (email + password)
- Валидация полей (формат email, минимум пароля)
- Сообщения об ошибках (неверные credentials, заблокированный аккаунт)
- Кнопка "Забыли пароль?" (отправка email со ссылкой)
- Кнопка "Зарегистрироваться" → переход на /register
- Опциональная кнопка "Войти через SSO" (если SSO включен)
- Работа offline: если нет сети, показать сообщение "Вход доступен только online"

**Чек-лист проверки:**
- [ ] Email валидация работает (показывает ошибку при невалидном email)
- [ ] Показывает "Неверный email или пароль" при неправильных credentials
- [ ] Показывает "Аккаунт заблокирован до XX:XX" при заблокированном пользователе
- [ ] Переход на /student-home после успешного входа
- [ ] JWT токен сохраняется в localStorage/sessionStorage
- [ ] Кнопка "Забыли пароль?" открывает модальное окно/переходит на страницу

### 3. Проверка главной страницы ученика
**Файл:** `frontend/src/pages/student-home.ts`

**Требования из документации:**
- **Шапка (app-header):**
  - Логотип/название системы
  - Приветствие "Привет, [Имя]!"
  - Баланс баллов (общий счёт)
  - Кнопка профиля (dropdown: Настройки, Выход)
  - Индикатор статуса соединения (online/offline)

- **Каталог тем (lesson-catalog):**
  - Список доступных тем русского языка (Орфография, Синтаксис, Пунктуация и т.д.)
  - Для каждой темы:
    - Название темы
    - Количество уровней (например, 5 уровней)
    - Прогресс прохождения (пройдено X из Y уровней)
    - Процент правильных ответов (последняя попытка)
    - Индикатор доступности (заблокировано/доступно)
  - Кнопка "Начать" или "Продолжить" для каждого уровня
  - Фильтр по сложности (A1, A2, B1, B2) — опционально
  - Поиск по названию темы — опционально

- **Раздел достижений/прогресса (опционально для MVP):**
  - Общая статистика: пройдено уроков, процент правильных ответов
  - Серия правильных ответов (streak)
  - Достижения (бейджи) — если реализовано

**Чек-лист проверки:**
- [ ] app-header отображает имя ученика
- [ ] app-header показывает баланс баллов (изначально 0)
- [ ] lesson-catalog отображает список тем
- [ ] Для каждой темы показан прогресс (0/5 уровней если не начинал)
- [ ] Клик на "Начать" переходит на /lessons/:topicId/:levelId
- [ ] Индикатор соединения показывает online/offline статус
- [ ] Кнопка профиля открывает dropdown с опциями "Настройки", "Выход"

### 4. Проверка прохождения урока (lesson-player)
**Файл:** `frontend/src/components/lesson-player.ts`

**Требования из документации (AL-1, BL-1):**

**4.1. Начало сессии:**
- При переходе на /lessons/:topicId/:levelId создается Session через API
- Отображается:
  - Название темы и уровня
  - Количество заданий в пакете (например, "Задание 1 из 10")
  - Таймер (countdown от 45/90/180 сек в зависимости от типа задания)
  - Текущий балл сессии
  - Индикатор серии правильных ответов (streak)

**4.2. Отображение задания:**
- Текст задания (question text)
- Варианты ответа:
  - MCQ (Multiple Choice): радиокнопки для выбора одного варианта
  - Text Input: поле для ввода текста
  - True/False: две кнопки "Верно"/"Неверно"
- Кнопка "Проверить ответ" (disabled пока не выбран вариант)
- Кнопка "Получить подсказку" (доступно до 2 раз на уровень)
  - Показывает счетчик "Подсказок: 2" → "Подсказок: 1" → "Подсказок: 0"
  - После 2 использований кнопка disabled

**4.3. Таймер:**
- Countdown таймер в формате MM:SS или SS
- Цвет меняется при критическом времени (<10 сек): жёлтый → красный
- При истечении времени:
  - Автоматическая отправка пустого ответа
  - Ответ считается неверным
  - Переход к следующему заданию

**4.4. Получение подсказки:**
- При клике на "Получить подсказку":
  - Штраф −5 баллов (вычитается ДО получения подсказки)
  - Отображается hint-panel с текстом подсказки
  - Подсказка может содержать:
    - Краткое объяснение правила
    - Примеры использования
    - Подсветку ключевых слов
  - Кнопка "Закрыть" для скрытия подсказки
  - После получения подсказки ученик может ответить на задание

**4.5. Проверка ответа:**
- При клике "Проверить ответ":
  - Отправка ответа на API POST /sessions/:id/answers
  - Показ результата:
    - Верно: зелёная галочка, "+10 баллов" (или "+15" если серия ≥4)
    - Неверно: красный крестик, "+0 баллов", обнуление серии
  - Показ правильного ответа (если неверно)
  - Показ объяснения правила (explanation)
  - Кнопка "Следующее задание"

**4.6. Начисление баллов (требования из документации):**
- Базовый балл за верный ответ: **+10**
- Бонус за серию (streak ≥4): **+5** (итого +15)
- Штраф за подсказку: **−5** (до получения подсказки)
- Штраф за неверный ответ: 0 баллов (серия обнуляется)

**Формула:**
```
score = 0
if (answer_correct):
  score += 10
  if (streak >= 4):
    score += 5  // бонус за серию
else:
  streak = 0

if (hint_used_before_answer):
  score -= 5
```

**4.7. Завершение сессии:**
- После последнего задания:
  - Показ экрана результатов:
    - Итоговый балл
    - Процент правильных ответов (например, 8/10 = 80%)
    - Количество использованных подсказок
    - Средний процент правильных ответов по группе (если доступно)
  - Проверка условия прохождения: **≥80% правильных ответов**
  - Если ≥80%:
    - Кнопка "Следующий уровень" (если есть)
    - Сообщение "Уровень пройден!"
  - Если <80%:
    - Кнопка "Повторить уровень"
    - Сообщение "Требуется ≥80% для прохождения"
  - Кнопка "Вернуться к темам" → /student-home

**Чек-лист проверки:**
- [ ] Таймер корректно отсчитывает время (45/90/180 сек)
- [ ] Таймер меняет цвет при <10 сек
- [ ] При истечении времени автоматически отправляется пустой ответ
- [ ] Кнопка "Получить подсказку" вычитает −5 баллов ДО показа подсказки
- [ ] Счётчик подсказок уменьшается (2 → 1 → 0)
- [ ] После 2 подсказок кнопка disabled
- [ ] При верном ответе начисляется +10 баллов
- [ ] При серии ≥4 начисляется +15 баллов (10 базовых + 5 бонус)
- [ ] При неверном ответе серия обнуляется
- [ ] Показывается объяснение правила после ответа
- [ ] Экран результатов показывает процент правильных ответов
- [ ] При ≥80% доступна кнопка "Следующий уровень"
- [ ] При <80% доступна только кнопка "Повторить уровень"

### 5. Проверка офлайн-режима (PWA)
**Файлы:** `frontend/src/lib/offline-queue.ts`, `frontend/src/sw.ts`

**Требования из документации (TL-1, offline-sync):**
- Service Worker должен кэшировать:
  - Статические ресурсы (HTML, CSS, JS, шрифты)
  - Данные текущей сессии (задания, состояние)
- При потере соединения:
  - Индикатор connection-indicator показывает "Offline"
  - Ответы сохраняются в offline-queue (IndexedDB)
  - Показывается сообщение "Ответы будут отправлены при восстановлении связи"
- При восстановлении соединения:
  - Автоматическая синхронизация offline-queue
  - Показ уведомления "Синхронизировано X ответов"
  - Обновление баланса баллов

**Чек-лист проверки:**
- [ ] Приложение работает при первом заходе без интернета (после установки PWA)
- [ ] При отключении интернета индикатор показывает "Offline"
- [ ] Ответы сохраняются в offline-queue при отсутствии сети
- [ ] При восстановлении сети offline-queue синхронизируется автоматически
- [ ] Баллы обновляются после синхронизации
- [ ] Конфликты разрешаются через conflict-resolver (если есть)

### 6. Проверка профиля ученика
**Файл:** `frontend/src/pages/user-profile.ts`

**Требования из документации:**
- Отображение информации:
  - ФИО
  - Email
  - Группа/класс
  - Дата регистрации
- Статистика:
  - Общий балл (сумма по всем сессиям)
  - Пройдено уроков/уровней
  - Процент правильных ответов (средний)
  - Текущая серия (streak)
  - Лучший результат по каждой теме
- Настройки:
  - Изменение пароля
  - Управление уведомлениями (email, push) — опционально
- Кнопка "Выйти"

**Чек-лист проверки:**
- [ ] Страница /profile отображает корректные данные ученика
- [ ] Общий балл соответствует сумме баллов по сессиям
- [ ] Статистика обновляется после прохождения урока
- [ ] Форма изменения пароля работает (требует старый пароль)
- [ ] Кнопка "Выйти" удаляет JWT и редиректит на /login

### 7. Проверка горячих клавиш (Keyboard shortcuts)
**Файл:** `frontend/src/components/lesson-player.ts`

**Требования из документации и README:**
- `Ctrl+Enter` — отправить ответ из текстового поля (всегда работает)
- `S` — отправить ответ, когда фокус вне текстового поля (требует `VITE_FEATURE_HOTKEYS=true`)
- `H` — запросить подсказку (требует `VITE_FEATURE_HOTKEYS=true`)
- `Esc` — закрыть окно onboarding или панель конфликтов

**Чек-лист проверки:**
- [ ] `Ctrl+Enter` отправляет ответ из текстового поля
- [ ] `S` отправляет ответ (если фича включена)
- [ ] `H` открывает подсказку (если фича включена)
- [ ] `Esc` закрывает модальные окна

## Доработка выявленных несоответствий

### Список потенциальных проблем для исправления:
1. **Начисление баллов:**
   - Проверить формулу: базовый +10, бонус +5 при streak ≥4
   - Убедиться что штраф −5 вычитается ДО получения подсказки
   - Проверить обнуление серии при неверном ответе

2. **Таймер:**
   - Проверить корректные значения: 45/90/180 сек в зависимости от типа задания
   - Проверить автоотправку при истечении времени
   - Проверить смену цвета при <10 сек

3. **Подсказки:**
   - Проверить лимит 2 подсказки на уровень (не на задание!)
   - Проверить что счётчик корректно уменьшается
   - Проверить disabled состояние кнопки после 2 использований

4. **Условие прохождения:**
   - Проверить порог ≥80% правильных ответов
   - Проверить логику кнопок "Следующий уровень" vs "Повторить"

5. **Offline-режим:**
   - Проверить сохранение ответов в IndexedDB
   - Проверить автоматическую синхронизацию при reconnect

6. **UI/UX:**
   - Проверить читаемость текста (контраст, размер шрифта)
   - Проверить адаптивность для мобильных устройств
   - Проверить accessibility (aria-labels, keyboard navigation)

## API Endpoints (проверка существования)

Ученику нужны следующие endpoints:
```
POST   /auth/login                     - Вход
POST   /auth/logout                    - Выход
POST   /auth/password/reset            - Сброс пароля

GET    /catalog/topics                 - Список тем
GET    /catalog/topics/:id/levels      - Уровни темы

POST   /sessions                       - Создать сессию
GET    /sessions/:id                   - Получить сессию
POST   /sessions/:id/answers           - Отправить ответ
POST   /sessions/:id/hints             - Запросить подсказку
GET    /sessions/:id/stream            - SSE поток (таймер, события)

GET    /user/profile                   - Профиль ученика
PUT    /user/profile                   - Обновить профиль
PUT    /user/password                  - Изменить пароль

GET    /progress/:userId               - Прогресс ученика
GET    /achievements/:userId           - Достижения (опционально)
```

**Чек-лист проверки API:**
- [ ] Все endpoints существуют и возвращают корректные данные
- [ ] POST /sessions создаёт сессию с заданиями
- [ ] POST /sessions/:id/answers проверяет ответ и возвращает результат
- [ ] POST /sessions/:id/hints возвращает подсказку и вычитает −5 баллов
- [ ] GET /sessions/:id/stream отправляет SSE события для таймера

## Ожидаемые артефакты

### Доработанные файлы (Frontend)
- `frontend/src/pages/student-home.ts` - исправления после проверки
- `frontend/src/components/lesson-player.ts` - исправления логики баллов, таймера
- `frontend/src/components/timer-display.ts` - исправления отсчёта и цвета
- `frontend/src/components/hint-panel.ts` - исправления логики лимита подсказок
- `frontend/src/components/score-board.ts` - исправления отображения баллов
- `frontend/src/pages/user-profile.ts` - дополнения статистики
- `frontend/src/lib/api-client.ts` - дополнения API методов (если нужно)

### Новые файлы (если требуется)
- `frontend/src/components/lesson-results.ts` - экран результатов сессии
- `frontend/src/lib/scoring.ts` - централизованная логика начисления баллов

### Тесты
- `frontend/src/__tests__/lesson-player.test.ts` - E2E тесты прохождения урока
- `frontend/src/__tests__/scoring.test.ts` - unit-тесты формулы баллов
- `frontend/src/__tests__/offline-sync.test.ts` - тесты offline-режима

### Документация
- `docs/student-guide.md` - руководство для ученика
- `docs/scoring-rules.md` - правила начисления баллов (детальное описание)
- `docs/ui-student-checklist.md` - чек-лист проверки UI ученика

## Чек-лист готовности

- [x] Ученик может войти в систему
- [x] Каталог тем отображает доступные темы и уровни
- [x] Прогресс по темам отображается корректно
- [ ] Сессия создаётся при начале урока
- [x] Таймер работает корректно (45/90/180 сек, автоотправка)
- [x] Подсказки ограничены 2 на уровень
- [x] Штраф −5 баллов вычитается ДО получения подсказки
- [x] Базовый балл +10 начисляется за верный ответ
- [x] Бонус +5 начисляется при серии ≥4
- [x] Серия обнуляется при неверном ответе
- [x] Экран результатов показывает процент и итоговый балл
- [x] Условие прохождения ≥80% работает корректно
- [x] Offline-режим сохраняет ответы и синхронизирует при reconnect
- [x] Профиль отображает статистику ученика
- [x] Горячие клавиши работают согласно документации

### UI/UX
- [ ] Адаптивный дизайн (работает на мобильных)
- [ ] Доступность (accessibility): aria-labels, keyboard navigation
- [ ] Читаемость текста (контраст ≥4.5:1)
- [ ] Понятные сообщения об ошибках
- [ ] Индикация загрузки (spinners, скелетоны)
- [ ] Плавные анимации переходов

### Тестирование
- [ ] Unit-тесты формулы баллов проходят
- [ ] E2E тесты прохождения урока проходят
- [ ] Тесты offline-режима проходят
- [ ] Manual тестирование полного флоу выполнено

### Документация
- [x] Руководство для ученика создано
- [x] Правила начисления баллов задокументированы
- [x] Чек-лист UI ученика создан

## Тестирование

### Manual тестирование (основной сценарий)
1. **Вход в систему:**
   - Открыть /login
   - Ввести email/password тестового ученика
   - Проверить редирект на /student-home

2. **Просмотр каталога:**
   - Проверить отображение тем
   - Проверить прогресс (0/5 уровней для нового ученика)
   - Кликнуть "Начать" на первой теме

3. **Прохождение урока:**
   - Проверить создание сессии
   - Ответить на первое задание верно (проверить +10 баллов)
   - Ответить на 4 задания верно подряд (проверить +15 на 4-м)
   - Запросить подсказку (проверить −5 баллов и уменьшение счётчика)
   - Ответить неверно (проверить обнуление серии)
   - Дождаться истечения таймера (проверить автоотправку)
   - Завершить сессию

4. **Проверка результатов:**
   - Проверить итоговый балл
   - Проверить процент правильных ответов
   - Если ≥80% — проверить кнопку "Следующий уровень"
   - Если <80% — проверить кнопку "Повторить"

5. **Проверка offline-режима:**
   - Начать новый урок
   - Отключить интернет (DevTools → Network → Offline)
   - Ответить на несколько заданий
   - Проверить сохранение в offline-queue
   - Включить интернет
   - Проверить автоматическую синхронизацию
   - Проверить обновление баллов

6. **Проверка профиля:**
   - Открыть /profile
   - Проверить статистику (общий балл, пройдено уроков)
   - Изменить пароль
   - Выйти

### E2E тесты (Playwright)
**Сценарий 1: Успешное прохождение урока**
```typescript
test('student completes lesson with ≥80%', async ({ page }) => {
  await page.goto('/login');
  await page.fill('input[type="email"]', 'student.test@example.com');
  await page.fill('input[type="password"]', 'Test123456');
  await page.click('button[type="submit"]');

  await page.waitForURL('/student-home');
  await page.click('button:has-text("Начать")');

  // Ответить на 8/10 заданий верно (80%)
  for (let i = 0; i < 8; i++) {
    await page.click('input[type="radio"]:first-child'); // выбрать первый вариант
    await page.click('button:has-text("Проверить")');
    await page.click('button:has-text("Следующее")');
  }

  // 2 неверных ответа
  for (let i = 0; i < 2; i++) {
    await page.click('input[type="radio"]:last-child'); // выбрать последний (неверный)
    await page.click('button:has-text("Проверить")');
    await page.click('button:has-text("Следующее")');
  }

  // Проверка результатов
  await expect(page.locator('text=80%')).toBeVisible();
  await expect(page.locator('button:has-text("Следующий уровень")')).toBeEnabled();
});
```

**Сценарий 2: Использование подсказок**
```typescript
test('hint deducts 5 points before showing', async ({ page }) => {
  // ... логин и начало урока ...

  const scoreBeforeHint = await page.locator('.score-board').textContent();
  await page.click('button:has-text("Получить подсказку")');

  // Проверка вычета −5 баллов
  const scoreAfterHint = await page.locator('.score-board').textContent();
  expect(parseInt(scoreAfterHint) - parseInt(scoreBeforeHint)).toBe(-5);

  // Проверка уменьшения счётчика
  await expect(page.locator('text=Подсказок: 1')).toBeVisible();
});
```

**Сценарий 3: Offline синхронизация**
```typescript
test('offline answers sync on reconnect', async ({ page, context }) => {
  // ... логин и начало урока ...

  // Переход в offline
  await context.setOffline(true);
  await expect(page.locator('.connection-indicator.offline')).toBeVisible();

  // Ответ на задание offline
  await page.click('input[type="radio"]:first-child');
  await page.click('button:has-text("Проверить")');

  // Проверка сохранения в offline-queue
  const queueSize = await page.evaluate(() => {
    return window.indexedDB.open('offline-queue').onsuccess;
  });
  expect(queueSize).toBeGreaterThan(0);

  // Переход в online
  await context.setOffline(false);
  await expect(page.locator('text=Синхронизировано')).toBeVisible();

  // Проверка обновления баллов
  await expect(page.locator('.score-board')).not.toHaveText('0');
});
```

### Unit-тесты (логика баллов)
```typescript
describe('Scoring logic', () => {
  test('correct answer gives +10 points', () => {
    const score = calculateScore({ correct: true, streak: 0, hintUsed: false });
    expect(score).toBe(10);
  });

  test('correct answer with streak ≥4 gives +15 points', () => {
    const score = calculateScore({ correct: true, streak: 4, hintUsed: false });
    expect(score).toBe(15);
  });

  test('hint deducts 5 points', () => {
    const score = calculateScore({ correct: true, streak: 0, hintUsed: true });
    expect(score).toBe(5); // 10 - 5
  });

  test('incorrect answer resets streak', () => {
    const result = processAnswer({ correct: false, currentStreak: 5 });
    expect(result.newStreak).toBe(0);
  });
});
```

## Зависимости

**Требует:**
- A6-01 (UI Суперпользователя) — для создания тестового ученика
- TD-06 (Authentication) — JWT, login/logout
- Backend API endpoints для сессий и ответов

**Блокирует:**
- A9 (Генератор заданий) — нужен рабочий UI для тестирования генератора

**Опционально:**
- A10 (Feature Flags) — для включения/выключения фич (горячие клавиши)
- A7 (Античит) — для тестирования блокировок

## Оценка времени

- Создание тестового ученика и проверка: 2 часа
- Исправление выявленных багов: 8-16 часов (зависит от количества проблем)
- Написание E2E тестов: 6 часов
- Написание unit-тестов: 4 часа
- Документация: 4 часа

**Итого:** ~24-32 часа (3-4 рабочих дня)

## Приоритизация

### P0 (Must-fix для MVP)
1. Формула начисления баллов (+10, +15 при streak, −5 за подсказку)
2. Лимит 2 подсказки на уровень
3. Условие прохождения ≥80%
4. Таймер с автоотправкой
5. Offline-режим (базовый)

### P1 (Важно для UX)
6. Экран результатов с детальной статистикой
7. Горячие клавиши
8. Адаптивный дизайн
9. Профиль с историей

### P2 (Nice-to-have)
10. Достижения/бейджи
11. Анимации переходов
12. Звуковые эффекты

## Успешное завершение

Задача считается выполненной, когда:
1. Создан тестовый ученик через UI суперадминистратора
2. Проверен полный флоу прохождения урока
3. Формула баллов работает корректно согласно требованиям
4. Лимит подсказок (2 на уровень) работает
5. Условие прохождения (≥80%) работает
6. Offline-режим сохраняет ответы и синхронизирует
7. Все выявленные баги исправлены
8. E2E и unit-тесты проходят
9. Документация для ученика создана
10. Manual тестирование полного сценария выполнено успешно

После выполнения A6-02 можно переходить к A9 (Генератор заданий), используя проверенный UI для тестирования.

## Дополнительные правки (A6-02-2)

На основе требований `requirements/сценарии/требования.md` (п.4.2.1) и паспорта проекта UI прохождения курса доработан:
- убраны отладочные формы `ID ученика / ID группы / JWT` из `app-shell.ts`, данные пользователя берутся из `lessonStore.setUser` после логина;
- `lesson-catalog` и `connection-indicator` отображают чистые русские подписи и реальные данные из стора;
- `lesson-player` показывает счётчик задания, единый канал уведомлений и блокирует кнопку на время отправки ответа;
- `lesson-results` появляется только после окончания урока, добавлены кнопки «Повторить» и «Вернуться к темам»;
- стор отслеживает `sessionProgress`, поэтому в плеере отображается «Задание X из Y», а карточка активного курса сразу доступна в каталоге;
- сообщения из API (`feedback`, статусы очереди) показываются один раз возле формы, а индикатор связи автоматически очищает статус «Синхронизация…» после завершения.
