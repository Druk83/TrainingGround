# TD-06-1 — Управление обогащением шаблонов контент-админом

## Контекст
Согласно требованиям из `requirements/сценарии/требования.md` контентная команда обязана регулярно пополнять банк заданий (до 50 000 шаблонов и 1 млн экземпляров), а также поддерживать качество материалов. Сейчас админка позволяет завести шаблон, но дальнейшая генерация заданий происходит «в фоне», без интерфейса управления, без возможности задать лимиты или проверить результат. В результате:

- админ не знает, сколько задач сгенерировал Python‑сервис;
- невозможно оперативно удалить/заменить неудачную вариацию;
- история запусков обогащения не фиксируется.

Нужно расширить UI и API, чтобы обогащение стало явным управляемым шагом контент‑админа, без привлечения отдельной ML или QA команды.

## Цели задачи
1. Дать контент‑админу отдельную вкладку «Обогащение» рядом с уже существующими «Качество» и «Эмбеддинги».
2. Позволить задавать лимиты ИИ‑генерации, хранить их в шаблоне и передавать в Python‑сервис.
3. Показать человеку список сгенерированных задач (читаемый вид) и дать инструменты работы с конкретной вариацией.
4. Логировать все действия, чтобы можно было отследить, кто запускал обогащение и редактировал варианты.

## Функциональные требования

### 1. Вкладка «Обогащение»
- В компоненте шаблона (где уже используется `<div class="tabs">`) добавить новую вкладку.
- Содержимое:
  - краткая инструкция по обогащению (markdown/alert);
  - форма запуска генерации;
  - блок истории запусков (таблица: дата, инициатор, параметр `count`, статус, кол-во успешных/ошибочных задач).
- Переход на вкладку возможен только для ролей `content_admin` / `admin`.

### 2. Настройка лимитов генерации
- Форма включает:
  - числовое поле «Количество вариаций» (min=1, max=200, дефолт подтягивается из `ENV`/шаблона; значение хранится в `template.metadata.generation_settings.count`);
  - поле «Порог отказа» — ограничение на общее число задач, которые можно сгенерировать за сутки по данному шаблону (используется для защиты от случайного многократного запуска);
  - чекбокс «Разрешить повтор ранее показанных шаблонов» (передаёт флаг `allow_reuse` в Python‑API);
  - кнопку «Запустить генерацию».
- После сабмита:
  - значения `count`, `reject_limit`, `allow_reuse` сохраняются в документе шаблона (`metadata.generation_settings`);
  - backend вызывает Python‑генератор c этими параметрами (новый endpoint или расширение существующего `/internal/generate_instances`);
  - результат записывается в лог действий + коллекцию для историй.
- Валидация: блокировать отправку, если уровень не опубликован или генерация уже в процессе (debounce + статус).

### 3. Просмотр сгенерированных вопросов
- Ниже формы отображается таблица (или карточки), получающая данные из коллекции `tasks` по `template_id`.
- Колонки:
  - текст задания;
  - варианты ответа;
  - правильный ответ;
  - дата создания;
  - статус (активно/отклонено/перегенерация в процессе).
- Реализовать пагинацию и поиск (по тексту/дате) — чтобы можно было отсмотреть 50+ задач.
- Дополнительно: кнопка «Скачать CSV» для офлайн‑проверки (опционально — хотя бы TODO).

### 4. Управление вариантами
- Для каждой строки:
  - действие «Удалить» — помечает запись как отклонённую (`status=rejected`, `deleted_at`, удаление из Redis‑кешей, опционально физическое удаление).
  - действие «Перегенерировать» — отправляет в Python‑сервис запрос на генерацию **одной** новой задачи и заменяет содержимое текущей записи (с сохранением ссылки на предыдущий текст).
- При удалении/перегенерации обязательна модалка подтверждения.
- API должно валидировать, что операция выполняется пользователем с правами контент‑админа; результат логируется в `audit_log`.

### 5. История действий
- Добавить коллекцию/таблицу `template_enrichment_runs`:
  - `id`, `template_id`, `user_id`, `count`, `allow_reuse`, `started_at`, `finished_at`, `status`, `success_count`, `error_count`, `error_message`.
- Каждое удаление/перегенерация пишется в `audit_log` (тип события `template_item_update`), чтобы можно было восстановить контекст.

## Нефункциональные требования
- Ошибки генерации (409, timeout) отображаются в UI и записываются в историю.
- Ограничить количество параллельных запусков обогащения (например, 1 прогон на шаблон).
- Покрыть новую бизнес-логику unit-/integration-тестами:
  - API для запуска генерации и управления задачами;
  - фронтовые компоненты (видимость вкладки, формы, таблицы).
- Обновить документацию в `docs/content-admin.md` (как пользоваться вкладкой).

## Зависимости
- Python‑генератор: потребуется расширенный endpoint, принимающий `count`, `allow_reuse` и `template_id`.
- MongoDB: дополнительные поля в документах `templates` и `tasks`, новая коллекция для истории.
- Redis: чистка кешей при удалении/перегенерации конкретных задач.

## Технический план реализации

### Backend (Rust API)

Добавить новые модели в `src/models/content.rs`:
```rust
pub struct TemplateEnrichmentRun {
    pub id: Option<ObjectId>,
    pub template_id: ObjectId,
    pub user_id: ObjectId,
    pub count: u32,
    pub allow_reuse: bool,
    pub started_at: DateTime<Utc>,
    pub finished_at: Option<DateTime<Utc>>,
    pub status: String, // in_progress, completed, failed
    pub success_count: u32,
    pub error_count: u32,
    pub error_message: Option<String>,
}

pub struct TemplateEnrichmentRequest {
    pub count: u32,        // 1-200
    pub reject_limit: Option<u32>,
    pub allow_reuse: bool,
}
```

Добавить endpoints в `src/handlers/admin/`:
```
POST /api/admin/templates/{template_id}/enrich
GET /api/admin/templates/{template_id}/enrichment-runs
DELETE /api/admin/templates/{template_id}/tasks/{task_id}
POST /api/admin/templates/{template_id}/tasks/{task_id}/regenerate
```

Обновить структуру template.metadata:
```json
{
  "generation_settings": {
    "count": 20,
    "reject_limit": 500,
    "allow_reuse": false
  }
}
```

### Python Generator

Расширить endpoint `/internal/generate_instances`:
- Параметр: `template_id`, `count`, `allow_reuse`
- При `count` вызывает генерацию N экземпляров вместо 1

Новый endpoint `/internal/regenerate_single_instance`:
- Параметр: `task_id`
- Генерирует 1 новый экземпляр вместо текущего

### Frontend

Добавить вкладку «Обогащение» в компонент template-management:
- Форма с полями: count, reject_limit, allow_reuse
- Таблица истории запусков (template_enrichment_runs)
- Таблица сгенерированных задач с пагинацией
- Кнопки: Удалить задачу, Перегенерировать
- Модалки подтверждения для деструктивных операций

### MongoDB изменения

Коллекция `template_enrichment_runs`:
```json
{
  "_id": ObjectId,
  "template_id": ObjectId,
  "user_id": ObjectId,
  "count": 20,
  "allow_reuse": false,
  "started_at": ISODate,
  "finished_at": ISODate,
  "status": "completed|in_progress|failed",
  "success_count": 20,
  "error_count": 0,
  "error_message": null
}
```

Обновить коллекцию `tasks`:
- Добавить поле `status`: active|rejected (для помеченных как удалённые)
- Добавить поле `deleted_at`: ISODate (опционально)
- Добавить в metadata поле `enrichment_run_id` для связи

## Ожидаемый результат
После реализации у контент‑администраторов появится понятный цикл работы:
1. Публикуют шаблон.
2. Заходят на вкладку «Обогащение», задают лимиты, запускают генерацию.
3. Проверяют список задач, удаляют или перегенерируют сомнительные варианты.
4. Набор vetted‑задач готов к выдаче ученикам, а история действий зафиксирована.

## UX сценарии и требования к интерфейсу

### Состояние 1: Пустой список (новый шаблон)
При отсутствии сгенерированных задач:
- Таблица истории пуста: заглушка "История запусков отсутствует"
- Таблица задач отображает выраженный CTA (call-to-action):
  - Серая иконка + текст: "Сгенерированных вариаций нет"
  - Подтекст: "Заполните форму ниже и нажмите 'Запустить генерацию' для создания первых вариантов"
  - Кнопка "Запустить" активна и выделена

### Состояние 2: Генерация в процессе
Когда запущена генерация (status='in_progress'):
- Форма ввода (поля count, reject_limit, allow_reuse): все элементы disabled (серые)
- Кнопка "Запустить генерацию": disabled, показывает спиннер + текст "Генерируется..."
- Таблица истории: новая строка с иконкой спиннера и статусом "In Progress", отсчёт времени {elapsed}s
- Таблица задач: в реальном времени добавляются новые строки по мере их создания (polling GET /tasks каждые 2 сек)
  - Если задача только создана: мягкое выделение (highlight) на 3 сек
  - Счётчик над таблицей: "Создано {success_count}/{count} вариаций"
- При попытке левой вкладки: warning toast "Генерация не завершена, оставьте вкладку открытой для отслеживания"

### Состояние 3: Генерация завершена успешно
После завершения (status='completed', error_count=0):
- Форма активна (все поля enabled)
- Toast уведомление (зелёный, 5 сек): "Успешно создано {success_count} вариаций"
- Таблица истории: статус "Completed" (зелёный бейдж), показаны success_count и error_count, время завершения
- Таблица задач: обновлена полностью, первые новые задачи выделены (highlight 3 сек)

### Состояние 4: Генерация с частичным успехом
После завершения (status='completed', error_count>0):
- Toast уведомление (жёлтый, 7 сек): "Создано {success_count} вариаций, {error_count} ошибок"
- Таблица истории: статус "Completed with errors" (жёлтый бейдж)
  - Строка имеет иконку информации (i), при наведении tooltip показывает error_message
  - Например: "Ошибка: не удалось сгенерировать 3 варианта из-за timeout при вызове Python API"
- Таблица задач: показывает все успешно созданные, в истории их count
- Кнопка "Повторить" рядом с историей запуска для перезапуска с теми же параметрами

### Состояние 5: Генерация завершена с критической ошибкой
После завершения (status='failed'):
- Форма активна
- Error alert (красный, не исчезает): "Ошибка генерации: {error_message}"
  - Например: "Ошибка генерации: Python API недоступен (500 Internal Server Error)"
  - Кнопка "Повторить" в alert'е
- Таблица истории: статус "Failed" (красный бейдж), сообщение об ошибке видно при клике
- Таблица задач: показывает только те задачи, которые были успешно созданы до ошибки

### Состояние 6: Дневной лимит исчерпан
При достижении reject_limit:
- Форма активна, но кнопка "Запустить генерацию" disabled
- Кнопка имеет tooltip: "Дневной лимит исчерпан ({current}/{reject_limit}). Попробуйте завтра или повысьте лимит."
- Over the form: yellow alert "Использовано {current}/{reject_limit} вариаций в эту сутки (обновляется в 00:00 UTC)"
- Таблица истории: последний запуск имеет статус "Rejected - daily limit reached" (серый бейдж)

### Состояние 7: Параллельный запуск уже идёт
При попытке запустить, когда для шаблона уже в процессе другая генерация:
- Форма активна, кнопка disabled
- Tooltip: "Генерация для этого шаблона уже в процессе (started_at: {time}, iniciator: {user.email})"
- Info alert: "Дождитесь завершения текущей генерации перед запуском новой"

### Состояние 8: Перегенерация одной задачи
При клике "Перегенерировать" на конкретную строку:
- Модалка подтверждения: "Заменить текущий вариант новым сгенерированным вариантом? Старый текст сохранится в истории."
  - Показан текущий текст задачи для контекста
  - Кнопки: "Отмена" и "Перегенерировать"
- После подтверждения: спиннер на кнопке конкретной строки (другие кнопки ряда disabled)
- После завершения (2-5 сек):
  - Текст задачи обновляется
  - Старый текст сохраняется в metadata.previous_text (не видно в UI, но в audit_log)
  - На строке появляется badge "Перегенерирована {дата} {user.name}"
  - Toast: "Вариант успешно перегенерирован"

### Состояние 9: Удаление задачи
При клике "Удалить" на конкретную строку:
- Модалка подтверждения: "Удалить этот вариант? Он будет помечен как rejected и больше не показываться ученикам."
  - Показан текст задачи для контекста
  - Кнопки: "Отмена" и "Удалить"
- После подтверждения:
  - Строка таблицы становится серой
  - Текст зачёркивается
  - На строке появляется badge "Удалена {дата} {user.name}"
  - Кнопка "Удалить" заменяется на "Восстановить" (опционально, только для админов)
  - Toast: "Вариант удалён"

### Состояние 10: Поиск и фильтрация задач
- Над таблицей задач: input поля для поиска
- Поиск по тексту: выделяет совпадения в результатах
- Фильтр по статусу (Active / Rejected / All): переключатель
- Пагинация: по 10 задач на странице, кнопки "Пред" / "След" и indicator "страница {current}/{total}"

## API форматы и спецификация

### Endpoint: POST /api/admin/templates/{template_id}/enrich
Запуск генерации новых вариантов

Тело запроса:
```json
{
  "count": 20,
  "reject_limit": 500,
  "allow_reuse": false
}
```

Параметры:
- `count` (integer, required): количество вариантов для генерации (1-200)
- `reject_limit` (integer, optional): максимум вариантов в сутки (по умолчанию из ENV)
- `allow_reuse` (boolean, optional): показывать ли шаблоны, которые уже видел пользователь (по умолчанию false)

Успешный ответ (200 OK):
```json
{
  "enrichment_run_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "in_progress",
  "message": "Enrichment started for template. 20 variants queued.",
  "started_at": "2025-01-06T10:30:00Z"
}
```

Ошибка: шаблон не найден (404):
```json
{
  "error": "Template not found",
  "code": "ERR_TEMPLATE_NOT_FOUND"
}
```

Ошибка: шаблон не опубликован (400):
```json
{
  "error": "Only published templates can be enriched",
  "code": "ERR_TEMPLATE_NOT_READY",
  "current_status": "draft"
}
```

Ошибка: count вне диапазона (400):
```json
{
  "error": "Count must be between 1 and 200",
  "code": "ERR_INVALID_COUNT",
  "received": 250
}
```

Ошибка: недостаточно прав (403):
```json
{
  "error": "Forbidden",
  "message": "Only content_admin or admin roles can perform enrichment operations",
  "code": "ERR_INSUFFICIENT_PERMISSIONS",
  "user_role": "teacher"
}
```

Ошибка: генерация уже в процессе (409):
```json
{
  "error": "Enrichment already in progress",
  "code": "ERR_ENRICHMENT_IN_PROGRESS",
  "enrichment_run_id": "550e8400-e29b-41d4-a716-446655440000",
  "started_at": "2025-01-06T10:25:00Z",
  "initiated_by": "admin@example.com"
}
```

Ошибка: дневной лимит достигнут (429):
```json
{
  "error": "Daily limit reached",
  "code": "ERR_DAILY_LIMIT_EXCEEDED",
  "current_count": 500,
  "limit": 500,
  "resets_at": "2025-01-07T00:00:00Z"
}
```

### Endpoint: GET /api/admin/templates/{template_id}/enrichment-runs
Получить историю запусков для шаблона

Query параметры (опциональные):
- `limit` (integer, default 50): максимум записей
- `offset` (integer, default 0): смещение для пагинации
- `status` (string): фильтр по статусу (in_progress|completed|failed)

Ответ (200 OK):
```json
{
  "total": 5,
  "runs": [
    {
      "enrichment_run_id": "550e8400-e29b-41d4-a716-446655440000",
      "template_id": "507f1f77bcf86cd799439011",
      "user_id": "507f1f77bcf86cd799439012",
      "user_email": "admin@example.com",
      "count": 20,
      "allow_reuse": false,
      "started_at": "2025-01-06T10:30:00Z",
      "finished_at": "2025-01-06T10:35:42Z",
      "status": "completed",
      "success_count": 20,
      "error_count": 0,
      "error_message": null,
      "duration_seconds": 342
    }
  ]
}
```

Ошибка: шаблон не найден (404):
```json
{
  "error": "Template not found",
  "code": "ERR_TEMPLATE_NOT_FOUND"
}
```

### Endpoint: DELETE /api/admin/templates/{template_id}/tasks/{task_id}
Пометить задачу как удалённую (rejected)

Успешный ответ (204 No Content): пустое тело

Ошибка: задача не найдена (404):
```json
{
  "error": "Task not found",
  "code": "ERR_TASK_NOT_FOUND"
}
```

Ошибка: недостаточно прав (403):
```json
{
  "error": "Forbidden",
  "code": "ERR_INSUFFICIENT_PERMISSIONS"
}
```

### Endpoint: POST /api/admin/templates/{template_id}/tasks/{task_id}/regenerate
Перегенерировать одну задачу

Тело запроса (опциональное):
```json
{
  "regeneration_run_id": "550e8400-e29b-41d4-a716-446655440001"
}
```

Успешный ответ (200 OK):
```json
{
  "task_id": "507f1f77bcf86cd799439013",
  "template_id": "507f1f77bcf86cd799439011",
  "previous_text": "By next year, they {{verb:will_have}} completed the project",
  "text": "By the end of next year, they will have finished all tasks",
  "correct_answer": "will have",
  "options": ["will", "would have", "will have"],
  "regenerated_at": "2025-01-06T10:40:00Z",
  "regenerated_by": "admin@example.com"
}
```

Ошибка: задача не найдена (404):
```json
{
  "error": "Task not found",
  "code": "ERR_TASK_NOT_FOUND"
}
```

Ошибка: перегенерация не удалась (500):
```json
{
  "error": "Failed to regenerate task",
  "code": "ERR_REGENERATION_FAILED",
  "details": "Python API returned 500: Internal Server Error"
}
```

### Контроль доступа API
- Только пользователи с ролями `admin` или `content_admin` могут вызывать эндпоинты обогащения
- При попытке вызова от пользователя без прав: ответ 403 Forbidden с сообщением "Доступ запрещён"
- Каждая попытка несанкционированного доступа логируется в audit_log с типом события `unauthorized_enrichment_attempt`

### Ответ API при 403:
```json
{
  "error": "Forbidden",
  "message": "Only content_admin or admin roles can perform enrichment operations",
  "code": "ERR_INSUFFICIENT_PERMISSIONS"
}
```

### Логирование попыток доступа
Запись в audit_log даже при ошибке 403 должна содержать:
- timestamp
- user_id
- ip_address
- attempted_action (enrichment_start, task_delete, etc.)
- resource_id (template_id)
- status: forbidden
- details: "User role: {role}"

### Frontend контроль доступа
- Вкладка "Обогащение" видна в коде компонента, но доступна (не disabled) только если пользователь имеет нужные роли
- При загрузке страницы: проверить current_user.roles и скрыть/показать вкладку
- Если неавторизованный пользователь попытается получить /enrichment-runs напрямую: 403 ответ, редирект на login

## Рейт-лимиты и квоты

### Глобальные рейт-лимиты (на уровне Rust API)
- Максимум 1 одновременно выполняемая генерация на шаблон (использовать Redis lock с ключом `enrichment:lock:{template_id}`)
- Время жизни lock: 3600 сек (если генерация затянулась, lock протухает и можно запустить новую)
- При попытке запустить при активном lock: ответ 409 Conflict с сообщением "Генерация для этого шаблона уже в процессе (started_at: {time})"

### Дневные лимиты (на уровне задачи)
- Параметр `reject_limit` в форме задаёт максимум задач в сутки для конкретного шаблона
- Проверка: перед запуском генерации получить count(tasks where template_id={id} AND created_at > now - 24h) и сравнить с reject_limit
- Если лимит исчерпан: ответ 429 Too Many Requests с сообщением "Daily limit reached: {current}/{reject_limit}"
- В UI: отобразить прогресс-бар "Использовано {current}/{reject_limit} вариаций в эту сутки"

### Redis ключи для блокировок:
```
enrichment:lock:{template_id} -> expires_at + caller_user_id (для отладки)
enrichment:daily_count:{template_id}:{date} -> integer (обновляется при завершении)
```

### Глобальный limit на систему (опционально)
- Если нужна защита от DDoS: максимум 10 одновременно работающих генераций на всю систему
- Проверка: количество записей в template_enrichment_runs где status='in_progress'
- Если превышено: ответ 503 Service Unavailable "Too many active enrichment operations, please wait"

## Оповещения и обновление статуса в реальном времени

### Механизм обновления (фронтенд -> бэк)
- Админ находится на вкладке "Обогащение" и видит таблицу истории со статусом "in_progress"
- Frontend: polling GET /api/admin/templates/{template_id}/enrichment-runs каждые 2 секунды
- При получении статуса "completed" или "failed": polling останавливается
- Таблица задач также обновляется polling GET /api/admin/templates/{template_id}/tasks каждые 2 сек во время генерации

### Toast уведомления (UI feedback)
После завершения генерации показывается toast (5-7 сек):
- При 100% успехе (error_count=0): зелёный toast "Успешно создано {count} вариаций"
- При частичном успехе (error_count>0): жёлтый toast "Создано {success_count} вариаций, {error_count} ошибок"
- При полной ошибке (status=failed): красный toast "Ошибка генерации: {error_message}"

### Если админ уходит со вкладки
- Генерация продолжает работать на сервере (асинхронный процесс)
- При возврате на вкладку: история загружается заново и покажет актуальный статус
- В логах (audit_log) фиксируется, что админ оставил вкладку (опционально)

### Будущие расширения (не в этой версии)
- Email уведомление: если error_count > 20% от count (опционально)
- Webhook: POST на external URL при завершении (для интеграции с внешними системами)
- In-app notification center: история всех генераций с фильтром и поиском

## Требования к Python генератору и контракт API

### Endpoint: POST /internal/generate_instances
Генерирует N вариантов задач из одного шаблона

Тело запроса:
```json
{
  "template_id": "507f1f77bcf86cd799439011",
  "count": 20,
  "allow_reuse": false,
  "enrichment_run_id": "550e8400-e29b-41d4-a716-446655440000",
  "user_id": "507f1f77bcf86cd799439012"
}
```

Логика обработки:
1. Получить шаблон из MongoDB по template_id
2. Если allow_reuse=false: исключить из выборки templates, которые уже видел пользователь
3. Для каждого из count итераций: сгенерировать, сохранить сразу в MongoDB, на ошибку логировать и продолжить
4. После всех итераций: обновить статус enrichment_run_id в MongoDB.template_enrichment_runs

Успешный ответ (200 OK):
```json
{
  "enrichment_run_id": "550e8400-e29b-41d4-a716-446655440000",
  "success_count": 20,
  "error_count": 0,
  "duration_seconds": 45,
  "instances": [
    {
      "task_id": "507f1f77bcf86cd799439014",
      "text": "By the end of next year, they will have finished all projects",
      "correct_answer": "will have",
      "options": ["will", "would have", "will have"],
      "status": "success"
    }
  ]
}
```

Частичный успех (200 OK, error_count>0):
```json
{
  "enrichment_run_id": "550e8400-e29b-41d4-a716-446655440000",
  "success_count": 18,
  "error_count": 2,
  "duration_seconds": 45,
  "error_details": "Timeout on 2 instances",
  "instances": [
    {
      "task_id": "507f1f77bcf86cd799439014",
      "text": "...",
      "correct_answer": "will have",
      "options": [...],
      "status": "success"
    },
    {
      "task_id": null,
      "text": null,
      "status": "error",
      "error_message": "Timeout: generation took > 5 sec"
    }
  ]
}
```

### Endpoint: POST /internal/regenerate_single_instance
Перегенерирует одну задачу

Успешный ответ (200 OK):
```json
{
  "task_id": "507f1f77bcf86cd799439014",
  "template_id": "507f1f77bcf86cd799439011",
  "previous_text": "By next year, they will have completed the project",
  "text": "By the end of next year, they will have finished all their work",
  "correct_answer": "will have",
  "options": ["will", "would have", "will have"],
  "regenerated_at": "2025-01-06T10:40:00Z"
}
```

### Логирование ошибок
Каждая ошибка логируется: timestamp, enrichment_run_id, task_id, error_type, error_message, duration_ms

## Миграции данных

### Миграция 1: Добавить поля в коллекцию tasks
Файл: `backend/python-generator/migrations/001_add_task_status.js`
```javascript
db.tasks.updateMany(
  { status: { $exists: false } },
  { $set: { status: "active" } }
);

db.tasks.updateMany(
  { deleted_at: { $exists: false } },
  { $set: { deleted_at: null } }
);

````

## Миграции данных

### Миграция 1: Добавить поля в коллекцию tasks
Файл: `backend/python-generator/migrations/001_add_task_status.js`
```javascript
db.tasks.updateMany(
  { status: { $exists: false } },
  { $set: { status: "active" } }
);

db.tasks.updateMany(
  { deleted_at: { $exists: false } },
  { $set: { deleted_at: null } }
);

db.tasks.createIndex({ status: 1 });
db.tasks.createIndex({ deleted_at: 1 });
```

## Аудит и безопасность: формат записей в audit_log

Каждая операция обогащения должна быть залогирована в `audit_log` коллекции с полями:

```json
{
  "_id": ObjectId,
  "timestamp": ISODate("2025-01-06T10:30:00Z"),
  "user_id": ObjectId("507f1f77bcf86cd799439012"),
  "user_email": "admin@example.com",
  "action_type": "enrichment_started|task_deleted|task_regenerated",
  "resource_type": "template|task",
  "resource_id": ObjectId,
  "old_value": null,
  "new_value": {
    "count": 20,
    "reject_limit": 500,
    "allow_reuse": false
  },
  "status": "success|failure|forbidden",
  "ip_address": "192.168.1.100",
  "http_method": "POST|DELETE",
  "http_endpoint": "/api/admin/templates/{id}/enrich",
  "response_code": 200,
  "details": "Enrichment started with 20 variants"
}
```

Типы событий:
- `enrichment_started`: админ нажал кнопку "Запустить генерацию"
- `enrichment_completed`: генерация завершена (success_count, error_count)
- `enrichment_failed`: генерация упала (error_message)
- `task_deleted`: админ удалил задачу (которая была удалена, текст задачи)
- `task_regenerated`: админ перегенерировал задачу (old_text, new_text)
- `unauthorized_enrichment_attempt`: попытка доступа без прав (user_role)

Доступ к audit_log:
- Только админы и аудиторы могут читать audit_log
- История доступна через отдельный endpoint (опционально): GET /api/admin/audit-log?resource_type=template&resource_id={id}
- Записи не удаляются (immutable)

## E2E тестовые сценарии для QA

### Сценарий 1: Полный цикл генерации и управления задачами
Предусловия: админ залогирован, существует published шаблон "Future Perfect Exercise"

Шаги:
1. Переходит на страницу шаблона и открывает вкладку "Обогащение"
2. Проверяет, что вкладка видна и форма доступна
3. Заполняет форму: count=10, reject_limit=50, allow_reuse=false
4. Нажимает "Запустить генерацию"
5. Проверяет, что форма disabled и показывается спиннер с сообщением "Генерируется..."
6. Ждёт завершения (примерно 30-60 сек)
7. Проверяет, что появился toast "Успешно создано 10 вариаций"
8. Проверяет таблицу истории: есть одна строка со статусом "completed", success_count=10, error_count=0
9. Проверяет таблицу задач: ровно 10 новых строк, все со статусом "active"
10. Выбирает одну задачу и нажимает "Удалить"
11. Подтверждает в модалке
12. Проверяет, что строка задачи стала серой и помечена "Удалена"
13. Проверяет другую задачу и нажимает "Перегенерировать"
14. Подтверждает в модалке
15. Ждёт завершения (5-10 сек)
16. Проверяет, что текст задачи изменился и появился badge "Перегенерирована"

Ожидаемый результат: все операции выполнены успешно, UI обновляется правильно, toast'ы показываются, history сохраняется

### Сценарий 2: Дневной лимит и защита от параллельных запусков
Предусловия: админ залогирован, шаблон уже имеет 40 существующих tasks, reject_limit=50

Шаги:
1. Открывает вкладку "Обогащение"
2. Проверяет alert "Использовано 40/50 вариаций в эту сутки"
3. Пытается запустить с count=20 (что превышает лимит 50-40=10)
4. Получает ошибку: "Daily limit reached: 40/50. Попробуйте завтра или понизьте count до 10"
5. Кнопка "Запустить" остаётся disabled
6. Открывает другое окно браузера с той же страницей
7. В первом окне нажимает "Запустить генерацию" с count=10
8. Сразу же (пока идёт генерация) во втором окне пытается нажать "Запустить генерацию"
9. Получает ошибку: "Генерация для этого шаблона уже в процессе (started_at: {time})"
10. Кнопка disabled, tooltip показывает время начала

Ожидаемый результат: лимиты соблюдены, параллельные запуски заблокированы

### Сценарий 3: Ошибка при генерации и восстановление
Предусловия: админ залогирован, Python API намеренно вернул ошибку на 50% задач

Шаги:
1. Открывает вкладку "Обогащение"
2. Нажимает "Запустить генерацию" с count=20
3. Ждёт примерно 1 минуту
4. Проверяет, что появился yellow toast "Создано 10 вариаций, 10 ошибок"
5. История показывает статус "Completed with errors" (жёлтый бейдж)
6. При наведении на историю показывается tooltip с ошибкой
7. Таблица задач показывает только 10 успешных вариантов
8. Видит кнопку "Повторить" рядом с историей
9. Нажимает "Повторить"
10. Форма заполняется теми же значениями (count=20, allow_reuse=false, etc.)
11. Снова нажимает "Запустить генерацию"
12. На этот раз все 20 успешны

Ожидаемый результат: ошибки обработаны корректно, админ может повторить попытку

### Сценарий 4: Пустой список и CTA
Предусловия: создан новый шаблон, никогда не запускалась генерация

Шаги:
1. Переходит на страницу шаблона, вкладка "Обогащение"
2. Проверяет, что история пуста с текстом "История запусков отсутствует"
3. Таблица задач показывает CTA: иконка + "Сгенерированных вариаций нет"
4. Подтекст: "Заполните форму ниже и нажмите 'Запустить генерацию'..."
5. Кнопка "Запустить" выделена и активна

Ожидаемый результат: пустое состояние понятно и приглашает к действию

### Сценарий 5: Права доступа
Предусловия: есть два пользователя: teacher и content_admin

Шаги (teacher):
1. Логируется как teacher
2. Открывает страницу шаблона
3. Вкладка "Обогащение" либо вообще не видна, либо видна но disabled
4. Пытается напрямую вызвать API POST /api/admin/templates/{id}/enrich
5. Получает ответ 403 Forbidden: "Only content_admin or admin roles can perform enrichment operations"

Шаги (content_admin):
1. Логируется как content_admin
2. Открывает страницу шаблона
3. Вкладка "Обогащение" видна и активна
4. Может заполнить форму и запустить генерацию

Ожидаемый результат: права работают корректно, неавторизованный доступ блокирован

### Миграция 2: Создать коллекцию template_enrichment_runs
Файл: `backend/python-generator/migrations/002_create_enrichment_runs.js`
```javascript
db.createCollection("template_enrichment_runs");

db.template_enrichment_runs.createIndex({ template_id: 1 });
db.template_enrichment_runs.createIndex({ user_id: 1 });
db.template_enrichment_runs.createIndex({ created_at: 1 });
db.template_enrichment_runs.createIndex({ status: 1 });
```

### Миграция 3: Обновить структуру templates
Файл: `backend/python-generator/migrations/003_add_generation_settings.js`
```javascript
db.templates.updateMany(
  { "metadata.generation_settings": { $exists: false } },
  { $set: { 
    "metadata.generation_settings": {
      count: 20,
      reject_limit: 500,
      allow_reuse: false
    }
  }}
);
```

### Запуск миграций
- Перед деплоем: выполнить все миграции через MongoDB client или утилиту (например, migrate-mongo)
- Документировать порядок в `docs/deployment/migrations.md`
- Откат: сохранить исходные данные в backup перед миграцией

## Тестирование реализации

### Unit тесты (Rust API)

Файл: `backend/rust-api/tests/enrichment_api_tests.rs`

1. POST /api/admin/templates/{id}/enrich - валидация прав доступа
   - Тест: вызов от пользователя с ролью student -> 403 Forbidden
   - Тест: вызов от admin -> 200 OK

2. POST /api/admin/templates/{id}/enrich - валидация параметров
   - Тест: count < 1 -> 400 Bad Request
   - Тест: count > 200 -> 400 Bad Request
   - Тест: count = 50 -> 200 OK с валидным enrichment_run_id

3. POST /api/admin/templates/{id}/enrich - проверка Redis lock
   - Тест: первый вызов создаёт lock
   - Тест: второй одновременный вызов возвращает 409 Conflict
   - Тест: после завершения lock удаляется

4. POST /api/admin/templates/{id}/enrich - проверка дневного лимита
   - Тест: создать 100 задач, установить reject_limit=50
   - Тест: попытка запустить генерацию возвращает 429 Too Many Requests

5. DELETE /api/admin/templates/{id}/tasks/{task_id} - удаление задачи
   - Тест: после удаления status='rejected', deleted_at установлен
   - Тест: запись в audit_log создана

6. POST /api/admin/templates/{id}/tasks/{task_id}/regenerate - перегенерация
   - Тест: old task.text сохраняется в metadata.previous_text
   - Тест: new task.text отличается от old
   - Тест: regenerated_at timestamp корректный

### Unit тесты (Python Generator)

Файл: `backend/python-generator/tests/test_enrichment_service.py`

1. generate_instances - базовая генерация
   - Тест: вызов с count=5 возвращает массив из 5 экземпляров
   - Тест: каждый экземпляр имеет обязательные поля: task_id, text, correct_answer

2. generate_instances - параметр allow_reuse
   - Тест: allow_reuse=false исключает ранее показанные шаблоны
   - Тест: allow_reuse=true показывает любые шаблоны

3. regenerate_single_instance - перегенерация одной задачи
   - Тест: новый текст отличается от старого
   - Тест: correct_answer не меняется

4. Обработка ошибок
   - Тест: если 1 из 5 задач ошибается -> возвращает 4 успешные + 1 ошибка
   - Тест: ошибка логируется, но не прерывает batch

### Frontend тесты (Lit компонент)

Файл: `frontend/tests/template-enrichment.test.ts`

1. Видимость и права доступа
   - Тест: вкладка видна если user.roles.includes('content_admin')
   - Тест: вкладка скрыта если user.roles = ['student']

2. Форма и валидация
   - Тест: count input принимает только 1-200
   - Тест: при count > 200 кнопка disabled

3. История запусков (таблица)
   - Тест: таблица отображает список enrichment_runs
   - Тест: статус "in_progress" показывает спиннер
   - Тест: статус "completed" показывает success/error count

4. Таблица задач и пагинация
   - Тест: задачи сортируются по created_at DESC
   - Тест: пагинация: 10 задач на странице, кнопки next/prev работают
   - Тест: поиск по тексту фильтрует результаты

5. Управление задачами
   - Тест: клик "Удалить" показывает модалку подтверждения
   - Тест: после подтверждения DELETE запрос отправляется и строка становится серой
   - Тест: клик "Перегенерировать" отправляет POST и обновляет текст

6. UX сценарии
   - Тест: при генерации форма disabled и показывается спиннер
   - Тест: при ошибке показывается error alert с сообщением
   - Тест: при исчерпании лимита показывается специальный alert

### Integration тесты (E2E)

Файл: `tests/e2e/enrichment-flow.test.ts` (Playwright)

1. Полный цикл: создание -> генерация -> проверка
   - Шаг 1: админ переходит на вкладку "Обогащение"
   - Шаг 2: заполняет форму (count=10, reject_limit=100)
   - Шаг 3: нажимает "Запустить генерацию"
   - Шаг 4: видит спиннер и историю со статусом "in_progress"
   - Шаг 5: через 30 сек статус переходит в "completed"
   - Шаг 6: таблица задач показывает 10 новых строк

2. Удаление и перегенерация
   - Шаг 1: админ видит список задач
   - Шаг 2: нажимает "Удалить" на одной задаче
   - Шаг 3: подтверждает в модалке
   - Шаг 4: строка становится серой и помечена как "rejected"
   - Шаг 5: нажимает "Перегенерировать" на другой задаче
   - Шаг 6: текст задачи обновляется на новый

3. Ошибки и исключительные ситуации
   - Тест: если лимит исчерпан, кнопка disabled
   - Тест: если одновременно две генерации, вторая возвращает 409
   - Тест: если Python сервис упал, UI показывает error alert

### Load тесты (опционально)

- 100 параллельных запусков генерации на разные шаблоны -> система должна обработать
- 1000 одновременных запросов GET /enrichment-runs -> не должно быть timeouts

## Критерии приёмки

Задача считается принятой, если выполнены все следующие критерии:

### Backend API (Rust)
- Все 4 endpoint'а реализованы: POST enrich, GET enrichment-runs, DELETE task, POST regenerate
- Все параметры валидируются и возвращаются правильные HTTP коды (200, 400, 403, 404, 409, 429)
- Redis lock предотвращает параллельные генерации для одного шаблона (возвращается 409 при попытке второго запуска)
- Дневной лимит (reject_limit) соблюдается, при превышении возвращается 429
- Права доступа: только admin/content_admin могут вызывать, попытки других ролей возвращают 403
- Все действия залогированы в audit_log с корректными полями и типами событий

### Python Generator
- Endpoint POST /internal/generate_instances создаёт N вариантов и сохраняет сразу в MongoDB (не батчит)
- При ошибке одной задачи: логирует и продолжает, не прерывает batch (обработка {error_count})
- Endpoint POST /internal/regenerate_single_instance заменяет текст задачи, сохраняя старый в metadata
- Оба endpoint'а возвращают правильные JSON структуры (success_count, error_count, instances array)
- Логирование ошибок содержит timestamp, enrichment_run_id, error_type, error_message

### Frontend UI (Lit компонент template-enrichment)
- Вкладка "Обогащение" видна только для users с ролями content_admin/admin
- Форма содержит поля: count (1-200), reject_limit, allow_reuse (checkbox)
- Валидация: count вне диапазона или reject_limit > 0 блокирует кнопку "Запустить"
- Таблица истории запусков отображает: дата, инициатор (email), count, статус, success/error count
- Таблица сгенерированных задач отображает: текст, правильный ответ, опции, дату создания, статус
- Пагинация работает: 10 задач на странице, кнопки "Пред"/"След"
- Поиск по тексту фильтрует результаты, фильтр по статусу (active/rejected) работает
- Кнопки действий: "Удалить" и "Перегенерировать" на каждой строке задачи
- Модалки подтверждения показываются при удалении и перегенерации

### UX и состояния
- При генерации: форма disabled, спиннер, счётчик {success}/{count}, polling обновления таблицы
- При успехе: green toast "Успешно создано {count} вариаций"
- При частичной ошибке: yellow toast "Создано {success}, {error} ошибок"
- При полной ошибке: red alert с message и кнопкой "Повторить"
- При лимите: yellow alert "Использовано {current}/{reject_limit}" и кнопка disabled
- При параллельном запуске: info alert с сообщением о текущем запуске
- Пустое состояние: CTA "Сгенерированных вариаций нет. Нажмите 'Запустить генерацию'"
- Badge'и на строках: "Перегенерирована {дата}", "Удалена {дата}"

### Тесты
- Unit тесты (Rust): валидация параметров, права доступа, lock'и, лимиты (min 6 тестов)
- Unit тесты (Python): генерация вариантов, allow_reuse, перегенерация, обработка ошибок (min 4 теста)
- Frontend тесты (Lit): видимость вкладки, форма, таблицы, действия (min 6 тестов)
- E2E тесты (Playwright): 5 сценариев из раздела "E2E тестовые сценарии" все проходят

### Миграции и данные
- Миграции 001, 002, 003 выполнены без потери данных
- Существующие tasks имеют status='active', новые задачи имеют правильные поля
- Коллекция template_enrichment_runs создана и индексирована
- Шаблоны имеют metadata.generation_settings (инициализировано с дефолтами)
- Временные файлы после миграции удалены, недопустить утечки критических данных попадания в гитхаб

### Документация
- docs/content-admin-guide.md обновлена с инструкциями пользования вкладкой "Обогащение"
- Примеры: как запустить генерацию, как удалить/перегенерировать задачу, как интерпретировать ошибки
- API контракт задокументирован в README или OpenAPI schema (опционально)

### Безопасность и аудит
- Все попытки несанкционированного доступа залогированы (audit_log статус=forbidden)
- Пароли и API ключи (если есть) не логируются в audit_log
- Audit log записи immutable (не удаляются)
- Только админы могут читать audit_log события