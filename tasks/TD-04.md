# TD-04 — Доработка PWA: тестирование и финальная доступность

## Контекст
Основной функционал PWA реализован:
- ✓ Все компоненты, offline queue, UI конфликтов
- ✓ Responsive layout со всеми брейкпоинтами (XL, L, M, SM, XS, XXS, VH)
- ✓ Базовая a11y: aria-live для таймера/toast, ARIA roles, keyboard navigation

Требуется доработка: тестирование, финальная доступность и документация согласно requirements/сценарии/требования.md (раздел 4.4).

## Состав работ

### 1. Доработка доступности (WCAG 2.1 AA)

#### 1.1 aria-live для scoreboard
- Добавить `aria-live="polite"` регион в `score-board.ts` для анонсирования изменений баллов/серии:
  ```typescript
  <div class="sr-only" aria-live="polite" aria-atomic="true">
    ${this.announceText}
  </div>
  ```
- Генерировать `announceText` при изменении `totalScore` или `currentStreak`

#### 1.2 Hotkeys (опциональные)
- Добавить feature flag `VITE_FEATURE_HOTKEYS` (по умолчанию `false`)
- Реализовать в `app-shell.ts`:
  - `H` - запрос подсказки
  - `S` или `Ctrl+Enter` - отправка ответа (Ctrl+Enter уже есть)
  - `Esc` - закрытие onboarding/conflict-resolver
- Показывать hotkeys в UI (tooltips или help panel)

#### 1.3 ARIA roles
- Добавить `role="status"` для scoreboard (`score-board.ts`)
- Проверить, что у всех форм есть `aria-describedby` для ошибок

#### 1.4 Контрастность цветов
- Запустить axe DevTools вручную или через Lighthouse
- Проверить все цветовые пары на 4.5:1 (текст) и 3:1 (UI элементы)
- Исправить проблемные комбинации в `styles/global.css`

### 2. E2E тесты (Playwright)

#### 2.1 Установка и настройка
```bash
npm install -D @playwright/test
npx playwright install
```
Создать `playwright.config.ts`:
```typescript
import { defineConfig } from '@playwright/test';

export default defineConfig({
  testDir: './tests/e2e',
  webServer: {
    command: 'npm run preview',
    port: 4173,
    reuseExistingServer: !process.env.CI,
  },
  use: {
    baseURL: 'http://localhost:4173',
  },
});
```

#### 2.2 Создать тесты
- `tests/e2e/lesson-flow.spec.ts` - полный flow: выбор урока → ответ → баллы
- `tests/e2e/hints.spec.ts` - запрос подсказок, проверка лимита
- `tests/e2e/offline.spec.ts` - отключение сети, offline queue, reconnect
- `tests/e2e/timer.spec.ts` - истечение таймера, блокировка UI
- `tests/e2e/conflicts.spec.ts` - создание конфликта, разрешение через UI

#### 2.3 Добавить npm скрипт
```json
"test:e2e": "playwright test",
"test:e2e:ui": "playwright test --ui"
```

### 3. A11y тесты

#### 3.1 Установка
```bash
npm install -D @axe-core/playwright axe-playwright
```

#### 3.2 Интеграция
- Добавить в каждый E2E тест:
  ```typescript
  import { injectAxe, checkA11y } from 'axe-playwright';

  test('should not have a11y violations', async ({ page }) => {
    await page.goto('/');
    await injectAxe(page);
    await checkA11y(page);
  });
  ```
- Создать `tests/a11y/wcag.spec.ts` для проверки всех состояний приложения

### 4. Lighthouse audits

#### 4.1 Установка
```bash
npm install -D lighthouse
```

#### 4.2 Добавить скрипт
```json
"lighthouse": "lighthouse http://localhost:4173 --preset=desktop --output=html --output-path=./lighthouse-report.html --quiet --chrome-flags=\"--headless\"",
"lighthouse:ci": "lighthouse http://localhost:4173 --preset=desktop --output=json --output-path=./lighthouse-report.json --chrome-flags=\"--headless\""
```

#### 4.3 Цели (минимальные scores)
- PWA score >= 90
- Accessibility score >= 90
- Best Practices score >= 90
- Performance score >= 80

#### 4.4 CI интеграция (опционально)
- Добавить GitHub Action для запуска Lighthouse после сборки
- Фейлить PR, если scores ниже порогов

### 5. Unit/компонентные тесты (расширение)

Текущее покрытие: базовые тесты для offline-queue существуют.

Добавить Web Test Runner тесты:
- `tests/components/hint-panel.wtr.ts` - отображение подсказок, loading, error states
- `tests/components/score-board.wtr.ts` - обновление баллов, серии
- `tests/components/connection-indicator.wtr.ts` - статусы online/offline, queueSize
- `tests/components/conflict-resolver.wtr.ts` - рендеринг конфликтов, actions

Добавить snapshot тесты для визуальной регрессии (опционально).

### 6. Storybook

#### 6.1 Установка
```bash
npx storybook@latest init --type lit
```

#### 6.2 Создать stories
- `timer-display.stories.ts` - idle, running, expired states
- `hint-panel.stories.ts` - empty, with hints, loading, error
- `lesson-player.stories.ts` - idle, active session
- `score-board.stories.ts` - разные значения баллов/серий
- `connection-indicator.stories.ts` - online, offline, syncing, conflicts
- `conflict-resolver.stories.ts` - empty, with conflicts

#### 6.3 Добавить npm скрипты
```json
"storybook": "storybook dev -p 6006",
"build-storybook": "storybook build"
```

### 7. Документация

#### 7.1 Offline sync flow
Создать `docs/offline-sync.md`:
- Архитектура offline queue (IndexedDB + Workbox Background Sync)
- Логика синхронизации при reconnect
- Обработка конфликтов (409 - conflict, 410 - gone)
- Edge cases: таймауты, множественные конфликты, полная очередь
- Sequence diagram (Mermaid или PlantUML)

#### 7.2 PWA deployment
Создать `docs/pwa-deployment.md`:
- Сборка: `npm run build` - генерация Service Worker через vite-plugin-pwa
- Manifest: `/manifest.webmanifest` - настройки icons, theme, display
- Workbox конфигурация: precaching, runtime caching strategies
- Обновление SW: skipWaiting + уведомление пользователю
- Деплой на staging/production (HTTPS обязателен для SW)
- SRI (Subresource Integrity) - опционально

#### 7.3 Обновить README.md
Добавить секции:
- Hotkeys (если реализованы)
- Запуск E2E/a11y тестов
- Lighthouse audits
- Storybook (если реализован)

## Ожидаемые артефакты

1. **Финальная доступность:**
   - aria-live для scoreboard
   - Hotkeys (H, S, Esc) с feature flag
   - Контрастность цветов >= 4.5:1

2. **Тестирование:**
   - E2E тесты (5 файлов в `tests/e2e/`)
   - A11y тесты с axe-core
   - Lighthouse reports с scores >= 90/90/90/80
   - Расширенные unit-тесты для компонентов

3. **Документация:**
   - `docs/offline-sync.md`
   - `docs/pwa-deployment.md`
   - Обновленный README.md

4. **Storybook (опционально):**
   - Stories для всех 6 компонентов
   - Доступ на `npm run storybook`

## Критерии приемки

- [ ] aria-live регионы для scoreboard добавлены
- [ ] Hotkeys (H, S, Esc) реализованы с feature flag
- [ ] Контрастность цветов проверена и исправлена (WCAG 2.1 AA)
- [ ] E2E тесты покрывают: lesson flow, hints, offline, timer, conflicts
- [ ] A11y тесты (axe) запускаются без critical/serious ошибок
- [ ] Lighthouse PWA/Accessibility/Best Practices >= 90, Performance >= 80
- [ ] Unit-тесты для компонентов (hint-panel, score-board, connection-indicator, conflict-resolver)
- [ ] Storybook доступен на `npm run storybook` (опционально)
- [ ] Документация описывает offline sync, PWA deployment

## Приоритеты (обновлено)

**P0 (критичный для production):**
1. Lighthouse audits - запустить, исправить критичные проблемы accessibility/PWA
2. axe a11y тесты - установить @axe-core/playwright, создать базовый тест
3. Контрастность цветов - проверить и исправить
4. aria-live для scoreboard - добавить анонсирование баллов/серий

**P1 (высокий):**
5. E2E тесты - минимум lesson-flow.spec.ts, offline.spec.ts, conflicts.spec.ts
6. Hotkeys (H, S, Esc) с feature flag
7. Документация offline-sync.md

**P2 (средний):**
8. Полное покрытие E2E (5 тестов)
9. Unit-тесты для компонентов (4 файла)
10. Документация pwa-deployment.md

**P3 (низкий, опционально):**
11. Storybook - базовые stories
12. Snapshot тесты для визуальной регрессии
13. CI интеграция для Lighthouse

## Связанные задачи
- SYS-01...SYS-07 - системные тесты из requirements/тестирование/стек тестов.md
- Тест-кейс 8.5 - офлайн-синхронизация

## Примечания
- Hotkeys должны быть опциональными (фич-флаг `VITE_FEATURE_HOTKEYS`), чтобы не конфликтовать с горячими клавишами браузера
- Lighthouse запускать в headless режиме на CI (`--chrome-flags="--headless"`)
- При добавлении aria-live для scoreboard использовать `aria-atomic="true"`, чтобы анонсировалось всё сообщение целиком
