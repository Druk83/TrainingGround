# A7 — Безопасность, античит и наблюдаемость

## Контекст
Разделы 4.2.5, 4.4.5–4.4.6 `requirements/сценарии/требования.md`, TL-2/TL-4/TL-5 и тестовая стратегия описывают требования к безопасности, античиту, мониторингу и алертингу. Цель задачи — внедрить технические меры, подтверждающие выполнение SLA по безопасности и наблюдаемости.

## Состав работ
1. **Безопасность API и PWA.**
   - Включить TLS 1.3, HSTS, строгий CSP (`default-src 'self'`, `script-src 'self'`).
   - JWT с ролями/claim’ами, обновление ключей подписи, поддержка SSO (OAuth2/SAML) как опция.
   - CSRF защита (token + проверка Origin/Referer) и защита от Replay (nonce/timestamp).
   - Хранение PII в зашифрованном виде (Mongo FLE, Vault для ключей).
2. **Античит.**
   - Имплементация правил: скорость ответа <2 сек, повтор шаблонов → счётчики `speed_hits`/`repeated_hits`, блокировки на 24 часа.
   - Инструменты для DevOps/кураторов: журнал `incidents`, панель мониторинга, ручная разблокировка.
   - Интеграция Яндекс SmartCaptcha/поведенческих сигналов (что и когда включается).
   - Redis Pub/Sub для incidents: публикация событий в канал `incidents`, подписка DevOps Alertmanager/Telegram bot.
   - Webhook интеграция: отправка критических событий (массовые блокировки) в Telegram.
3. **Мониторинг и логирование.**
   - Настройка Prometheus/Grafana/Alertmanager (метрики API latency, подсказок, очередей, античита).
   - Логирование в Loki/ELK с структурированными записями (trace id, user id, action).
   - Дашборды SLA/SLO (уроки, подсказки, отчёты, очереди эмбеддингов).
4. **Алерты и runbooks.**
   - Правила Alertmanager: latency >200 мс, недоступность подсказок, рост античит-событий, переполнение очередей.
   - Интеграции с Telegram/Email (webhooks), инструкции runbook (как реагировать).
5. **CI/CD и секреты.**
   - Процессы ротации секретов (Vault/KMS), обновление конфигов без простоя.
   - Проверки безопасности в pipeline (lint, dependency audit, SAST).
6. **Документация и тренировки.**
   - `docs/security.md`, `docs/anticheat.md`, runbooks, SLA/SLO таблицы.
   - Проведение учений (tabletop для инцидентов), фиксация результатов.

## Ожидаемые артефакты
- Набор конфигураций для TLS/CSP/JWT/SSO, античит-политики.
- Полный стек мониторинга/логирования/алертинга с дашбордами.
- Runbooks и инструкции по работе с инцидентами/секретами.

## Чек-лист готовности
- [x] Все внешние и внутренние каналы защищены (TLS, mTLS, сертификаты актуальны).
- [x] Античит-счётчики и блокировки автоматически создаются, события отображаются в панели и журнале.
- [x] PII зашифрована, секреты управляются Vault/Secrets Manager, ротация автоматизирована.
- [x] Метрики и логи собираются, дашборды доступны, алерты приходят в оговорённые каналы ≤2 минут.
- [x] Runbooks описывают реакцию на критические инциденты (падение подсказок, DoS, утечка).
- [x] Пентест/аудит OWASP Top 10 пройден или заведены задачи на устранение.

## Тестирование
- **Security:** автоматический скан ZAP/OWASP, dependency audit (npm audit/cargo audit/pip-audit), проверка CSP, PenTest чек-лист.
- **Anticheat:** интеграционные тесты генерации `incidents`, симуляция быстрых ответов и повторов.
- **Monitoring:** smoke-тест метрик (Prometheus scrape), алерты (Alertmanager test hooks), проверка retention логов.
- **DR drills:** имитация падения Redis/Qdrant/Mongo и проверка уведомлений/восстановления.
- **SSO/Secrets:** тестовые ротации ключей, проверка SSO входа и отзывов доступа.
