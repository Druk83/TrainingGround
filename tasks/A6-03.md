# A6-03 — UI Куратора/Учителя

## Контекст
Согласно `requirements/предметная область.md` и `requirements/сценарии/требования.md` (4.1.4, AL-3), Куратор (Учитель) отвечает за мониторинг прогресса группы учеников, выявление проблемных тем и подготовку рекомендаций. UI должен предоставлять аналитику по группе, отчёты и экспорт данных.

**Цель задачи:** Создать полнофункциональный UI для куратора с dashboard, таблицами учеников, аналитикой и экспортом отчётов.

## Состав работ

### 1. Главная страница Teacher Dashboard
**Файл:** `frontend/src/pages/teacher-dashboard.ts` (уже существует, требует доработки)

**Компоненты:**

**1.1. Шапка (app-header):**
- Логотип/название системы
- Приветствие "Привет, [Имя Куратора]!"
- Текущая группа (dropdown для выбора, если куратор ведёт несколько групп)
- Кнопка профиля (dropdown: Настройки, Выход)
- Индикатор статуса соединения

**1.2. Сводная статистика по группе (dashboard cards):**
- **Общая информация:**
  - Название группы (например, "8А класс")
  - Школа
  - Количество учеников в группе
  - Количество активных учеников (заходили за последние 7 дней)

- **Метрики прогресса:**
  - Средний процент правильных ответов по группе
  - Количество пройденных уроков (суммарно)
  - Средний балл по группе
  - Прогресс по темам (топ-3 темы с лучшими/худшими результатами)

- **Проблемные зоны:**
  - Количество учеников с падением результатов (сравнение с прошлой неделей)
  - Темы с низким процентом прохождения (<70%)
  - Ученики, не заходившие >7 дней

**1.3. График активности:**
- Линейный график активности учеников за последние 30 дней
- Ось X: дата
- Ось Y: количество активных учеников
- Возможность выбора периода (7 дней, 30 дней, 90 дней)

**1.4. Быстрые действия:**
- Кнопка "Просмотреть учеников"
- Кнопка "Скачать отчёт"
- Кнопка "Отправить напоминание неактивным"

### 2. Раздел "Ученики группы"
**Компонент:** `frontend/src/components/students-table.ts` (новый)

**Функции:**

**2.1. Таблица учеников:**
- **Колонки:**
  - ФИО
  - Email
  - Последний вход (дата/время)
  - Пройдено уроков
  - Средний процент правильных
  - Общий балл
  - Статус (активен, неактивен >7 дней, заблокирован)
  - Действия

- **Поиск и фильтры:**
  - Поиск по ФИО, email
  - Фильтр по статусу (активен/неактивен)
  - Фильтр по проценту правильных (<50%, 50-70%, 70-85%, >85%)
  - Сортировка по каждой колонке

- **Пагинация:**
  - По 25/50/100 учеников на страницу

**2.2. Детальная карточка ученика:**
- При клике на строку таблицы открывается модальное окно:
  - **Основная информация:**
    - ФИО, email, дата регистрации
    - Последний вход
    - Общий балл и средний процент

  - **Прогресс по темам:**
    - Список тем с процентом прохождения
    - Визуализация (прогресс-бары или круговые диаграммы)
    - Проблемные темы (выделены красным)

  - **История активности:**
    - График активности ученика за последние 30 дней
    - Список последних 10 сессий:
      - Дата/время
      - Тема и уровень
      - Балл
      - Процент правильных
      - Время прохождения

  - **Рекомендации:**
    - Автоматически сгенерированные рекомендации:
      - "Требуется дополнительная практика по теме Орфография"
      - "Отличный прогресс по Синтаксису"
      - "Не заходил 10 дней — отправить напоминание"

  - **Действия:**
    - Кнопка "Отправить email с рекомендациями"
    - Кнопка "Экспорт прогресса в PDF"
    - Кнопка "Закрыть"

### 3. Раздел "Аналитика по темам"
**Компонент:** `frontend/src/components/topics-analytics.ts` (новый)

**Функции:**

**3.1. Таблица статистики по темам:**
- **Колонки:**
  - Название темы
  - Количество учеников, начавших тему
  - Количество учеников, завершивших тему (≥80%)
  - Средний процент правильных ответов
  - Среднее время прохождения
  - Количество запрошенных подсказок (среднее на ученика)

- **Сортировка:**
  - По проценту завершивших (найти сложные темы)
  - По проценту правильных ответов
  - По времени прохождения

**3.2. Детальная аналитика темы:**
- При клике на тему открывается:
  - **Распределение результатов:**
    - Гистограмма: количество учеников по диапазонам процентов (0-50%, 50-70%, 70-85%, 85-100%)

  - **Типичные ошибки:**
    - Список заданий с наибольшим процентом ошибок
    - Примеры неправильных ответов (анонимизированные)

  - **Топ-3 проблемных задания:**
    - Название/текст задания
    - Процент неправильных ответов
    - Среднее время на задание

### 4. Раздел "Отчёты"
**Компонент:** `frontend/src/components/reports-generator.ts` (новый)

**Функции:**

**4.1. Генератор отчётов:**
- **Тип отчёта (выбор):**
  - Сводный отчёт по группе
  - Детальный отчёт по ученику
  - Отчёт по теме
  - Отчёт по периоду (кастомные даты)

- **Параметры отчёта:**
  - Период: за неделю, месяц, квартал, кастомный
  - Формат: PDF, CSV, Excel (XLSX)
  - Включить графики (чекбокс)
  - Включить детали по каждому ученику (чекбокс)

- **Содержание отчёта (сводный по группе):**
  - Титульная страница:
    - Название группы, школа
    - Куратор (ФИО)
    - Период отчёта
    - Дата генерации

  - Раздел "Общие метрики":
    - Количество учеников
    - Средний процент правильных ответов
    - Общий прогресс по темам
    - График активности

  - Раздел "Детали по ученикам":
    - Таблица всех учеников с ключевыми метриками
    - Топ-5 лучших учеников
    - Список неактивных учеников

  - Раздел "Аналитика по темам":
    - Таблица тем с процентом завершивших
    - Проблемные темы

  - Раздел "Рекомендации":
    - Автоматически сгенерированные рекомендации для куратора

**4.2. История отчётов:**
- Таблица ранее сгенерированных отчётов:
  - Название отчёта
  - Дата генерации
  - Период
  - Формат
  - Кнопка "Скачать"

### 5. Раздел "Уведомления и коммуникация"
**Компонент:** `frontend/src/components/teacher-notifications.ts` (новый)

**Функции:**

**5.1. Отправка напоминаний:**
- **Форма отправки email:**
  - Получатели:
    - Выбор учеников из списка (чекбоксы)
    - Быстрый выбор: "Все", "Неактивные >7 дней", "С падением результатов"
  - Тема письма (предзаполнено, можно изменить)
  - Текст письма (шаблон + возможность кастомизации)
  - Переменные шаблона: `{student_name}`, `{progress}`, `{last_topic}`
  - Кнопка "Предпросмотр"
  - Кнопка "Отправить"

- **Шаблоны писем:**
  - "Напоминание о неактивности"
  - "Поздравление с прогрессом"
  - "Рекомендация по теме"
  - Возможность создания своих шаблонов

**5.2. История отправленных уведомлений:**
- Таблица:
  - Дата отправки
  - Тема
  - Получатели (количество)
  - Статус (отправлено, доставлено, открыто) — если интеграция с email-сервисом
  - Кнопка "Просмотр"

### 6. Навигация
**Обновить:** `frontend/src/app-shell.ts`

**Маршруты:**
```
/teacher                           - Dashboard (главная)
/teacher/students                  - Таблица учеников
/teacher/students/:id              - Детальная карточка ученика
/teacher/analytics                 - Аналитика по темам
/teacher/analytics/topics/:id      - Детальная аналитика темы
/teacher/reports                   - Генератор отчётов
/teacher/reports/:id               - Просмотр отчёта
/teacher/notifications             - Уведомления и коммуникация
/teacher/profile                   - Профиль куратора
```

## API Endpoints (Rust API)

### Группы и ученики
```
GET    /teacher/groups/:id                  - Информация о группе
GET    /teacher/groups/:id/students         - Список учеников группы
GET    /teacher/groups/:id/stats            - Статистика по группе
GET    /teacher/students/:id                - Детальная информация об ученике
GET    /teacher/students/:id/progress       - Прогресс ученика
GET    /teacher/students/:id/sessions       - История сессий ученика
```

### Аналитика
```
GET    /teacher/analytics/topics            - Статистика по всем темам группы
GET    /teacher/analytics/topics/:id        - Детальная аналитика темы
GET    /teacher/analytics/activity          - График активности группы
GET    /teacher/analytics/recommendations   - Автоматические рекомендации
```

### Отчёты
```
POST   /teacher/reports/generate            - Сгенерировать отчёт
GET    /teacher/reports                     - История отчётов
GET    /teacher/reports/:id                 - Получить отчёт
GET    /teacher/reports/:id/download        - Скачать отчёт (PDF/CSV/XLSX)
```

### Уведомления
```
POST   /teacher/notifications/send          - Отправить email ученикам
GET    /teacher/notifications/templates     - Шаблоны писем
POST   /teacher/notifications/templates     - Создать шаблон
GET    /teacher/notifications/history       - История отправленных уведомлений
```

## Модели данных (MongoDB)

### teacher_reports (новая коллекция)
```javascript
{
  _id: ObjectId,
  teacher_id: ObjectId,         // ref: users (роль teacher)
  group_id: ObjectId,           // ref: groups
  report_type: String,          // 'group_summary', 'student_detail', 'topic_analysis'
  period: {
    start: Date,
    end: Date,
  },
  format: String,               // 'pdf', 'csv', 'xlsx'
  file_url: String,             // ссылка на файл в Object Storage
  metadata: Object,             // параметры генерации
  created_at: Date,
}
```

### notification_templates (новая коллекция)
```javascript
{
  _id: ObjectId,
  teacher_id: ObjectId,         // ref: users
  name: String,                 // "Напоминание о неактивности"
  subject: String,              // тема письма
  body: String,                 // текст с переменными {student_name}
  created_at: Date,
  updated_at: Date,
}
```

### sent_notifications (новая коллекция)
```javascript
{
  _id: ObjectId,
  teacher_id: ObjectId,         // ref: users
  template_id: ObjectId,        // ref: notification_templates
  recipients: [ObjectId],       // ref: users (ученики)
  subject: String,
  body: String,
  sent_at: Date,
  status: String,               // 'sent', 'delivered', 'opened'
}
```

## Ожидаемые артефакты

### Frontend
- `frontend/src/pages/teacher-dashboard.ts` - доработка существующей страницы
- `frontend/src/components/students-table.ts` - таблица учеников
- `frontend/src/components/student-detail-modal.ts` - детальная карточка ученика
- `frontend/src/components/topics-analytics.ts` - аналитика по темам
- `frontend/src/components/reports-generator.ts` - генератор отчётов
- `frontend/src/components/teacher-notifications.ts` - уведомления
- `frontend/src/lib/teacher-api.ts` - API клиент для методов куратора
- `frontend/src/lib/charts.ts` - библиотека графиков (Chart.js или D3.js)

### Backend (Rust API)
- `backend/rust-api/src/handlers/teacher/groups.rs` - хендлеры групп
- `backend/rust-api/src/handlers/teacher/students.rs` - хендлеры учеников
- `backend/rust-api/src/handlers/teacher/analytics.rs` - хендлеры аналитики
- `backend/rust-api/src/handlers/teacher/reports.rs` - хендлеры отчётов
- `backend/rust-api/src/handlers/teacher/notifications.rs` - хендлеры уведомлений
- `backend/rust-api/src/services/report_generator.rs` - сервис генерации отчётов
- `backend/rust-api/src/services/email_service.rs` - сервис отправки email
- `backend/rust-api/src/models/teacher_report.rs` - модель отчёта
- `backend/rust-api/src/models/notification.rs` - модель уведомления

### Тесты
- `frontend/src/__tests__/teacher-dashboard.test.ts` - E2E тесты UI
- `backend/rust-api/tests/integration/teacher_analytics.rs` - тесты API аналитики
- `backend/rust-api/tests/integration/report_generator.rs` - тесты генератора отчётов

### Документация
- `docs/teacher-guide.md` - руководство для куратора
- `docs/api/teacher-endpoints.yaml` - OpenAPI спецификация
- `docs/reports-format.md` - описание форматов отчётов

## Чек-лист готовности

### Backend API
- [ ] Endpoints для статистики группы реализованы
- [ ] Endpoints для детальной информации об ученике работают
- [ ] Endpoints для аналитики по темам работают
- [ ] Сервис генерации отчётов реализован (PDF, CSV, XLSX)
- [ ] Отчёты сохраняются в Object Storage
- [ ] Сервис отправки email настроен (SMTP)
- [ ] Endpoints для уведомлений работают
- [ ] RBAC проверяет роль 'teacher' и доступ только к своим группам
- [ ] Все endpoints возвращают корректные данные

### Frontend UI
- [ ] Dashboard отображает статистику по группе
- [ ] График активности отображается корректно
- [ ] Таблица учеников работает с фильтрами и поиском
- [ ] Детальная карточка ученика показывает полную информацию
- [ ] Аналитика по темам отображает статистику
- [ ] Генератор отчётов создаёт отчёты в выбранном формате
- [ ] Скачивание отчётов работает
- [ ] Форма отправки уведомлений работает
- [ ] Шаблоны писем можно создавать и редактировать
- [ ] История уведомлений отображается
- [ ] Навигация между разделами работает
- [ ] Проверка прав доступа (только роль teacher)

### Функциональность
- [ ] Куратор видит только учеников своей группы
- [ ] Статистика рассчитывается корректно (средний процент, прогресс)
- [ ] Отчёты генерируются за ≤10 сек (для группы до 30 человек)
- [ ] PDF отчёты содержат графики и таблицы
- [ ] CSV/XLSX экспорт работает корректно
- [ ] Email отправляются успешно (интеграция с SMTP)
- [ ] Переменные в шаблонах подставляются корректно

### Тестирование
- [ ] Unit-тесты для сервиса генерации отчётов
- [ ] Integration-тесты для endpoints аналитики
- [ ] E2E тесты основных сценариев (просмотр учеников, генерация отчёта)
- [ ] Тесты отправки email (mock SMTP)
- [ ] Performance тесты (генерация отчёта для 100 учеников ≤15 сек)

### Документация
- [ ] Руководство для куратора создано
- [ ] API endpoints задокументированы
- [ ] Описание форматов отчётов создано

## Тестирование

### E2E тесты (Playwright)
**Сценарий 1: Просмотр статистики группы**
1. Логин как teacher
2. Переход на /teacher
3. Проверка отображения dashboard с метриками
4. Проверка графика активности
5. Клик на "Просмотреть учеников"
6. Проверка таблицы учеников

**Сценарий 2: Просмотр детальной информации об ученике**
1. Переход в /teacher/students
2. Клик на строку ученика
3. Проверка открытия модального окна
4. Проверка отображения прогресса по темам
5. Проверка истории сессий

**Сценарий 3: Генерация и скачивание отчёта**
1. Переход в /teacher/reports
2. Выбор типа отчёта "Сводный по группе"
3. Выбор периода "За месяц"
4. Выбор формата "PDF"
5. Клик "Сгенерировать"
6. Ожидание завершения (≤10 сек)
7. Клик "Скачать"
8. Проверка скачивания файла

**Сценарий 4: Отправка напоминания неактивным ученикам**
1. Переход в /teacher/notifications
2. Выбор получателей "Неактивные >7 дней"
3. Выбор шаблона "Напоминание о неактивности"
4. Кастомизация текста
5. Клик "Отправить"
6. Проверка успешной отправки
7. Проверка записи в истории уведомлений

### Performance тесты
- **Загрузка dashboard:** ≤2 сек для группы 30 учеников
- **Генерация PDF отчёта:** ≤10 сек для группы 30 учеников, ≤30 сек для 100 учеников
- **Отправка email:** ≤5 сек для 10 получателей

## Приоритизация

### P0 (Must-have для запуска)
1. Dashboard с базовой статистикой группы
2. Таблица учеников с фильтрами
3. Детальная карточка ученика
4. Генератор простых отчётов (CSV)

### P1 (Важно для production)
5. Аналитика по темам
6. PDF отчёты с графиками
7. Отправка email уведомлений
8. График активности

### P2 (Nice-to-have)
9. Шаблоны писем (кастомизация)
10. Excel экспорт
11. Автоматические рекомендации
12. История отчётов

## Зависимости

**Требует:**
- A6-01 (UI Суперпользователя) - для создания кураторов и групп
- A6-02 (UI Ученика) - данные учеников для статистики
- TD-06 (Authentication) - JWT с role 'teacher'

**Блокирует:**
- Нет (опциональная роль)

**Опционально:**
- Интеграция с SMTP сервисом (для email уведомлений)
- Интеграция с Object Storage (для хранения отчётов)

## Оценка времени

**Backend API:** ~40 часов
- Endpoints статистики: 8 часов
- Сервис генерации отчётов: 12 часов
- Сервис email: 6 часов
- Endpoints аналитики: 8 часов
- Тесты: 6 часов

**Frontend UI:** ~50 часов
- Dashboard: 8 часов
- Таблица учеников + карточка: 12 часов
- Аналитика по темам: 10 часов
- Генератор отчётов: 10 часов
- Уведомления: 6 часов
- Графики (Chart.js интеграция): 4 часов

**Документация:** ~6 часов

**Итого:** ~96 часов (≈12 рабочих дней для 1 разработчика, ≈6 дней для 2 параллельно)

## Успешное завершение

Задача считается выполненной, когда:
1. Куратор может просмотреть статистику своей группы
2. Таблица учеников отображает актуальные данные с фильтрами
3. Детальная карточка ученика показывает прогресс и историю
4. Аналитика по темам рассчитывается корректно
5. Отчёты генерируются в выбранном формате (PDF, CSV, XLSX)
6. Отчёты соответствуют требованиям (≤10 сек для 30 учеников)
7. Email уведомления отправляются успешно
8. Все endpoints защищены RBAC (куратор видит только свои группы)
9. E2E тесты основных сценариев проходят
10. Документация для куратора создана

После выполнения A6-03 функционал для всех основных ролей (суперадмин, ученик, куратор) будет готов.
