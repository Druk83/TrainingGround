version: '3.9'

services:
  # MongoDB — основная БД
  # NOTE: Replica set отключен для dev окружения из-за сложностей с keyfile на Windows
  # Для production используйте MongoDB Atlas или настройте keyfile вручную
  mongodb:
    image: mongo:6
    container_name: trainingground-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
      MONGO_INITDB_DATABASE: ${MONGO_DB:-trainingground}
    volumes:
      - mongodb_data:/data/db
      - ./infra/mongo-init:/docker-entrypoint-initdb.d
    networks:
      - trainingground-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis — кеш и сессии
  redis:
    image: redis:7-alpine
    container_name: trainingground-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    networks:
      - trainingground-network

  # Qdrant — векторная БД для семантического поиска
  qdrant:
    image: qdrant/qdrant:v1.8.0
    container_name: trainingground-qdrant
    restart: unless-stopped
    ports:
      - "6333:6333"
      - "6334:6334"
    environment:
      QDRANT__SERVICE__API_KEY: ${QDRANT_API_KEY}
    volumes:
      - qdrant_data:/qdrant/storage
    networks:
      - trainingground-network

  # Rust API — Lesson Execution Service (A2)
  rust-api:
    build:
      context: ./backend/rust-api
      dockerfile: Dockerfile
    container_name: trainingground-rust-api
    restart: unless-stopped
    ports:
      - "8081:8081"
    environment:
      RUST_LOG: ${RUST_LOG:-info}
      APP_ENV: ${APP_ENV:-prod}
      RATE_LIMIT_DISABLED: ${RATE_LIMIT_DISABLED:-0}
      RATE_LIMIT_PER_IP: ${RATE_LIMIT_PER_IP:-200}
      SESSION_DURATION_SECONDS: ${SESSION_DURATION_SECONDS:-3600}
      HINTS_MAX_PER_SESSION: ${HINTS_MAX_PER_SESSION:-2}
      HINTS_PYTHON_API_ENABLED: ${HINTS_PYTHON_API_ENABLED:-0}
      SSE_MAX_STREAM_SECONDS: ${SSE_MAX_STREAM_SECONDS:-3600}
      SSE_TICK_INTERVAL_MS: ${SSE_TICK_INTERVAL_MS:-1000}
      ANTICHEAT_DISABLED: ${ANTICHEAT_DISABLED:-0}
      APP__DATABASE__MONGO_URI: mongodb://${MONGO_USER}:${MONGO_PASSWORD}@mongodb:27017/${MONGO_DB:-trainingground}?authSource=admin
      APP__REDIS__URI: redis://:${REDIS_PASSWORD}@redis:6379
      APP__AUTH__JWT_SECRET: ${JWT_SECRET}
      APP__PYTHON_API__URL: http://python-generator:8000
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://jaeger:4318}
      OTEL_SERVICE_NAME: rust-api
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - trainingground-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8081/health"]
      interval: 30s
      timeout: 3s
      start_period: 10s
      retries: 3

  # Grafana — optional monitoring dashboard
  grafana:
    image: grafana/grafana:10.2.2
    container_name: trainingground-grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD}
    volumes:
      - ./infra/grafana/provisioning:/etc/grafana/provisioning
      - ./infra/grafana/dashboards:/var/lib/grafana/dashboards
      - grafana_data:/var/lib/grafana
    networks:
      - trainingground-network

  # Python Generator — генерация заданий и объяснений (будет добавлен в A3)
  # python-generator:
  #   build:
  #     context: ./backend/python-generator
  #     dockerfile: Dockerfile
  #   container_name: trainingground-python-generator
  #   restart: unless-stopped
  #   ports:
  #     - "${PYTHON_API_PORT:-8000}:8000"
  #   environment:
  #     MONGODB_URI: mongodb://${MONGO_USER}:${MONGO_PASSWORD}@mongodb:27017/${MONGO_DB:-trainingground}?authSource=admin
  #     REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379
  #     QDRANT_URL: http://qdrant:6333
  #     QDRANT_API_KEY: ${QDRANT_API_KEY}
  #     YANDEXGPT_API_KEY: ${YANDEXGPT_API_KEY}
  #     YANDEXGPT_FOLDER_ID: ${YANDEXGPT_FOLDER_ID}
  #     LOG_LEVEL: ${LOG_LEVEL:-INFO}
  #   depends_on:
  #     - mongodb
  #     - redis
  #     - qdrant
  #   networks:
  #     - trainingground-network
  #   volumes:
  #     - ./backend/python-generator/src:/app/src
  #     - ./backend/python-generator/tests:/app/tests

networks:
  trainingground-network:
    driver: bridge

volumes:
  mongodb_data:
  redis_data:
  qdrant_data:
  grafana_data:
