version: '3.9'

services:
  # MongoDB Replica Set — 3 ноды для поддержки Change Streams
  mongodb-primary:
    image: mongo:6
    container_name: trainingground-mongodb-primary
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
      MONGO_INITDB_DATABASE: ${MONGO_DB:-trainingground}
    command: >
      bash -c "
        chmod 400 /data/keyfile/mongo-keyfile &&
        chown mongodb:mongodb /data/keyfile/mongo-keyfile &&
        exec docker-entrypoint.sh mongod --replSet rs0 --bind_ip_all --keyFile /data/keyfile/mongo-keyfile
      "
    volumes:
      - mongodb_primary_data:/data/db
      - ./infra/mongo-init:/docker-entrypoint-initdb.d:ro
      - ${MONGO_KEYFILE_PATH:-./infra/mongo-keyfile.secure}:/data/keyfile/mongo-keyfile
    networks:
      - trainingground-network
    healthcheck:
      test: ["CMD", "mongosh", "admin", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  mongodb-secondary1:
    image: mongo:6
    container_name: trainingground-mongodb-secondary1
    restart: unless-stopped
    ports:
      - "27018:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
    command: >
      bash -c "
        chmod 400 /data/keyfile/mongo-keyfile &&
        chown mongodb:mongodb /data/keyfile/mongo-keyfile &&
        exec docker-entrypoint.sh mongod --replSet rs0 --bind_ip_all --keyFile /data/keyfile/mongo-keyfile
      "
    volumes:
      - mongodb_secondary1_data:/data/db
      - ${MONGO_KEYFILE_PATH:-./infra/mongo-keyfile.secure}:/data/keyfile/mongo-keyfile
    networks:
      - trainingground-network
    healthcheck:
      test: ["CMD", "mongosh", "admin", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  mongodb-secondary2:
    image: mongo:6
    container_name: trainingground-mongodb-secondary2
    restart: unless-stopped
    ports:
      - "27019:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
    command: >
      bash -c "
        chmod 400 /data/keyfile/mongo-keyfile &&
        chown mongodb:mongodb /data/keyfile/mongo-keyfile &&
        exec docker-entrypoint.sh mongod --replSet rs0 --bind_ip_all --keyFile /data/keyfile/mongo-keyfile
      "
    volumes:
      - mongodb_secondary2_data:/data/db
      - ${MONGO_KEYFILE_PATH:-./infra/mongo-keyfile.secure}:/data/keyfile/mongo-keyfile
    networks:
      - trainingground-network
    healthcheck:
      test: ["CMD", "mongosh", "admin", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Инициализатор MongoDB Replica Set — запускается один раз для настройки реплика-сета
  mongodb-init:
    image: mongo:6
    container_name: trainingground-mongodb-init
    restart: "no"
    depends_on:
      mongodb-primary:
        condition: service_healthy
      mongodb-secondary1:
        condition: service_healthy
      mongodb-secondary2:
        condition: service_healthy
    volumes:
      - ./infra/mongo-init:/scripts:ro
    networks:
      - trainingground-network
    command: >
      bash -c "
        echo 'Waiting for MongoDB nodes to be ready...' &&
        sleep 5 &&
        mongosh --host mongodb-primary:27017 -u ${MONGO_USER} -p ${MONGO_PASSWORD} --authenticationDatabase admin --file /scripts/03_replica_set.js &&
        echo 'Replica set initialized successfully'
      "
    profiles:
      - init

  # Redis — кеш и сессии
  redis:
    image: redis:7-alpine
    container_name: trainingground-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    networks:
      - trainingground-network

  # Qdrant — векторная БД для семантического поиска
  qdrant:
    image: qdrant/qdrant:v1.8.0
    container_name: trainingground-qdrant
    restart: unless-stopped
    ports:
      - "6333:6333"
      - "6334:6334"
    environment:
      QDRANT__SERVICE__API_KEY: ${QDRANT_API_KEY}
    volumes:
      - qdrant_data:/qdrant/storage
    networks:
      - trainingground-network

  # HashiCorp Vault — управление секретами и ключами шифрования
  vault:
    image: hashicorp/vault:1.15
    container_name: trainingground-vault
    restart: unless-stopped
    ports:
      - "8200:8200"
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: ${VAULT_ROOT_TOKEN:-dev-root-token}
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
      VAULT_ADDR: http://127.0.0.1:8200
    cap_add:
      - IPC_LOCK
    volumes:
      - ./infra/vault:/vault/config
    networks:
      - trainingground-network
    command: server -dev
    healthcheck:
      test: ["CMD", "vault", "status"]
      interval: 10s
      timeout: 3s
      retries: 3

  # Rust API — сервис выполнения уроков (A2)
  rust-api:
    build:
      context: ./backend/rust-api
      dockerfile: Dockerfile
    container_name: trainingground-rust-api
    restart: unless-stopped
    ports:
      - "8081:8081"
    environment:
      RUST_LOG: ${RUST_LOG:-info}
      APP_ENV: ${APP_ENV:-prod}
      RATE_LIMIT_DISABLED: ${RATE_LIMIT_DISABLED:-0}
      RATE_LIMIT_PER_IP: ${RATE_LIMIT_PER_IP:-200}
      SESSION_DURATION_SECONDS: ${SESSION_DURATION_SECONDS:-3600}
      HINTS_MAX_PER_SESSION: ${HINTS_MAX_PER_SESSION:-2}
      HINTS_PYTHON_API_ENABLED: ${HINTS_PYTHON_API_ENABLED:-0}
      SSE_MAX_STREAM_SECONDS: ${SSE_MAX_STREAM_SECONDS:-3600}
      SSE_TICK_INTERVAL_MS: ${SSE_TICK_INTERVAL_MS:-1000}
      ANTICHEAT_DISABLED: ${ANTICHEAT_DISABLED:-0}
      APP__DATABASE__MONGO_URI: mongodb://${MONGO_USER}:${MONGO_PASSWORD}@mongodb-primary:27017,mongodb-secondary1:27017,mongodb-secondary2:27017/${MONGO_DB:-trainingground}?authSource=admin&replicaSet=rs0
      APP__REDIS__URI: redis://:${REDIS_PASSWORD}@redis:6379
      APP__AUTH__JWT_SECRET: ${JWT_SECRET}
      APP__PYTHON_API__URL: http://python-generator:8000
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://jaeger:4318}
      OTEL_SERVICE_NAME: rust-api
      # A6: Superuser bootstrap seed file (override .env path for Docker)
      ADMIN_SEED_FILE: /secrets/admin-superuser.json
      # Object Storage (report exports)
      OBJECT_STORAGE_BUCKET: ${OBJECT_STORAGE_BUCKET}
      OBJECT_STORAGE_REGION: ${OBJECT_STORAGE_REGION}
      OBJECT_STORAGE_ENDPOINT: ${OBJECT_STORAGE_ENDPOINT}
      OBJECT_STORAGE_ACCESS_KEY: ${OBJECT_STORAGE_ACCESS_KEY}
      OBJECT_STORAGE_SECRET_KEY: ${OBJECT_STORAGE_SECRET_KEY}
      OBJECT_STORAGE_REPORTS_PREFIX: ${OBJECT_STORAGE_REPORTS_PREFIX}
    volumes:
      # A6: Mount superuser seed file (keep this file secret!)
      - ./infra/config/seed/admin-superuser.json:/secrets/admin-superuser.json:ro
    depends_on:
      mongodb-primary:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - trainingground-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8081/health"]
      interval: 30s
      timeout: 3s
      start_period: 10s
      retries: 3

  # Prometheus — сбор метрик
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: trainingground-prometheus
    profiles: ["monitoring"]
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./infra/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./infra/prometheus/rules:/etc/prometheus/rules:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    networks:
      - trainingground-network

  # Alertmanager — маршрутизация SLA-алертов
  alertmanager:
    image: prom/alertmanager:v0.27.0
    container_name: trainingground-alertmanager
    profiles: ["monitoring"]
    restart: unless-stopped
    ports:
      - "9093:9093"
    volumes:
      - ./infra/prometheus/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
    networks:
      - trainingground-network
    depends_on:
      - prometheus

  # Loki — централизованный сбор логов
  loki:
    image: grafana/loki:2.9.4
    container_name: trainingground-loki
    profiles: ["monitoring"]
    restart: unless-stopped
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/config.yml
    volumes:
      - ./infra/loki/loki-config.yml:/etc/loki/config.yml:ro
      - loki_data:/loki
    networks:
      - trainingground-network

  # Promtail — доставляет логи контейнеров в Loki
  promtail:
    image: grafana/promtail:2.9.4
    container_name: trainingground-promtail
    profiles: ["monitoring"]
    restart: unless-stopped
    volumes:
      - ./infra/loki/promtail-config.yml:/etc/promtail/config.yml:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/log:/var/log:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    command: -config.file=/etc/promtail/config.yml
    networks:
      - trainingground-network
    depends_on:
      - loki

  # Jaeger — distributed tracing
  jaeger:
    image: jaegertracing/all-in-one:1.52
    container_name: trainingground-jaeger
    profiles: ["monitoring"]
    restart: unless-stopped
    ports:
      - "16686:16686"  # Jaeger UI
      - "4317:4317"    # OTLP gRPC receiver
      - "4318:4318"    # OTLP HTTP receiver
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    networks:
      - trainingground-network

  # MongoDB Exporter — метрики MongoDB для Prometheus
  mongodb-exporter:
    image: percona/mongodb_exporter:0.40
    container_name: trainingground-mongodb-exporter
    profiles: ["monitoring"]
    restart: unless-stopped
    ports:
      - "9216:9216"
    environment:
      - MONGODB_URI=mongodb://${MONGO_USER}:${MONGO_PASSWORD}@mongodb-primary:27017/?authSource=admin&replicaSet=rs0
    networks:
      - trainingground-network
    depends_on:
      - mongodb-primary

  # Redis Exporter — метрики Redis для Prometheus
  redis-exporter:
    image: oliver006/redis_exporter:v1.55.0
    container_name: trainingground-redis-exporter
    profiles: ["monitoring"]
    restart: unless-stopped
    ports:
      - "9121:9121"
    environment:
      - REDIS_ADDR=redis:6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    networks:
      - trainingground-network
    depends_on:
      - redis

  # Grafana — визуализация метрик и дашборды
  grafana:
    image: grafana/grafana:10.2.2
    container_name: trainingground-grafana
    profiles: ["monitoring"]
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin}
      GF_INSTALL_PLUGINS: redis-datasource
    volumes:
      - ./infra/grafana/provisioning:/etc/grafana/provisioning
      - ./infra/grafana/dashboards:/var/lib/grafana/dashboards
      - grafana_data:/var/lib/grafana
    networks:
      - trainingground-network
    depends_on:
      - prometheus

  python-generator:
    build:
      context: ./backend/python-generator
      dockerfile: Dockerfile
    container_name: trainingground-python-generator
    restart: unless-stopped
    ports:
      - "${PYTHON_API_PORT:-8000}:8000"
    environment:
      MONGODB_URI: mongodb://${MONGO_USER}:${MONGO_PASSWORD}@mongodb-primary:27017,mongodb-secondary1:27017,mongodb-secondary2:27017/${MONGO_DB:-trainingground}?authSource=admin&replicaSet=rs0
      MONGODB_DB: ${MONGO_DB:-trainingground}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_DB: 0
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      QDRANT_URL: http://qdrant:6333
      QDRANT_API_KEY: ${QDRANT_API_KEY:-}
      YANDEXGPT_API_KEY: ${YANDEXGPT_API_KEY:-}
      YANDEXGPT_FOLDER_ID: ${YANDEXGPT_FOLDER_ID:-}
      YANDEXGPT_MODEL: ${YANDEXGPT_MODEL:-yandexgpt-lite}
      YANDEXGPT_TEMPERATURE: ${YANDEXGPT_TEMPERATURE:-0.2}
      YANDEXGPT_MAX_TOKENS: ${YANDEXGPT_MAX_TOKENS:-700}
      YANDEXGPT_TIMEOUT_SECONDS: ${YANDEXGPT_TIMEOUT_SECONDS:-2.0}
      YANDEXGPT_SYSTEM_PROMPT: ${YANDEXGPT_SYSTEM_PROMPT:-}
      LOG_LEVEL: ${PYTHON_LOG_LEVEL:-INFO}
      EXPLANATION_YANDEXGPT_ENABLED: ${EXPLANATION_YANDEXGPT_ENABLED:-1}
    depends_on:
      mongodb-primary:
        condition: service_healthy
      redis:
        condition: service_started
      qdrant:
        condition: service_started
    networks:
      - trainingground-network
    volumes:
      - ./backend/python-generator/src:/app/src
      - ./backend/python-generator/scripts:/app/scripts

networks:
  trainingground-network:
    driver: bridge

volumes:
  mongodb_primary_data:
  mongodb_secondary1_data:
  mongodb_secondary2_data:
  redis_data:
  qdrant_data:
  prometheus_data:
  grafana_data:
  loki_data:

