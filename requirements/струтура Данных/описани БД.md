# Описание структур данных

Документ фиксирует схемы MongoDB, Qdrant и Redis, используемых в проекте «Русский язык: тренировочный полигон». Служит базой для разработки и проектирования аналитики.

---

## 1. MongoDB (Replica Set)

### 1.1 Общие принципы
- Все коллекции в UTF-8, `created_at`/`updated_at` (ISODate).
- Используются `ObjectId` + бизнесовые ключи (user_id, topic_id).
- Версионность реализована через поля `version`, `status` (`draft`, `ready`, `published`, `deprecated`).
- Для операций, меняющих несколько коллекций (например, обновление баллов), применяются транзакции (session + write concern majority).

### 1.2 Коллекции

| Коллекция | Основные поля | Индексы | Примечания |
|-----------|---------------|---------|------------|
| `users` | `_id`, `email`, `role` (`student`,`teacher`,`admin`), `group_ids`, `settings` | `unique(email)`, `role` | Содержит claims для RLS. |
| `groups` | `_id`, `name`, `teacher_id`, `student_ids` | `teacher_id` | Связи для отчётов. |
| `topics` | `_id`, `title`, `description`, `difficulty`, `curriculum_refs` | `difficulty`, `title` | Справочник тем. |
| `levels` | `_id`, `topic_id`, `order`, `requirements` (≥80%), `metadata` | `topic_id`, `order` | Последовательность внутри темы. |
| `templates` | `_id`, `topic_id`, `type`, `content`, `rule_id`, `version`, `status`, `tags` | `topic_id+status`, `rule_id`, `tags` | Версионность с полем `previous_version`. |
| `tasks` | `_id`, `session_id`, `template_id`, `payload`, `correct_answer`, `status` | `session_id`, `template_id` | Экземпляры заданий в сессии. TTL=30 дней. |
| `attempts` | `_id`, `user_id`, `session_id`, `topic_id`, `level_id`, `answers[]`, `score`, `hints_used`, `duration`, `created_at` | `user_id+created_at`, `topic_id+user_id`, `session_id` | Основная сущность аналитики. |
| `progress_summary` | `_id`, `user_id`, `topic_id`, `period` (day/week/month), `metrics` (accuracy, time, hints) | `user_id+topic_id+period`, `topic_id+period` | Материализованные агрегаты (обновляются worker'ом). |
| `hints_log` | `_id`, `session_id`, `task_id`, `user_id`, `hint_type`, `cost`, `created_at` | `session_id`, `user_id+created_at` | Аналитика использования подсказок. |
| `rules` | `_id`, `title`, `body`, `examples`, `version`, `status` | `status`, `title` | Источник истины для пояснений. |
| `incidents` | `_id`, `user_id`, `type` (`anticheat`,`infrastructure`), `severity`, `details`, `status`, `created_at` | `user_id`, `status`, `severity+created_at` | Античит и технические события. |
| `feature_flags` | `_id`, `key`, `value`, `scope` (`global`,`group`,`user`), `enabled`, `metadata` | `key`, `scope+enabled` | Управление gradual rollout. |

### 1.3 Материализованные представления
- `materialized_stats` — результаты Analytics Worker (pipeline: attempts → group metrics). Обновление каждый час.
- `leaderboards` — топ учеников/классов (хранятся 24 часа, TTL).

---

## 2. Qdrant

### 2.1 Коллекции

| Коллекция | Размер вектора | Payload | Использование |
|-----------|----------------|---------|---------------|
| `rules_embeddings` | 768 | `{rule_id, topic_id, difficulty, version}` | Поиск релевантных правил для Explanation Builder. |
| `examples_embeddings` | 768 | `{template_id, topic_id, tags}` | Подбор примеров/слов. |
| `templates_embeddings` | 768 | `{template_id, type, status}` | Предиктивное ранжирование шаблонов. |

- Индексы HNSW (M=16, ef_construction=200).  
- Фильтры по payload (topic_id, difficulty, version).  
- Snapshot раз в сутки, хранится в Object Storage (`s3://backups/qdrant/{date}`).

### 2.2 RAG-процесс
1. Rust API → Python сервис отправляет контекст запроса (topic_id, error_type, last_attempts).
2. Python формирует Qdrant query (vector + filter), k=5.
3. Payload + текст из MongoDB → формируются подсказки/пояснения.
4. Fallback: при недоступности Qdrant берутся шаблоны/правила напрямую из MongoDB (версии `published`).

---

## 3. Redis Key Space Design

| Ключ | Тип | TTL | Описание |
|------|-----|-----|----------|
| `session:{session_id}` | HASH | 3600 сек | `{user_id, topic_id, level_id, task_index, expires_at}` — состояние сессии. |
| `session:timer:{session_id}` | STRING | 120 сек | Остаток таймера (управляется Session Manager). |
| `hints_used:{session_id}` | COUNTER | TTL сессии | Кол-во подсказок, атомарно увеличивается (Lua). |
| `anticheat:{user_id}` | HASH | 1 час | `{speed_hits, repeated_hits, last_event}` — счётчики подозрений. |
| `score:series:{user_id}` | COUNTER | TTL 30 мин | Текущая серия правильных ответов. |
| `feature_flag_cache` | HASH | 5 мин | Кэш значений фич-флагов. |
| `content:changes` | STREAM | n/a | Очередь событий Mongo → Python (embedding pipeline). |
| `explanation:cache:{task_id}` | STRING | 5 мин | Кэш подсказок/пояснений. |

### 3.1 Атомарные операции
- Lua-скрипт `purchase_hint.lua`: проверяет лимит, списывает баллы (через API), увеличивает `hints_used`.
- Lua-скрипт `score_series.lua`: при верном ответе +1, при ошибке сброс; возвращает размер серии для Scoring Engine.
- Использование Redis transactions (`MULTI/EXEC`) для инкремента счётчиков античита и записи событий.

---

## 4. Консистентность и интеграции

- **MongoDB ↔ Redis:** при завершении сессии данные из Redis (серии, подсказки) записываются в `attempts` в рамках транзакции (Rust API).
- **MongoDB ↔ Qdrant:** Embedding Pipeline гарантирует, что каждая опубликованная версия в Mongo имеет актуальный вектор; deprecated версии физически удаляются из Qdrant cron-задачей.
- **Backup policy:** `mongodump` раз в день + WAL архив раз в час; Redis snapshot (`RDB`) каждые 15 мин; Qdrant snapshot + Object Storage.

Документ должен обновляться при изменениях схем, индексов, ключей или политики резервного копирования.
