# Техническое задание на разработку обучающей системы «Русский язык: тренировочный полигон»
## Требования к разработке интерактивного тренажёра русского языка

Документ составлен в соответствии с:
- **ГОСТ 19.201-78** — Техническое задание. Требования к содержанию и оформлению;
- **ГОСТ 19.105-78** — Общие требования к программным документам;
- **ISO/IEC/IEEE 29148:2018** — Systems and software engineering — Requirements engineering;
- **ГОСТ 34.602-89** — Информационная технология. Техническое задание на создание автоматизированной системы.

---

## Содержание

1. [4 Требования к системе](#4-требования-к-системе)
   - [4.1 Требования к структуре системы](#41-требования-к-структуре-системы)
     - [4.1.1 Перечень подсистем](#411-перечень-подсистем)
     - [4.1.2 Информационное взаимодействие](#412-информационное-взаимодействие)
     - [4.1.3 Взаимосвязи со внешними системами](#413-взаимосвязи-со-внешними-системами)
     - [4.1.4 Режимы функционирования](#414-режимы-функционирования)
     - [4.1.5 Диагностирование](#415-диагностирование)
     - [4.1.6 Перспективы развития](#416-перспективы-развития)
   - [4.2 Требования к функциям](#42-требования-к-функциям)
     - [4.2.1 Подлежащие автоматизации функции](#421-подлежащие-автоматизации-функции)
     - [4.2.2 Временной регламент](#422-временной-регламент)
     - [4.2.3 Требования одновременности](#423-требования-одновременности)
     - [4.2.4 Критерии отказов](#424-критерии-отказов)
     - [4.2.5 Требования безопасности и античита](#425-требования-безопасности-и-античита)
   - [4.3 Требования к обеспечению](#43-требования-к-обеспечению)
     - [4.3.1 Математическое обеспечение](#431-математическое-обеспечение)
     - [4.3.2 Информационное обеспечение](#432-информационное-обеспечение)
     - [4.3.3 Лингвистическое обеспечение](#433-лингвистическое-обеспечение)
     - [4.3.4 Программное обеспечение](#434-программное-обеспечение)
     - [4.3.5 Техническое обеспечение](#435-техническое-обеспечение)
     - [4.3.6 Организационное обеспечение](#436-организационное-обеспечение)
     - [4.3.7 Требования к качеству и эксплуатационной поддержке](#437-требования-к-качеству-и-эксплуатационной-поддержке)
   - [4.4 Общие технические требования](#44-общие-технические-требования)
     - [4.4.1 Требования к персоналу](#441-требования-к-персоналу)
     - [4.4.2 Показатели назначения](#442-показатели-назначения)
     - [4.4.3 Производительность](#443-производительность)
     - [4.4.4 Масштабируемость](#444-масштабируемость)
     - [4.4.5 Надёжность](#445-надёжность)
     - [4.4.6 Безопасность](#446-безопасность)
     - [4.4.7 Удобство использования](#447-удобство-использования)

---

## 4 Требования к системе

### 4.1 Требования к структуре системы

#### 4.1.1 Перечень подсистем

1. **PWA-клиент** (TypeScript, Web Components, Service Worker) — отображает учебные сценарии, управляет таймером и подсказками, работает онлайн/офлайн.
2. **Игровой API** (Rust, `hyper`, `tokio`) — реализует бизнес-логику уровней, начисление баллов, проверку статуса подсказок, хранит активные сессии и лимиты.
3. **Сервис генерации заданий и пояснений** (Python, asyncio) — взаимодействует с API YandexGPT, наполняет шаблоны, выполняет морфологический анализ, управляет банком заданий.
4. **Хранилище данных** — MongoDB (задания, темы, попытки, агрегаты статистики), Redis (сессии, античит, кеш подсказок).
5. **Подсистема базы знаний** — документное ядро (MongoDB) + Qdrant как векторное хранилище, pipeline генерации/обновления эмбеддингов, API для Retrieval-Augmented Generation.
6. **Сервис аналитики** — агрегирует статистику по темам и игрокам, формирует отчёты для учителей/кураторов.
7. **Административный интерфейс** — настройка тем, шаблонов, мониторинг античит-событий, управление расписанием публикаций.

#### 4.1.2 Информационное взаимодействие

- PWA обращается к игровому API через REST/JSON; для оперативных обновлений (таймер, подсказки, блокировки) применяется WebSocket/Server-Sent Events.
- Игровой API синхронно читает/пишет данные в MongoDB (темы, задания, попытки), обращается к Redis для лимитов и античита.
- Python-сервис публикует новые задания и пояснения в MongoDB, отправляет уведомления API через очередь (NATS/Redis streams).
- Тот же Python-процесс рассчитывает эмбеддинги для документов (правила, примеры, шаблоны) и записывает их в Qdrant. API генерации при запросе пояснений извлекает релевантные фрагменты через векторный поиск по Qdrant.
- Аналитика читает агрегированные данные из MongoDB (используя pipeline/материализованные представления), формирует отчёты и экспортирует их в CSV/PDF.

#### 4.1.3 Взаимосвязи со внешними системами

- **YandexGPT API** — генерация текстов заданий, пояснений, адаптация сложности.
- **Системы аутентификации школ** (опционально) — OAuth 2.0 / SAML для доступа учащихся.
- **Почтовые/мессенджер сервисы** — рассылка отчётов, напоминаний.
- **Облачное хранилище** — резервные копии банка заданий.

#### 4.1.4 Режимы функционирования

1. **Учебный** — основной режим прохождения уровней; требуется устойчивое подключение.
2. **Офлайн-PWA** — ограниченный режим с кешированными заданиями (без начисления рейтингов).
3. **Административный** — настройка контента и просмотр статистики ограниченным кругом пользователей.
4. **Диагностический** — включается при отладке; активирует расширенное логирование и сверку расчетов.

#### 4.1.5 Диагностирование

- Логи событий (запуск, ответ, подсказка, подозрение античита) пишутся централизованно.
- Метрики: Latency API, успешность генерации YandexGPT, объём кешей, статус Service Worker.
- Автоматические health-check'и для каждого сервиса; алерты при SLA нарушениях.

#### 4.1.6 Перспективы развития

- Добавление терминального клиента (CLI на Rust/Python) с офлайн-режимом.
- Интеграция с электронными дневниками/ЛМС для импорта групп.
- Расширение банка заданий на другие предметы (литература, история языка).
- Внедрение рекомендаций по повторению тем на основе прогностических моделей.

### 4.2 Требования к функциям

#### 4.2.1 Подлежащие автоматизации функции

1. Регистрация/аутентификация учащихся и кураторов (email, SSO, гостевой доступ).
2. Выбор темы/курса и запуск уровня из 5–20 заданий (см. паспорт проекта).
3. Тайминг каждой задачи (120 секунд) контролируется сервером: Session Manager записывает `session_expiry_time` в Redis (TTL=120 сек). При закрытии вкладки клиент может переподключиться и получить остаток времени; по истечении таймера ответ автоматически помечается как неверный.
4. Начисление базовых баллов (+10) и бонусов за серии, штрафы за подсказки (−5).
5. Предоставление подсказок (до 2 на уровень) с подробным объяснением правила.
6. Проверка ответов: множественный выбор, короткий ввод, сопоставление, анализ текста.
7. Генерация и отображение пояснений к ошибкам.
8. Фиксация статистики: процент верных, время, использованные подсказки, попытки.
9. Античит: обнаружение слишком быстрых ответов, повторяющихся шаблонов ввода, автокликеров.
10. Отчёты для кураторов: прогресс групп, проблемные темы, рекомендации по повторению.
11. Управление базой знаний: версия правил, пересоздание эмбеддингов в Qdrant, модерация фрагментов, согласование публикаций.

#### 4.2.2 Требования временного регламента

| Процесс | Цель | Ограничение |
|---------|------|-------------|
| Генерация сессии | Подбор 5–20 заданий | ≤ 3 сек |
| Проверка ответа без подсказки | API Rust → PWA | ≤ 100 мс (p95) |
| Проверка ответа с подсказкой (кэш) | Redis кеш | ≤ 500 мс |
| Генерация новой подсказки | Python + Qdrant + YandexGPT | ≤ 3 сек (timeout 2 сек на Explanation API, 1 сек на YandexGPT) |
| Сохранение попытки | MongoDB запись | ≤ 500 мс |
| Отчёт для куратора | Агрегация 30 учеников | ≤ 10 сек (materialized_stats) |

#### 4.2.3 Требования одновременности Требования одновременности

- Система обслуживает не менее 5 000 одновременных сессий.
- Каждая сессия содержит до 20 активных таймеров и 2 подсказок.
- Генератор заданий обрабатывает не менее 200 запросов/минуту к YandexGPT с очередью повторных попыток.

#### 4.2.4 Критерии отказов

- Отсутствие ответа API > 5 сек — считается отказом сервиса.
- Ошибка генерации заданий без fallback-шаблона — критический инцидент.
- Потеря статистики попытки — блокирование уровня до ручной проверки.
- Ошибки подсчёта баллов > 0.5 % от сессий — запуск процедуры аудита.

#### 4.2.5 Требования безопасности и античита

- Защита API TLS 1.3, HSTS, проверка CSRF/Replay.
- Rate limiting per user/session, защита от ботов (hCaptcha + поведенческая аналитика).
- Контроль целостности PWA (подпись Service Worker, проверка версий).
- Логирование подозрительных действий, автоматическое временное ограничение.
- Шифрование персональных данных (PII) в хранилищах.
- Авторизация основана на JWT (claims `role`, `group_ids`). Rust API проверяет роли guard'ами; учитель может запрашивать только группы из `group_ids`, админ имеет расширенные права. Дополнительно поддерживается SSO (OAuth2/SAML) для школ.
- Античит-правила: если время ответа < 2 сек при сложности уровня > средней — счётчик `speed_hits`++; при повторении одинаковых ответов/паттернов — `repeated_hits`++; при `speed_hits` > 5 за час статус `suspicious`, при `speed_hits` > 10 или `repeated_hits` > 8 автоматическая блокировка на 24 часа (ключ `anticheat:{user_id}` в Redis). Все события пишутся в коллекцию `incidents`.

#### 4.2.6 Правила начисления баллов и подсказок

- **Rule S1:** За каждый правильный ответ начисляется +10 баллов. Реализуется Scoring Engine; значение пишется в `attempts.score`.
- **Rule S2:** За неправильный или просроченный ответ начисляется 0 баллов. Серия правильных ответов сбрасывается.
- **Rule S3:** Подсказка стоит −5 баллов и уменьшает доступные подсказки (`hints_used:{session_id}` в Redis). Покупка подсказки выполняется атомарным Lua-скриптом: проверка лимита, списание баллов, запись в MongoDB.
- **Rule S4 (Combo):** После серии ≥3 правильных ответов подряд каждый следующий правильный ответ приносит +5 бонусных баллов. Серия хранится в Redis (`score:series:{user_id}`) и синхронизируется в конце сессии.
- **Rule S5:** Переход на следующий уровень возможен при ≥80 % правильных ответов (учитываются штрафы за подсказки). Порог проверяется Scoring Engine перед завершением сессии.

Scoring Engine выполняет все операции в транзакции MongoDB + Redis, чтобы исключить несогласованность при параллельных запросах.

#### 4.2.7 Интерфейсы взаимодействия сервисов

| Интерфейс | Метод/Формат | SLA/Timeout | Fallback |
|-----------|--------------|-------------|----------|
| `POST /sessions/{id}/answers` | REST/JSON `{task_id, answer}` → `{status, score_delta, series}` | 1 сек | При недоступности API ответ сохраняется локально и повторяется при восстановлении. |
| `POST /sessions/{id}/hints` | REST/JSON `{task_id}` → `{hint_text, rule_ref, cost}` | 500 мс (кэш), 1.5 сек (новая) | Если Explanation API недоступен, возвращается шаблонное правило из MongoDB. |
| `Explanation API /v1/explanations` | REST (Rust → Python) `{topic_id, task_type, user_errors[]}` → `{explanation, source_refs}` | 2 сек timeout | Возвращает 503; Hint Service выдаёт статичное пояснение. |
| `Embedding Pipeline Event` | Redis Stream `content:changes` — payload `{template_id, action}` | Обработка ≤ 1 мин | При росте очереди >100 — алерт DevOps. |
| `Qdrant Search` | HTTP/gRPC `{vector, filter, top_k}` | 300 мс | Если Qdrant недоступен, используется MongoDB список правил. |

OpenAPI/JSON-schema для публичных REST эндпойнтов и Explanation API хранятся в `docs/api/*.yaml` (обязательны к обновлению при изменениях).

### 4.3 Требования к обеспечению

#### 4.3.1 Математическое обеспечение

- Алгоритм начисления баллов и бонусов соответствует правилам из паспорта проекта (≥80 % для перехода, бонус за серию ≥3).
- Модели адаптивной сложности: коэффициент уровня вычисляется на основе последних n попыток игрока.
- Формулы расчёта статистики (процент верных, время, рейтинг) должны быть документированы и доступны для проверки.
- Античит использует статистическое выявление аномалий (z-score по времени ответа, частоте подсказок).

#### 4.3.2 Информационное обеспечение

- Основные сущности: Тема, Уровень, Задание (шаблон + экземпляр), Подсказка, Попытка, Пользователь, Группа, Правило (см. глоссарий.md).
- Требуется поддержка версионности заданий и правил, а также журнал синхронизации эмбеддингов между MongoDB и Qdrant.
- Все данные хранятся в UTF-8, с едиными словарями терминов.
- Предусмотреть словарь исключений и справочник правил русского языка.
- База знаний разделяется на документный слой (тексты правил, шаблонов) и векторный слой (эмбеддинги, метаданные в Qdrant). Необходимо хранить связь между слоями для восстановления контекста.

**Требования к данным (Data Requirements):**
- **Хранение попыток:** минимум 5 лет для целей архива и статистики; автоматическое архивирование в холодное хранилище через 2 года.
- **Шифрование PII:** ФИ ученика, адрес email, номер школы должны быть зашифрованы в покое (MongoDB encryption, AEAD); ключи управляются через Vault.
- **Экспорт данных:** кураторы могут выгружать результаты в CSV/PDF; администратор может архивировать всю статистику школы в S3/YandexCloud Storage.
- **Удаление данных:** запрос ученика/родителя на удаление обрабатывается за ≤ 10 рабочных дней; удаляются PII, но сохраняется обезличенная статистика (класс, темы, проценты).
- **Синхронизация MongoDB ↔ Redis:** Session Manager писет в Redis с TTL ≤ 1 час; по завершении сессии данные переносятся в MongoDB (collections `attempts`, `progress_statistics`). При потере Redis-значения благодаря бэкапам в MongoDB целостность не нарушается.
- **Целостность при сбоях:** при краше API во время начисления баллов используется MongoDB транзакция с идемпотентным ключом (session_id + task_instance_id) для предотвращения двойного начисления.

#### 4.3.3 Лингвистическое обеспечение

- Контент соответствует нормам орфографии и пунктуации русского языка (актуальные правила РАН).
- Используются проверенные корпуса (Нацкорпус, открытые словари) при обучении или проверке.
- Пояснения формулируются простым языком, ориентированным на школьников 8–11 классов.
- Интерфейс поддерживает терминологию, согласованную с учителями.

#### 4.3.4 Программное обеспечение

- Фронтенд: чистый TypeScript, Web Components, PWA; сборка esbuild/Vite.
- Игровой API: Rust, `hyper`, `tokio`, без тяжёлых фреймворков; Docker-контейнеры.
- ИИ-сервис: Python 3.12, asyncio, стандартная библиотека; интеграция с YandexGPT через REST.
- Хранилища: MongoDB 6.x (основное документное и аналитическое хранилище), Redis 7.x (оперативный кэш, лимиты), Qdrant (векторный индекс).
- Тесты: unit/интеграционные (Rust `cargo test`, TypeScript `vitest`, Python `pytest`).
- CI/CD: GitHub Actions/YaCloud Deploy с линтингом, сборкой, развёртыванием.

#### 4.3.5 Техническое обеспечение

- Минимальные требования сервера API: 4 CPU, 8 GB RAM, SSD 200 GB.
- MongoDB Replica Set из минимум 3 узлов; Redis в режиме master + replica.
- CDN для статики PWA, поддержка HTTP/2/3.
- Резервное копирование БД ежедневно, хранение бэкапов ≥ 30 дней.

#### 4.3.6 Организационное обеспечение

- Регламент обновлений контента (шаблонов) не реже 1 раза в неделю.
- Процедура модерации новых заданий (двойное ревью: методист + лингвист).
- Обучение кураторов и учителей работе с отчётами.
- План реагирования на инциденты (SLA: критичные — 2 часа, высокие — 8 часов, средние — 24 часа).

**Соответствие нормативно-правовым требованиям:**
- **Федеральный закон ФЗ-152** (О защите персональных данных): персональные данные учащихся обрабатываются с согласия родителей; предусмотрен процесс запросов на доступ, исправление, удаление PII.
- **Федеральный закон ФЗ-436** (О защите детей от информации): система не содержит вредоносного контента и блокирует доступ неавторизованных лиц к детским данным.
- **Об образовании в РФ (ФЗ-273):** система должна соответствовать федеральным образовательным стандартам (ФГОС) при выборе тем и уровней; администратор может кастомизировать курс под региональные требования.
- **GDPR (для европейских пользователей, если применимо):** возможность настроить отдельный Data Controller; поддержка export/deletion по запросам Data Subject.
- **Политика конфиденциальности и Пользовательское соглашение:** должны быть опубликованы и согласованы до развёртывания (хранятся в `docs/PRIVACY.md`, `docs/TERMS.md`).
- **Auditing and Compliance:** все операции с данными логируются, доступны для внутренних аудитов и проверок инспекторов (экспорт в защищённом виде через Admin API с версионированием).
- **Data Retention Policy:** закрытые сессии хранятся 5 лет, затем архивируются; инциденты и логи античита — 2 года.

#### 4.3.7 Требования к качеству и эксплуатационной поддержке

- KPI UX: удовлетворённость ≥ 8/10; завершение уровня без ошибок > 90 % пользователей.
- SLA доступности сервисов: 99.5 % в учебное время (08:00–22:00 МСК).
- Наличие staging-среды для тестирования обновлений.
- Автоматические smoke-тесты после деплоя, ручные регрессы перед крупными релизами.

### 4.4 Общие технические требования

#### 4.4.1 Требования к персоналу

- Команда разработки: специалисты по TypeScript, Rust, Python, MongoDB, Redis, DevOps.
- Методисты/контент-менеджеры — эксперты по русскому языку и учебным программам 8–11 классов.
- Техническая поддержка обучается диагностике PWA, работе с логами и бэкапами.
- Кураторы школ проходят инструктаж по работе с отчётами и настройке групп.

#### 4.4.2 Показатели назначения

- Цель: рост процента правильных ответов у учащихся на ≥15 % после 3 недель использования.
- Система должна поддерживать линейные и кастомные курсы, переходы между темами и повторение «узких мест».
- Все функции остаются актуальными при изменениях учебных программ (обновления контента без изменения кода).

#### 4.4.3 Производительность

| Показатель | Значение |
|------------|----------|
| Время загрузки PWA (cold start) | ≤ 2 сек на 4G |
| P95 задержка API | ≤ 200 мс |
| Кол-во одновременно активных таймеров | ≥ 10000 |
| Импорт 100 заданий | ≤ 30 сек |
| Генерация отчёта класса (30 учеников) | ≤ 5 сек |

#### 4.4.4 Масштабируемость

- Симультанные пользователи: 10 000 учащихся + 500 кураторов.
- Объём банка заданий: до 50 000 шаблонов, 1 млн сгенерированных экземпляров.
- Хранение истории попыток: ≥ 5 лет.
- Возможность горизонтального масштабирования API и Python-сервиса без остановки работы.

#### 4.4.5 Надёжность

- Отказоустойчивость через репликацию БД и резервные узлы API.
- Автоматическое восстановление PWA после обновления Service Worker.
- Регулярное тестирование бэкапов (не реже 1 раза в месяц).

#### 4.4.6 Безопасность

- **RBAC:** роли «ученик», «куратор», «администратор». Кураторы видят только свои группы; администраторы имеют полный доступ. Разграничение реализуется через JWT claims `role` и `group_ids` с проверкой на каждый запрос (Rust API guards).
- **Аутентификация и авторизация:** 
  - Поддержка Email/Password (хэширование bcrypt с солью ≥12 раундов)
  - SSO интеграция (OAuth 2.0 / SAML 2.0 для школьных сервисов)
  - JWT токены с TTL ≤ 1 часа для API; refresh tokens в secure HTTP-only cookies
  - Двухфакторная аутентификация для администраторов (TOTP или SMS)
- **Шифрование данных:**
  - **В покое:** MongoDB Encryption (AEAD-ChaCha20-Poly1305 или AES-256-GCM), ключи в Vault
  - **В пути:** TLS 1.3 (обязательно для всех эндпойнтов), HSTS с max-age ≥ 31536000
  - **PWA Service Worker:** подпись всех ассетов (SRI Subresource Integrity), проверка целостности при загрузке
- **Защита от атак:**
  - **CSRF:** CSRF token в session, проверка Origin/Referer для изменяющих операций
  - **SQL Injection / NoSQL Injection:** параметризованные запросы, ORM (sqlc, diesel) для Rust
  - **XSS:** контент-то-безопасный (CSP: default-src 'self', script-src 'self', style-src 'self' 'unsafe-inline' для Web Components)
  - **Rate Limiting:** per-user (ограничение 100 запросов/минуту для обычных, 10 запросов/минуту для создания сессий), per-IP (1000 запросов/минуту)
  - **Bot Detection:** hCaptcha при подозрении (3+ неверных ответа за 1 минуту или скорость < 2 сек), поведенческая аналитика (z-score по времени ответа)
- **Логирование и Мониторинг:**
  - Все попытки аутентификации логируются (success/failure с IP, timestamp)
  - Подозрительные события (failed auth > 5 за 5 мин) переводят аккаунт в режим ограничения (rate limit 1 запрос/сек)
  - Все операции администраторов логируются (кто, что, когда) для аудита
  - Экспорт логов в SIEM (ELK Stack) для анализа инцидентов
- **Минимизация персональных данных:** хранить только необходимые (id, класс, школа, email); избегать хранения паролей в логах и никогда в текстовом виде.
- **Соответствие стандартам:** ФЗ-152 (РФ), GDPR (ЕС), OWASP Top 10 (защита от наиболее частых уязвимостей).

#### 4.4.7 Удобство использования

- PWA поддерживает клавиатурное управление, масштабирующийся текст, озвучивание пояснений (опционально).
- Интерфейс адаптирован под планшеты/ноутбуки, уровень доступности не ниже WCAG 2.1 AA.
- Responsive-ступени (ориентиры для @media):
  - **XL (≥ 1200 px)** — расширенный десктоп: три колонки (меню тем, рабочая область, аналитика).
  - **LG (1025–1199 px)** — десктоп/большие ноутбуки: рабочая область + боковая панель, фиксированная высота ≥720 px.
  - **MD (769–1024 px)** — планшеты/малые ноутбуки: двухколоночный layout (задание + подсказки).
  - **SM (641–768 px)** — переходный режим: одна колонка, отдельные панели подсказок по tabs.
  - **XS (481–640 px)** — мобильные устройства в горизонтальном режиме.
  - **XXS (≤ 480 px)** — мобильные устройства в вертикальном режиме: вертикальный поток, крупные кнопки, скрытые доппанели.
  - **VH (≤ 600 px высота)** — ограничение по высоте: скрывать второстепенные блоки, уменьшать паддинги.
- На всех ступенях должны сохраняться единая иерархия информации, доступ с клавиатуры (Tab/Enter/Space) и управление жестами/мышью.
- Onboarding пользователя (первый запуск) ≤ 5 минут.
- Встроенные подсказки и учебные материалы доступны из любого задания.

---

Документ подлежит актуализации при изменении предметной области, технологического стека или регуляторных требований. Все изменения согласуются с заказчиком и фиксируются в системе контроля версий.

