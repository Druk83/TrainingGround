
# Стек проекта «Русский язык: тренировочный полигон»

Документ фиксирует финальный набор технологий, инструментов и подходов, на которых строится MVP и дальнейшее развитие системы. Основа — минималистичный стек без тяжёлых фреймворков, с упором на контроль над кодовой базой и интеграцию с Qdrant для векторного поиска.

## 1. Клиентский слой
- **Тип приложения:** PWA с офлайн-кешем базовых заданий и сервис-воркером.
- **Язык:** TypeScript (ES2020+), строгая типизация для компонентов и моделей данных.
- **UI:** Нативные Web Components, шаблоны реализуются вручную или через лёгкие утилиты (Lit directives без фреймворка).
- **Сборка:** esbuild или Vite как быстрый транспайлер/бандлер, без SSR.
- **Стили:** CSS Modules / Utility-first (PostCSS + custom variables), адаптивная верстка под планшеты/ноутбуки.
- **PWA-инфраструктура:** Service Worker, Web Manifest, Cache Storage. Для офлайн-режима кешируются статические ресурсы и небольшой пул заданий.
- **Тесты:** `vitest` + `@web/test-runner` для unit и snapshot тестов компонентов.
- **Инструменты разработки:** ESLint, Prettier, Stylelint, Husky (pre-commit hooks).

## 2. Серверный слой
### 2.1 Игровой API
- **Язык:** Rust (стандарт 2021).
- **Библиотеки:** `hyper`/`axum` для HTTP, `tokio` для асинхронности, `serde` для сериализации.
- **Функции:** управление сессиями, таймерами, начислением баллов, статистикой, античитом, выдача заданий и подсказок.
- **Форматы:** REST/JSON + SSE/WebSocket для обновлений таймера, gRPC (опционально) для внутренних вызовов.
- **Тестирование:** `cargo test`, property-based тесты через `proptest`, нагрузочные бенчмарки (`criterion`).
- **Деплой:** Docker-образ (alpine-based) + systemd или контейнерная оркестрация.

### 2.2 Сервис генерации и ИИ
- **Язык:** Python 3.14.
- **Фреймворк:** стандартная библиотека с `asyncio` и `aiohttp`/`http.server` для REST.
- **Задачи:** интеграция с YandexGPT, генерация заданий и пояснений, морфологическая проверка, управление банком шаблонов.
- **Обработка естественного языка:** `pymorphy2`, `natasha`, собственные регулярные проверки.
- **Векторизация:** библиотека `sentence-transformers`/`fasttext` (по потребности), запись эмбеддингов в Qdrant.
- **Тестирование:** `pytest`, `mypy` (строгая типизация), интеграция с mock-API YandexGPT.
- **Планирование:** `apscheduler` или собственные cron-задачи для обновления контента и эмбеддингов.

## 3. Хранилища и данные
- **MongoDB 6.x** — основное хранилище данных (темы, шаблоны, экземпляры заданий, попытки, отчёты, версии правил). Используются Replica Set и коллекции с TTL для временных данных.
- **Redis 7.x** — оперативный кэш (сессии, лимиты подсказок, счётчики античита, временные токены). Структуры: `HASH`, `ZSET`, `STREAMS`.
- **Qdrant** — отдельный сервис для векторного поиска (эмбеддинги правил, примеров, шаблонов). Используется REST/gRPC API, коллекции с HNSW индексами и фильтрами по метаданным.
- **Файловое хранилище/объектное** (S3-совместимое) — резервные копии MongoDB и Qdrant snapshot'ов, загрузка обучающих корпусов.
- **Схемы данных:** JSON Schema/Protocol Buffers для обмена между сервисами, `serde` и `pydantic` для валидации.

## 4. Инфраструктура и DevOps
- **Контейнеризация:** Docker для всех сервисов; общий docker-compose/staging кластер для локальной разработки.
- **CI/CD:** GitHub Actions (lint → тесты → сборка → публикация образов), автоматические smoke-тесты перед деплоем.
- **Мониторинг:** Prometheus + Grafana; метрики времени отклика, ошибок, задержек генерации и использования подсказок.
- **Логирование:** Loki/ELK stack; корреляция событий между PWA, Rust API и Python-сервисом.
- **Алёрты:** Alertmanager/Upptime для SLA; уведомления в мессенджеры (Telegram/Slack).
- **Secrets:** HashiCorp Vault или встроенные секреты GitHub Actions/YaCloud Secret Manager.
- **Бэкапы:** `mongodump`/`mongorestore`, `redis-cli --rdb`, `qdrant snapshot`; расписание минимум раз в сутки, хранение 30 дней.

## 5. Качество и процессы
- **Статический анализ:** Rust Clippy, `tsc --noEmit`, `pylint`.
- **Кодстайл:** единые правила форматирования (rustfmt, ESLint + Prettier, Black).
- **Документация:** Markdown + Mermaid диаграммы, OpenAPI/AsyncAPI спек для REST/SSE.
- **Управление задачами:** Kanban (GitHub Projects), шаблоны issue/PR.
- **Безопасность:** TLS 1.3, JWT/Macaroon для аутентификации, RBAC (ученик/куратор/админ), проверки OWASP (ZAP).

## 6. Зависимости от внешних сервисов
- **YandexGPT API** — генерация контента и пояснений (используется через Python-сервис).
- **SMTP/Messaging** — отправка отчётов и напоминаний (Yandex 360, SMTP школы, Telegram Bot API).
- **SSO школ (при необходимости)** — OAuth 2.0/SAML.
- **Облачные сервисы** — размещение инфраструктуры (Yandex Cloud/Selectel), CDN для PWA.

Документ следует обновлять при изменении решений по стеку, появлении новых сервисов или замене инфраструктуры.
