# Описание бизнес-сценариев (Business Layer, ArchiMate 3.2)

Документ описывает ключевые бизнесовые сценарии проекта «Русский язык: тренировочный полигон». Каждый сценарий связывает бизнес-актеров, роли, сервисы, процессы и объекты, а также указывает KPI/SLA. Сущности соответствуют документу «Сущности архитектуры».

---

## Сценарий AL-1. Прохождение урока учеником

**Участники / Роли:**
- Ученик
- Сервис «Прохождение урока»
- Сервис «Выдача подсказок»
- Business Process «Генерация пакета заданий» + «Прохождение уровня» + «Расчёт прогресса»

**Триггер:** Ученик авторизуется и выбирает тему для тренировки.

**Ход процесса:**
1. Актор «Ученик» инициирует процесс «Выбор курса и уровня».
2. Сервис «Прохождение урока» вызывает процесс «Генерация пакета заданий», формируя бизнес-объект `Экземпляр задания`.
3. Ученик последовательно выполняет задания; процесс «Прохождение уровня» контролирует адаптивный таймер (45 сек для выбора, 90 сек для текстового ввода, 180 сек для анализа) и переходы.
4. По запросу запускается сервис «Выдача подсказок» (максимум 2 подсказки на уровень):
   - Сервис вычитает 5 баллов ДО предоставления подсказки (бизнес-объект `Подсказка`).
   - При попытке 3-й подсказки система возвращает ошибку (лимит исчерпан).
5. При истечении таймера: ученик получает 0 баллов за это задание, но серия бонусов не разрывается (серия продолжает считаться).
6. При правильном ответе:
   - Базовый балл: +10 баллов
   - Бонус за серию: если это 4-й или последующий верный ответ подряд, дополнительно +5 баллов (итого +15)
   - Серия сохраняется в бизнес-объекте `Состояние сессии` (Redis или MongoDB)
7. При неправильном ответе: 0 баллов, серия сбрасывается на 0.
8. По завершении уровня (все задания выполнены или достигнута цель) рассчитывается бизнес-объект `Статистика прогресса`, где фиксируются:
   - Итоговые баллы (сумма по всем заданиям)
   - Процент верных ответов (count_correct / count_total × 100)
   - Достижение цели ≥80% верных ответов (на каждый уровень)
   - Максимальная серия в этом прохождении
9. Если ≥80% верных, ученик может перейти на следующий уровень; результат сохраняется и отображается ученику.

**Бизнес-объекты:** `Тема`, `Уровень`, `Экземпляр задания`, `Подсказка`, `Попытка прохождения`, `Статистика прогресса`.

**KPI/SLA:**
- Среднее время решения одного задания (при адаптивном таймере): ≤ 90 сек в среднем (без учёта пауз).
- Процент ошибок при расчёте баллов: ≤ 0.1 % (проверяется в unit-тестах Scoring Engine, BL-1 шаг 4).
- Синхронизация состояния сессии между мобильным/десктопным клиентом ≤ 500 мс (TL-2, Redis TTL).
- Снижение количества ошибок между попытками (рост навыка) ≥ 10%.
- Ложные срабатывания античита (неправильная блокировка честных учеников) ≤ 1%.

**Реализация в других слоях:**
- AL-1 шаг 4 (Выдача подсказок): реализуется в BL-2 и TL-2 (Redis счётчик `hints_used:{session_id}`)
- AL-1 шаг 6 (Расчёт баллов и серии): реализуется в BL-1 шаг 4 (Scoring Engine, Rust)
- AL-1 шаг 3 (Адаптивный таймер): реализуется в TL-2 (Redis TTL с типом задания)

**Ценность:** Поддержка систематического обучения и мотивации ученика через геймификацию и персонификацию.

---

## Сценарий AL-2. Аналитика и отчётность для куратора

**Участники / Роли:**
- Куратор / Учитель
- Сервис «Аналитика и отчётность»
- Business Process «Генерация отчётов»

**Триггер:** Куратор открывает статистику класса или запрашивает отчёт по конкретным темам.

**Ход процесса:**
1. Куратор запускает процесс «Генерация отчётов».
2. Сервис «Аналитика и отчётность» агрегирует бизнес-объекты `Статистика прогресса`, `Попытка прохождения`, `Журнал античита`.
3. Формируется бизнес-объект `Отчёт`, который включает KPI (успешность, время, использование подсказок, проблемные темы).
4. Куратор просматривает отчёт в Dashboard или выгружает файл для совещаний/родителей.
5. При необходимости куратора уведомляют о падении метрик или злоупотреблении подсказками (инцидент-флаг).

**Бизнес-объекты:** `Статистика прогресса`, `Попытка прохождения`, `Журнал античита`, `Отчёт`.

**KPI/SLA:**
- Формирование отчёта ≤ 10 сек (для классов до 30 человек).
- Точность данных ≥ 99.9% (сверка с источником MongoDB и Redis).
- Уведомления о проблемных группах (падение среднего % верных ≥ 10%) не позднее 1 часа после события.
- Максимальная задержка синхронизации данных в хранилище аналитики ≤ 5 минут (TL-3).

**Реализация в других слоях:**
- AL-2 шаг 2 (Агрегация данных): реализуется в TL-3 (Python аналитический конвейер, запросы к MongoDB)
- AL-2 шаг 3 (Генерация отчёта): реализуется в BL-3 (Analytics Engine, JSON API)

**Ценность:** Куратор получает актуальную картину успеваемости и может вовремя вмешаться в обучение.

---

## Сценарий AL-3. Модерация и публикация контента

**Участники / Роли:**
- Администратор контента
- Сервис «Модерация контента»
- Business Process «Модерация шаблонов и пересоздание эмбеддингов»

**Триггер:** Требуется добавить новую тему или обновить существующее правило.

**Ход процесса:**
1. Администратор создаёт или редактирует бизнес-объект `Шаблон задания` и `Правило`.
2. Сервис «Модерация контента» проверяет корректность (покрытие правил, отсутствие конфликтов) и запускает процесс «Пересоздание эмбеддингов».
3. После публикации новые версии шаблонов становятся доступны сервису «Прохождение урока».
4. Система фиксирует версионность бизнес-объекта и уведомляет заинтересованных лиц (кураторов/методистов).

**Бизнес-объекты:** `Шаблон задания`, `Правило`, `Тема`, `Версия правила`, `Список эмбеддингов`.

**KPI/SLA:**
- Время модерации одного шаблона ≤ 2 дня (при участии методиста).
- Обновление эмбеддингов и публикация новых заданий ≤ 15 минут после утверждения.
- Коэффициент одобрения шаблонов ≥ 90 % (минимум правок после ревью).

**Ценность:** Поддержание актуальности базы знаний и быстрое ввод новых тем.

---

## Сценарий AL-4. Античит и инцидент-менеджмент

**Участники / Роли:**
- Техподдержка / DevOps
- Сервис «Инцидент-менеджмент и античит»
- Business Process «Управление инцидентами»

**Триггер:** Обнаружены подозрительные действия (слишком быстрые ответы, автоматический ввод) или падение SLA.

**Ход процесса:**
1. Сервис античита генерирует бизнес-объект `Инцидент`, прикрепляя данные `Журнала античита`.
2. Техподдержка получает уведомление (Severity Medium/High) и анализирует причину.
3. При подтверждении нарушения — блокировка учётной записи или конкретной сессии (бизнес-объект `Профиль пользователя` обновляется).
4. При техническом инциденте — применение runbook (увеличить ресурсы, перезапустить сервис) и документирование в `Журнал действий`.
5. После решения инцидент закрывается, отправляется отчёт куратору, если был затронут ученик/группа.

**Бизнес-объекты:** `Инцидент`, `Журнал античита`, `Журнал действий`, `Профиль пользователя`.

**KPI/SLA:**
- Реакция на критический инцидент (время получения уведомления DevOps) ≤ 2 минуты (TL-2, Redis event stream).
- Высокий инцидент (падение доступности сервиса) — ≤ 5 минут до алерта.
- Ложные срабатывания античита ≤ 1% (калибруется в BL-5, Speed Detector).
- Время блокировки аккаунта при подтверждении нарушения ≤ 30 сек.
- Количество повторных инцидентов по одной причине за месяц ≤ 5%.

**Реализация в других слоях:**
- AL-4 шаг 1 (Генерация Инцидента): реализуется в BL-5 (Speed Detector, Pattern Analyzer)
- AL-4 шаг 2 (Уведомление): реализуется в TL-2 (Redis Pub/Sub канал `incidents`)
- AL-4 шаг 3 (Блокировка): реализуется в Rust API (запрос к MongoDB, обновление `Профиль пользователя.is_blocked`)

**Ценность:** Защита академической честности и стабильности сервиса.

---

## Сценарий AL-5. Интеграция со школьной системой (опционально)

**Участники / Роли:**
- Системный администратор школы
- Сервис «Интеграция со школьными системами»
- Business Process «Настройка SSO и обмена данными»

**Триггер:** Школа хочет подключить тренажёр к своему SSO и расписанию.

**Ход процесса:**
1. Администратор школы предоставляет параметры SSO (OAuth2/SAML) и список групп учеников.
2. Сервис интеграции выполняет настройку SSO, синхронизирует бизнес-объекты `Профиль пользователя` и `Группа`.
3. Процесс обеспечивает обмен данными (план уроков, домашние задания) по расписанию.
4. Ученики входят через школьный портал, а прогресс синхронизируется с дневником.

**Бизнес-объекты:** `Профиль пользователя`, `Группа`, `Расписание уроков`, `Прогресс по темам`.

**KPI/SLA:**
- Время настройки новой школы ≤ 5 рабочих дней.
- Успешность входа через SSO ≥ 99 %.
- Синхронизация прогресса с дневником не позднее следующего учебного дня.

**Ценность:** Упрощённый доступ для школ и централизованный контроль успеваемости.

---

Эти сценарии отражают бизнес-потребности и служат базой для привязки прикладного и технологического слоёв (описаны в `описание BL.md` и `описание TL.md`). В диаграммах ArchiMate каждый сценарий отображается как Business Process, реализующий бизнес-сервисы и потребляющий бизнес-объекты.
